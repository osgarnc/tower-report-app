<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0066cc">
    <title>Tower Report Mobile - Secure</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            position: relative;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            width: 150px;
            margin-bottom: 30px;
        }

        .login-title {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-form {
            text-align: left;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .login-btn {
            background-color: #0066cc;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background-color: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }

        .login-error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 14px;
        }

        .login-info {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: left;
        }

        .user-info {
            background-color: #e3f2fd;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .user-info strong {
            color: #1565c0;
        }

        .logout-btn {
            background-color: #f44336;
            color: white;
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Header */
        .header {
            background-color: #0066cc;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .step.active {
            background-color: #0066cc;
            color: white;
        }

        .step.completed {
            background-color: #4caf50;
            color: white;
        }

        /* Form Sections */
        .form-section {
            display: none;
            padding: 20px;
            animation: slideIn 0.3s ease-out;
        }

        .form-section.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0066cc;
        }

        .required {
            color: #f44336;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background-color: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0052a3;
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .btn-secondary {
            background-color: #757575;
            color: white;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        /* GPS Status */
        .gps-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }

        .gps-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .gps-status.error {
            background-color: #ffebee;
            color: #c62828;
        }

        /* Appurtenance List */
        .appurtenance-list {
            margin-top: 20px;
        }

        .appurtenance-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appurtenance-info h4 {
            margin: 0 0 5px 0;
            color: #0066cc;
        }

        .appurtenance-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        /* Photo Section */
        .photo-requirements {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .photo-requirements h3 {
            margin-bottom: 10px;
            color: #1565c0;
        }

        .photo-requirements ul {
            margin-left: 20px;
        }

        .photo-grid {
            display: grid;
            gap: 15px;
        }

        .photo-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .photo-item h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .photo-capture {
            position: relative;
            margin-bottom: 10px;
        }

        .camera-input {
            display: none;
        }

        .camera-btn {
            background-color: #0066cc;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn:hover {
            background-color: #0052a3;
        }

        .photo-preview {
            margin-top: 10px;
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-count {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .photo-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .photo-status.complete {
            background-color: #4caf50;
            color: white;
        }

        .photo-status.pending {
            background-color: #ff9800;
            color: white;
        }

        /* Review Section */
        .review-section {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .review-section h3 {
            margin-bottom: 10px;
            color: #0066cc;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-weight: 500;
            color: #666;
        }

        .review-value {
            color: #333;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .notification.success {
            background-color: #4caf50;
        }

        .notification.error {
            background-color: #f44336;
        }

        .notification.info {
            background-color: #2196f3;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 20px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h2 class="login-title">Tower Provider Report</h2>
            <p class="login-subtitle">Sistema Seguro de Reportes</p>
            
            <div class="login-info">
                <strong>üìã Informaci√≥n importante:</strong><br>
                Use sus credenciales de SharePoint para acceder al sistema. Su nombre ser√° registrado autom√°ticamente en todos los reportes que env√≠e.
            </div>

            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="userEmail">Email de SharePoint <span class="required">*</span></label>
                    <input type="email" id="userEmail" placeholder="usuario@newcomm2000.com" required>
                </div>
                
                <div class="form-group">
                    <label for="userName">Nombre Completo <span class="required">*</span></label>
                    <input type="text" id="userName" placeholder="Nombre Apellido" required>
                </div>
                
                <div class="form-group">
                    <label for="userPassword">Contrase√±a <span class="required">*</span></label>
                    <input type="password" id="userPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" class="login-btn">
                    üîê Iniciar Sesi√≥n
                </button>
            </form>
            
            <div id="loginError" style="display: none;" class="login-error"></div>
        </div>
    </div>

    <!-- Main App (Hidden until authenticated) -->
    <div id="mainApp" class="app-container" style="display: none;">
        <div class="user-info">
            <span>Usuario: <strong id="userDisplayName">-</strong></span>
            <button class="logout-btn" onclick="signOut()">Cerrar Sesi√≥n</button>
        </div>

        <header class="header">
            <h1>Tower Provider Report</h1>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Versi√≥n 2.4 - Secure</div>
        </header>

        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
            <div class="step" id="step5">5</div>
        </div>

        <!-- Step 1: Basic Information -->
        <div class="form-section active" id="section1">
            <h2>Informaci√≥n B√°sica</h2>
            
            <!-- Storage management -->
            <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Espacio usado: <span id="storageIndicator">calculando...</span></span>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 5px 10px;">
                        Limpiar datos
                    </button>
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">App v2.4 Secure</div>
            </div>
            
            <div class="form-group">
                <label>Tower Provider Site ID <span class="required">*</span></label>
                <input type="text" id="siteId" placeholder="ej: 10028307" required>
            </div>

            <div class="form-group">
                <label>Tower Provider Site Name <span class="required">*</span></label>
                <input type="text" id="siteName" placeholder="ej: Vega Baja DT" required>
            </div>

            <div class="form-group">
                <label>Customer Site ID <span class="required">*</span></label>
                <input type="text" id="customerSiteId" placeholder="ej: 10028307" required>
            </div>

            <div class="form-group">
                <label>Customer Site Name <span class="required">*</span></label>
                <input type="text" id="customerSiteName" placeholder="ej: Vega Baja DT" required>
            </div>

            <div class="form-group">
                <label>Radios Installed <span class="required">*</span></label>
                <input type="number" id="radiosInstalled" min="0" placeholder="3" required>
            </div>

            <div class="form-group">
                <label>Antennas Installed <span class="required">*</span></label>
                <input type="number" id="antennasInstalled" min="0" placeholder="6" required>
            </div>

            <div class="form-group">
                <label>Team Leader <span class="required">*</span></label>
                <input type="text" id="teamLeader" placeholder="ej: Christopher Rodriguez" required>
            </div>

            <div class="form-group">
                <label>Tower Top Installation <span class="required">*</span></label>
                <select id="towerTop" required>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

            <div class="form-group">
                <label>Completion Date <span class="required">*</span></label>
                <input type="date" id="completionDate" required>
            </div>

            <div class="form-group">
                <label>TP Tenant <span class="required">*</span></label>
                <input type="text" id="tpTenant" placeholder="ej: Liberty" required>
            </div>

            <div class="form-group">
                <button class="btn btn-success btn-block" onclick="getGPSLocation()">
                    üìç Obtener Ubicaci√≥n GPS
                </button>
                <div id="gpsStatus"></div>
            </div>

            <!-- Nueva secci√≥n de mediciones -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-top: 20px;">
                <h3 style="color: #1565c0; margin-bottom: 15px;">üìè Mediciones de Torre (Opcional)</h3>
                
                <div class="form-group">
                    <label>Tower Height (ft)</label>
                    <input type="text" id="towerHeight" placeholder="ej: 38.220">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Sector 1 Tape Drop</label>
                        <input type="text" id="sector1TapeDrop" placeholder="ej: 15.5 ft">
                    </div>
                    <div class="form-group">
                        <label>Sector 2 Tape Drop</label>
                        <input type="text" id="sector2TapeDrop" placeholder="ej: 16.2 ft">
                    </div>
                    <div class="form-group">
                        <label>Sector 3 Tape Drop</label>
                        <input type="text" id="sector3TapeDrop" placeholder="ej: 14.8 ft">
                    </div>
                </div>

                <div class="form-group">
                    <label>Tallest Point Measurement (ft)</label>
                    <input type="text" id="tallestPoint" placeholder="ej: 15.570">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Appurtenance Information -->
        <div class="form-section" id="section2">
            <h2>Informaci√≥n de Equipos</h2>
            
            <button class="btn btn-primary btn-block" onclick="showAppurtenanceForm()">
                + Agregar Equipo
            </button>

            <div id="appurtenanceForm" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label>Type</label>
                    <select id="appType">
                        <option value="Antenna">Antenna</option>
                        <option value="RRU">RRU</option>
                        <option value="Cable">Cable</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Rad Center</label>
                    <input type="text" id="appRadCenter" placeholder="50">
                </div>

                <div class="form-group">
                    <label>Manufacturer</label>
                    <input type="text" id="appManufacturer" placeholder="ej: Ericsson">
                </div>

                <div class="form-group">
                    <label>Model</label>
                    <input type="text" id="appModel" placeholder="ej: 840590003">
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="appQuantity" min="1" value="1">
                </div>

                <div class="form-group">
                    <label>Coax Size (if applicable)</label>
                    <input type="text" id="appCoaxSize" placeholder="Optional">
                </div>

                <button class="btn btn-success" onclick="addAppurtenance()">Guardar</button>
                <button class="btn btn-secondary" onclick="cancelAppurtenance()">Cancelar</button>
            </div>

            <div class="appurtenance-list" id="appurtenanceList"></div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Photo Documentation -->
        <div class="form-section" id="section3">
            <h2>Documentaci√≥n Fotogr√°fica</h2>
            
            <div class="photo-requirements">
                <h3>üì∏ Fotos Requeridas</h3>
                <ul>
                    <li>Tome al menos 5 fotos en total para continuar</li>
                    <li>Puede tomar m√∫ltiples fotos por categor√≠a</li>
                    <li>Las fotos se guardan autom√°ticamente</li>
                </ul>
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>Modo Demo:</strong> 
                    <button class="btn btn-secondary" onclick="skipPhotoValidation()" style="margin-left: 10px;">
                        Saltar validaci√≥n de fotos
                    </button>
                </div>
            </div>

            <div class="photo-grid" id="photoGrid">
                <!-- Photo items will be generated by JavaScript -->
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div class="form-section" id="section4">
            <h2>Revisar Informaci√≥n</h2>
            
            <div class="review-section">
                <h3>Informaci√≥n del Sitio</h3>
                <div id="siteReview"></div>
            </div>

            <div class="review-section">
                <h3>Equipos Instalados</h3>
                <div id="equipmentReview"></div>
            </div>

            <div class="review-section">
                <h3>Documentaci√≥n Fotogr√°fica</h3>
                <div id="photoReview"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 5: Submit -->
        <div class="form-section" id="section5">
            <h2>Enviar Reporte</h2>
            
            <div style="text-align: center; padding: 40px 20px;">
                <h3>¬øEst√° listo para enviar el reporte?</h3>
                <p style="margin: 20px 0; color: #666;">
                    Al enviar, se generar√° un PDF y se enviar√° autom√°ticamente a accounting@newcomm2000.com
                </p>
                
                <button class="btn btn-primary btn-block" onclick="showReportSummary()" style="margin-bottom: 10px; font-size: 16px;">
                    üìÑ Ver Resumen del Reporte
                </button>
                
                <button class="btn btn-success btn-block" onclick="submitReport()" style="font-size: 18px; padding: 15px;">
                    ‚úì Enviar Reporte
                </button>
                
                <div id="submitStatus" style="margin-top: 20px;"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
            </div>
        </div>
    </div>

    <script>
        // Simple authentication system using localStorage
        // In production, this should be replaced with proper SharePoint authentication
        
        // Valid users list (in production, this would come from SharePoint)
        const validUsers = [
            { email: 'admin@newcomm2000.com', name: 'Administrator', password: 'admin123' },
            { email: 'christopher.rodriguez@newcomm2000.com', name: 'Christopher Rodriguez', password: 'chris123' },
            { email: 'field.tech@newcomm2000.com', name: 'Field Technician', password: 'field123' }
        ];

        // Global variables
        let currentStep = 1;
        let currentUser = null;
        let reportData = {
            basic: {},
            gps: {},
            appurtenances: [],
            photos: {},
            measurements: {},
            metadata: {
                appVersion: '2.4',
                deviceInfo: navigator.userAgent,
                createdAt: new Date().toISOString()
            }
        };

        // Photo types configuration
        const photoTypes = [
            { id: 'equipment_room', name: 'Post Equipment Room or Pad', required: 4, description: 'Equipment room/pad photos' },
            { id: 'cabinet_doors', name: 'Cabinet or Shelter Doors', required: 2, description: 'Open and closed door photos' },
            { id: 'safety_lines', name: 'Safety Lines', required: 4, description: 'All safety line assemblies' },
            { id: 'antenna_labels', name: 'Antenna Labels', required: 6, description: 'Labels for all antennas' },
            { id: 'radio_labels', name: 'Radio Labels', required: 3, description: 'Labels for all radios' },
            { id: 'compound_post', name: 'Compound Post Pictures', required: 4, description: 'Compound area photos' },
            { id: 'sectors_ground', name: 'Sectors from Ground', required: 3, description: 'Sectors 1, 2, and 3' },
            { id: 'sector_posts', name: 'Sector Post Pictures', required: 3, description: 'Detailed sector photos' },
            { id: 'tape_measurements', name: 'Tape Drop Measurements', required: 6, description: 'All measurement photos' },
            { id: 'tower_measurements', name: 'Tower Height Measurements', required: 2, description: 'Tower and tallest point' },
            { id: 'beacon', name: 'Beacon Photos', required: 2, description: 'Beacon and label' }
        ];

        // Authentication Functions
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('userEmail').value.toLowerCase();
            const name = document.getElementById('userName').value;
            const password = document.getElementById('userPassword').value;
            
            // Validate against valid users (in production, this would be a SharePoint API call)
            const validUser = validUsers.find(u => u.email === email && u.password === password);
            
            if (validUser) {
                // Use the name provided by the user (allowing them to use their actual name)
                currentUser = {
                    email: email,
                    name: name || validUser.name,
                    authenticated: true,
                    loginTime: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem('towerReportUser', JSON.stringify(currentUser));
                
                showMainApp();
            } else {
                showLoginError('Credenciales inv√°lidas. Verifique su email y contrase√±a.');
            }
        }

        function checkAuthentication() {
            const savedUser = localStorage.getItem('towerReportUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                // Check if session is still valid (24 hours)
                const loginTime = new Date(currentUser.loginTime);
                const now = new Date();
                const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    showMainApp();
                } else {
                    // Session expired
                    signOut();
                    showLoginError('Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                }
            }
        }

        function signOut() {
            currentUser = null;
            localStorage.removeItem('towerReportUser');
            showLoginScreen();
            
            // Reset form
            document.getElementById('userEmail').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userPassword').value = '';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userDisplayName').textContent = currentUser.name;
            
            // Initialize app
            document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
            generatePhotoGrid();
            loadSavedData();
            updateStorageIndicator();
            optimizeStorage();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Initialize app when page loads
        window.onload = function() {
            checkAuthentication();
        };

        // Storage management functions
        function checkStorageSpace() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }
                return (totalSize / 1024 / 1024).toFixed(2);
            } catch (e) {
                return 'Unknown';
            }
        }

        function updateStorageIndicator() {
            const indicator = document.getElementById('storageIndicator');
            if (indicator) {
                const usedMB = checkStorageSpace();
                const usedNum = parseFloat(usedMB);
                
                indicator.textContent = `${usedMB} MB`;
                
                if (usedNum > 4.5) {
                    indicator.style.color = 'red';
                    indicator.textContent += ' (CR√çTICO)';
                } else if (usedNum > 3) {
                    indicator.style.color = 'orange';
                    indicator.textContent += ' (alto)';
                } else {
                    indicator.style.color = 'green';
                }
            }
        }

        function optimizeStorage() {
            const currentSize = parseFloat(checkStorageSpace());
            
            if (currentSize > 4) {
                showNotification('Optimizando almacenamiento...', 'info');
                clearOldReports();
                
                if (parseFloat(checkStorageSpace()) > 3) {
                    Object.keys(reportData.photos).forEach(photoType => {
                        const photos = reportData.photos[photoType];
                        if (photos && photos.length > 2) {
                            reportData.photos[photoType] = photos.slice(-2);
                        }
                    });
                    updatePhotoCounts();
                }
                
                updateStorageIndicator();
                showNotification('Almacenamiento optimizado', 'success');
            }
        }

        function clearOldReports() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('RPT-') && key !== 'towerReportUser') {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
        }

        function clearAllData() {
            if (confirm('¬øEliminar todos los datos guardados? Esto borrar√° reportes anteriores pero mantendr√° su sesi√≥n activa.')) {
                // Clear only report data, not authentication data
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key !== 'towerReportUser') {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                reportData = {
                    basic: {},
                    gps: {},
                    appurtenances: [],
                    photos: {}
                };
                showNotification('Datos eliminados correctamente', 'success');
                updateStorageIndicator();
                location.reload();
            }
        }

        // Navigation functions
        function nextStep() {
            if (validateCurrentStep()) {
                saveCurrentStep();
                if (currentStep < 5) {
                    currentStep++;
                    showStep(currentStep);
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('section' + step).classList.add('active');
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            if (step === 4) {
                updateReview();
            }
            
            window.scrollTo(0, 0);
        }

        // Validation functions
        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    const requiredFields = ['siteId', 'siteName', 'customerSiteId', 'customerSiteName', 
                                          'radiosInstalled', 'antennasInstalled', 'teamLeader', 
                                          'completionDate', 'tpTenant'];
                    for (let field of requiredFields) {
                        if (!document.getElementById(field).value) {
                            showNotification('Por favor complete todos los campos requeridos', 'error');
                            document.getElementById(field).focus();
                            return false;
                        }
                    }
                    if (!reportData.gps.latitude) {
                        const confirmNoGPS = confirm('No has capturado la ubicaci√≥n GPS. ¬øDeseas continuar sin GPS o ingresarla manualmente?');
                        if (!confirmNoGPS) {
                            showManualGPS();
                            return false;
                        }
                    }
                    return true;
                    
                case 2:
                    if (reportData.appurtenances.length === 0) {
                        showNotification('Por favor agregue al menos un equipo', 'error');
                        return false;
                    }
                    return true;
                    
                case 3:
                    let totalPhotos = 0;
                    Object.values(reportData.photos).forEach(photoArray => {
                        if (Array.isArray(photoArray)) {
                            totalPhotos += photoArray.length;
                        }
                    });
                    
                    if (totalPhotos < 5) {
                        showNotification('Por favor tome al menos 5 fotos para continuar', 'error');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }

        function saveCurrentStep() {
            try {
                switch(currentStep) {
                    case 1:
                        const timestamp = Date.now();
                        const randomNum = Math.floor(Math.random() * 1000);
                        const autoSiteId = document.getElementById('siteId').value || `AUTO-${timestamp}-${randomNum}`;
                        
                        reportData.basic = {
                            siteId: autoSiteId,
                            siteName: document.getElementById('siteName').value,
                            customerSiteId: document.getElementById('customerSiteId').value,
                            customerSiteName: document.getElementById('customerSiteName').value,
                            radiosInstalled: document.getElementById('radiosInstalled').value,
                            antennasInstalled: document.getElementById('antennasInstalled').value,
                            teamLeader: document.getElementById('teamLeader').value,
                            towerTop: document.getElementById('towerTop').value,
                            completionDate: document.getElementById('completionDate').value,
                            tpTenant: document.getElementById('tpTenant').value,
                            submittedBy: currentUser ? currentUser.name : 'Unknown User',
                            submittedByEmail: currentUser ? currentUser.email : 'unknown@email.com',
                            submissionTimestamp: new Date().toISOString(),
                            uniqueReportId: `RPT-${timestamp}-${randomNum}`
                        };
                        
                        // Guardar mediciones si existen
                        reportData.measurements = {
                            towerHeight: document.getElementById('towerHeight').value || '',
                            sector1TapeDrop: document.getElementById('sector1TapeDrop').value || '',
                            sector2TapeDrop: document.getElementById('sector2TapeDrop').value || '',
                            sector3TapeDrop: document.getElementById('sector3TapeDrop').value || '',
                            tallestPoint: document.getElementById('tallestPoint').value || ''
                        };
                        break;
                }
                
                try {
                    localStorage.setItem('towerReport', JSON.stringify(reportData));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        clearOldReports();
                        try {
                            localStorage.setItem('towerReport', JSON.stringify(reportData));
                        } catch (e2) {
                            showNotification('Almacenamiento lleno. Algunas fotos no se guardaron.', 'error');
                            const minimalData = {
                                basic: reportData.basic,
                                gps: reportData.gps,
                                appurtenances: reportData.appurtenances,
                                photos: {}
                            };
                            localStorage.setItem('towerReport', JSON.stringify(minimalData));
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Error al guardar. Continuando sin guardar.', 'error');
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem('towerReport');
            if (saved) {
                reportData = JSON.parse(saved);
                if (reportData.basic) {
                    Object.keys(reportData.basic).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && key !== 'submittedBy' && key !== 'submittedByEmail') {
                            element.value = reportData.basic[key];
                        }
                    });
                }
                if (reportData.gps.latitude) {
                    showGPSStatus(true);
                }
                updateAppurtenanceList();
                updatePhotoCounts();
            }
        }

        // GPS Functions
        function getGPSLocation() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = '<div class="spinner"></div><p>Obteniendo ubicaci√≥n...</p>';
            
            if (!navigator.geolocation) {
                showGPSStatus(false, 'Geolocalizaci√≥n no soportada en este navegador');
                showManualGPSOption();
                return;
            }

            const options = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 600000
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    reportData.gps = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        altitude: position.coords.altitude || 0,
                        accuracy: position.coords.accuracy
                    };
                    showGPSStatus(true);
                    saveCurrentStep();
                },
                (error) => {
                    console.error('GPS Error:', error);
                    let errorMessage = 'Error desconocido';
                    
                    switch(error.code) {
                        case 1:
                            errorMessage = 'Permisos de ubicaci√≥n denegados. Ve a Configuraci√≥n > Safari > Ubicaci√≥n y act√≠vala.';
                            break;
                        case 2:
                            errorMessage = 'Ubicaci√≥n no disponible. Intenta en un √°rea con mejor se√±al.';
                            break;
                        case 3:
                            errorMessage = 'Tiempo agotado obteniendo ubicaci√≥n. Puedes intentar de nuevo o ingresar manualmente.';
                            break;
                        default:
                            errorMessage = `Error de ubicaci√≥n: ${error.message || 'Desconocido'}`;
                    }
                    
                    showGPSStatus(false, errorMessage);
                    showManualGPSOption();
                },
                options
            );
        }

        function showManualGPSOption() {
            const statusDiv = document.getElementById('gpsStatus');
            const existingButton = statusDiv.querySelector('button');
            if (!existingButton) {
                statusDiv.innerHTML += `
                    <div style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="showManualGPS()" style="font-size: 14px;">
                            üìç Ingresar ubicaci√≥n manualmente
                        </button>
                        <button class="btn btn-primary" onclick="getGPSLocation()" style="font-size: 14px; margin-left: 10px;">
                            üîÑ Reintentar GPS
                        </button>
                    </div>
                `;
            }
        }

        function showManualGPS() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                    <h4>Ubicaci√≥n Manual</h4>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Ingresa las coordenadas del sitio. Puedes obtenerlas de Google Maps.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                        <div>
                            <label style="font-size: 12px;">Latitud</label>
                            <input type="number" id="manualLat" placeholder="ej: 18.4671" step="any" style="padding: 8px; width: 100%;">
                        </div>
                        <div>
                            <label style="font-size: 12px;">Longitud</label>
                            <input type="number" id="manualLng" placeholder="ej: -66.1185" step="any" style="padding: 8px; width: 100%;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveManualGPS()" style="font-size: 14px;">
                            ‚úì Guardar Ubicaci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="getGPSLocation()" style="font-size: 14px;">
                            üîÑ Reintentar GPS
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;">
                        <strong>Tip:</strong> En Google Maps, mant√©n presionado un punto y copia las coordenadas.
                    </p>
                </div>
            `;
            
            setTimeout(() => {
                const latInput = document.getElementById('manualLat');
                if (latInput) latInput.focus();
            }, 100);
        }

        function saveManualGPS() {
            const lat = document.getElementById('manualLat').value;
            const lng = document.getElementById('manualLng').value;
            
            if (!lat || !lng) {
                showNotification('Por favor ingresa latitud y longitud', 'error');
                return;
            }
            
            if (Math.abs(lat) > 90 || Math.abs(lng) > 180) {
                showNotification('Coordenadas inv√°lidas. Verifica los valores.', 'error');
                return;
            }
            
            reportData.gps = {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                altitude: 0,
                accuracy: 0,
                manual: true
            };
            
            showGPSStatus(true);
            saveCurrentStep();
            showNotification('Ubicaci√≥n manual guardada correctamente', 'success');
        }

        function showGPSStatus(success, message = '') {
            const statusDiv = document.getElementById('gpsStatus');
            if (success) {
                const isManual = reportData.gps.manual ? ' (Manual)' : '';
                statusDiv.innerHTML = `
                    <div class="gps-status success">
                        ‚úì GPS Capturado${isManual}: ${reportData.gps.latitude.toFixed(7)}, ${reportData.gps.longitude.toFixed(7)}
                        ${!reportData.gps.manual ? `<br>Precisi√≥n: ¬±${reportData.gps.accuracy.toFixed(1)}m` : ''}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="gps-status error">
                        ‚úó Error: ${message}
                    </div>
                `;
            }
        }

        // Appurtenance Functions
        function showAppurtenanceForm() {
            document.getElementById('appurtenanceForm').style.display = 'block';
        }

        function cancelAppurtenance() {
            document.getElementById('appurtenanceForm').style.display = 'none';
            ['appType', 'appRadCenter', 'appManufacturer', 'appModel', 'appQuantity', 'appCoaxSize'].forEach(id => {
                document.getElementById(id).value = id === 'appQuantity' ? '1' : '';
            });
        }

        function addAppurtenance() {
            const appurtenance = {
                type: document.getElementById('appType').value,
                radCenter: document.getElementById('appRadCenter').value,
                manufacturer: document.getElementById('appManufacturer').value,
                model: document.getElementById('appModel').value,
                quantity: document.getElementById('appQuantity').value,
                coaxSize: document.getElementById('appCoaxSize').value
            };
            
            reportData.appurtenances.push(appurtenance);
            updateAppurtenanceList();
            cancelAppurtenance();
            saveCurrentStep();
        }

        function updateAppurtenanceList() {
            const listDiv = document.getElementById('appurtenanceList');
            listDiv.innerHTML = '';
            
            reportData.appurtenances.forEach((app, index) => {
                const item = document.createElement('div');
                item.className = 'appurtenance-item';
                item.innerHTML = `
                    <div class="appurtenance-info">
                        <h4>${app.type} - ${app.manufacturer}</h4>
                        <p>Model: ${app.model} | Qty: ${app.quantity} | Rad: ${app.radCenter}</p>
                    </div>
                    <button class="btn btn-danger" onclick="removeAppurtenance(${index})">√ó</button>
                `;
                listDiv.appendChild(item);
            });
        }

        function removeAppurtenance(index) {
            reportData.appurtenances.splice(index, 1);
            updateAppurtenanceList();
            saveCurrentStep();
        }

        // Photo Functions
        function generatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            photoTypes.forEach(type => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <h4>${type.name}</h4>
                    <div class="photo-capture">
                        <input type="file" 
                               accept="image/*" 
                               capture="environment" 
                               multiple
                               class="camera-input" 
                               id="photo_${type.id}"
                               onchange="handlePhotoCapture('${type.id}', this)">
                        <label for="photo_${type.id}" class="camera-btn">
                            üì∑ Tomar Foto (${type.required} requeridas)
                        </label>
                    </div>
                    <div id="preview_${type.id}"></div>
                    <div class="photo-count">
                        <span id="count_${type.id}">0</span> de ${type.required} fotos
                    </div>
                    <div class="photo-status ${(reportData.photos[type.id] || []).length >= type.required ? 'complete' : 'pending'}" 
                         id="status_${type.id}">
                        ${(reportData.photos[type.id] || []).length >= type.required ? '‚úì Completo' : '‚è± Pendiente'}
                    </div>
                `;
                grid.appendChild(photoItem);
            });
            
            updatePhotoCounts();
        }

        function handlePhotoCapture(typeId, input) {
            const files = Array.from(input.files);
            if (!reportData.photos[typeId]) {
                reportData.photos[typeId] = [];
            }
            
            files.forEach(file => {
                const currentSize = checkStorageSpace();
                if (parseFloat(currentSize) > 4.5) {
                    showNotification('Almacenamiento casi lleno. Limpiando fotos antiguas...', 'info');
                    clearOldReports();
                }
                
                compressImage(file, 400, 0.5, (compressedDataUrl) => {
                    try {
                        reportData.photos[typeId].push({
                            data: compressedDataUrl,
                            timestamp: new Date().toISOString(),
                            name: file.name
                        });
                        updatePhotoPreview(typeId);
                        updatePhotoCounts();
                        saveCurrentStep();
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            showNotification('Almacenamiento lleno. Use "Limpiar datos" primero.', 'error');
                        }
                    }
                });
            });
        }

        function compressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxSize = 400;
                    if (width > height) {
                        if (width > maxSize) {
                            height = (maxSize / width) * height;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (maxSize / height) * width;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5);
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updatePhotoPreview(typeId) {
            const previewDiv = document.getElementById(`preview_${typeId}`);
            const photos = reportData.photos[typeId] || [];
            
            previewDiv.innerHTML = photos.map((photo, index) => `
                <img src="${photo.data}" class="photo-preview" alt="Photo ${index + 1}" style="width: 100px; height: 100px; object-fit: cover; margin: 5px;">
            `).join('');
        }

        function updatePhotoCounts() {
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                const countSpan = document.getElementById(`count_${type.id}`);
                const statusDiv = document.getElementById(`status_${type.id}`);
                
                if (countSpan) {
                    countSpan.textContent = photos.length;
                }
                
                if (statusDiv) {
                    if (photos.length >= type.required) {
                        statusDiv.className = 'photo-status complete';
                        statusDiv.textContent = '‚úì Completo';
                    } else {
                        statusDiv.className = 'photo-status pending';
                        statusDiv.textContent = '‚è± Pendiente';
                    }
                }
            });
        }

        function skipPhotoValidation() {
            photoTypes.forEach(type => {
                if (!reportData.photos[type.id]) {
                    reportData.photos[type.id] = [];
                }
                reportData.photos[type.id].push({
                    data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    timestamp: new Date().toISOString(),
                    name: 'demo_photo.png'
                });
            });
            
            updatePhotoCounts();
            saveCurrentStep();
            showNotification('Fotos de demostraci√≥n agregadas. Ahora puede continuar.', 'success');
        }

        // Review Functions
        function updateReview() {
            const siteReview = document.getElementById('siteReview');
            siteReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Site ID:</span>
                    <span class="review-value">${reportData.basic.siteId || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Site Name:</span>
                    <span class="review-value">${reportData.basic.siteName || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Team Leader:</span>
                    <span class="review-value">${reportData.basic.teamLeader || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Submitted By:</span>
                    <span class="review-value">${reportData.basic.submittedBy || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">GPS Location:</span>
                    <span class="review-value">${reportData.gps.latitude ? `${reportData.gps.latitude.toFixed(6)}, ${reportData.gps.longitude.toFixed(6)}` : 'N/A'}</span>
                </div>
            `;
            
            const equipmentReview = document.getElementById('equipmentReview');
            equipmentReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Radios:</span>
                    <span class="review-value">${reportData.basic.radiosInstalled || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Antennas:</span>
                    <span class="review-value">${reportData.basic.antennasInstalled || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Equipment Items:</span>
                    <span class="review-value">${reportData.appurtenances.length} tipos</span>
                </div>
            `;
            
            const photoReview = document.getElementById('photoReview');
            let totalPhotos = 0;
            let completedTypes = 0;
            
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                totalPhotos += photos.length;
                if (photos.length >= type.required) {
                    completedTypes++;
                }
            });
            
            photoReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Total de fotos:</span>
                    <span class="review-value">${totalPhotos}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Categor√≠as completas:</span>
                    <span class="review-value">${completedTypes} de ${photoTypes.length}</span>
