<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0066cc">
    <title>Tower Report Mobile</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            position: relative;
        }

        /* Watermark styling */
        .form-section {
            position: relative;
        }

        .form-section::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 100px;
            background-image: url('data:image/png;base64,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');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.08;
            z-index: 0;
            pointer-events: none;
        }

        /* Header */
        .header {
            background-color: #0066cc;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .step.active {
            background-color: #0066cc;
            color: white;
        }

        .step.completed {
            background-color: #4caf50;
            color: white;
        }

        /* Form Sections */
        .form-section {
            display: none;
            padding: 20px;
            animation: slideIn 0.3s ease-out;
        }

        .form-section.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            background-color: rgba(255, 255, 255, 0.9);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0066cc;
        }

        .required {
            color: #f44336;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background-color: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0052a3;
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .btn-secondary {
            background-color: #757575;
            color: white;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            position: relative;
            z-index: 1;
        }

        /* GPS Status */
        .gps-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            position: relative;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .gps-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .gps-status.error {
            background-color: #ffebee;
            color: #c62828;
        }

        /* Appurtenance List */
        .appurtenance-list {
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .appurtenance-item {
            background-color: rgba(245, 245, 245, 0.9);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appurtenance-info h4 {
            margin: 0 0 5px 0;
            color: #0066cc;
        }

        .appurtenance-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        /* Photo Section */
        .photo-requirements {
            background-color: rgba(227, 242, 253, 0.9);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .photo-requirements h3 {
            margin-bottom: 10px;
            color: #1565c0;
        }

        .photo-requirements ul {
            margin-left: 20px;
        }

        .photo-grid {
            display: grid;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .photo-item {
            background-color: rgba(245, 245, 245, 0.9);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .photo-item h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .photo-capture {
            position: relative;
            margin-bottom: 10px;
        }

        .camera-input {
            display: none;
        }

        .camera-btn {
            background-color: #0066cc;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn:hover {
            background-color: #0052a3;
        }

        .photo-preview {
            margin-top: 10px;
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-count {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .photo-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .photo-status.complete {
            background-color: #4caf50;
            color: white;
        }

        .photo-status.pending {
            background-color: #ff9800;
            color: white;
        }

        /* Review Section */
        .review-section {
            background-color: rgba(245, 245, 245, 0.9);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .review-section h3 {
            margin-bottom: 10px;
            color: #0066cc;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-weight: 500;
            color: #666;
        }

        .review-value {
            color: #333;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .notification.success {
            background-color: #4caf50;
        }

        .notification.error {
            background-color: #f44336;
        }

        .notification.info {
            background-color: #2196f3;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 20px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Tower Provider Report</h1>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Versi√≥n 2.2</div>
        </header>

        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
            <div class="step" id="step5">5</div>
        </div>

        <!-- Step 1: Basic Information -->
        <div class="form-section active" id="section1">
            <h2>Informaci√≥n B√°sica</h2>
            
            <!-- Storage management -->
            <div style="background: rgba(245, 245, 245, 0.9); padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px; position: relative; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Espacio usado: <span id="storageIndicator">calculando...</span></span>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 5px 10px;">
                        Limpiar datos
                    </button>
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">App v2.2</div>
            </div>
            
            <div class="form-group">
                <label>Tower Provider Site ID <span class="required">*</span></label>
                <input type="text" id="siteId" placeholder="ej: 10028307" required>
            </div>

            <div class="form-group">
                <label>Tower Provider Site Name <span class="required">*</span></label>
                <input type="text" id="siteName" placeholder="ej: Vega Baja DT" required>
            </div>

            <div class="form-group">
                <label>Customer Site ID <span class="required">*</span></label>
                <input type="text" id="customerSiteId" placeholder="ej: 10028307" required>
            </div>

            <div class="form-group">
                <label>Customer Site Name <span class="required">*</span></label>
                <input type="text" id="customerSiteName" placeholder="ej: Vega Baja DT" required>
            </div>

            <div class="form-group">
                <label>Radios Installed <span class="required">*</span></label>
                <input type="number" id="radiosInstalled" min="0" placeholder="3" required>
            </div>

            <div class="form-group">
                <label>Antennas Installed <span class="required">*</span></label>
                <input type="number" id="antennasInstalled" min="0" placeholder="6" required>
            </div>

            <div class="form-group">
                <label>Team Leader <span class="required">*</span></label>
                <input type="text" id="teamLeader" placeholder="ej: Christopher Rodriguez" required>
            </div>

            <div class="form-group">
                <label>Tower Top Installation <span class="required">*</span></label>
                <select id="towerTop" required>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

            <div class="form-group">
                <label>Completion Date <span class="required">*</span></label>
                <input type="date" id="completionDate" required>
            </div>

            <div class="form-group">
                <label>TP Tenant <span class="required">*</span></label>
                <input type="text" id="tpTenant" placeholder="ej: Liberty" required>
            </div>

            <div class="form-group">
                <button class="btn btn-success btn-block" onclick="getGPSLocation()">
                    üìç Obtener Ubicaci√≥n GPS
                </button>
                <div id="gpsStatus"></div>
            </div>

            <!-- Nueva secci√≥n de mediciones -->
            <div style="background: rgba(227, 242, 253, 0.9); padding: 15px; border-radius: 6px; margin-top: 20px; position: relative; z-index: 1;">
                <h3 style="color: #1565c0; margin-bottom: 15px;">üìè Mediciones de Torre (Opcional)</h3>
                
                <div class="form-group">
                    <label>Tower Height (ft)</label>
                    <input type="text" id="towerHeight" placeholder="ej: 38.220">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Sector 1 Tape Drop</label>
                        <input type="text" id="sector1TapeDrop" placeholder="ej: 15.5 ft">
                    </div>
                    <div class="form-group">
                        <label>Sector 2 Tape Drop</label>
                        <input type="text" id="sector2TapeDrop" placeholder="ej: 16.2 ft">
                    </div>
                    <div class="form-group">
                        <label>Sector 3 Tape Drop</label>
                        <input type="text" id="sector3TapeDrop" placeholder="ej: 14.8 ft">
                    </div>
                </div>

                <div class="form-group">
                    <label>Tallest Point Measurement (ft)</label>
                    <input type="text" id="tallestPoint" placeholder="ej: 15.570">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Appurtenance Information -->
        <div class="form-section" id="section2">
            <h2>Informaci√≥n de Equipos</h2>
            
            <button class="btn btn-primary btn-block" onclick="showAppurtenanceForm()">
                + Agregar Equipo
            </button>

            <div id="appurtenanceForm" style="display: none; margin-top: 20px; position: relative; z-index: 1;">
                <div class="form-group">
                    <label>Type</label>
                    <select id="appType">
                        <option value="Antenna">Antenna</option>
                        <option value="RRU">RRU</option>
                        <option value="Cable">Cable</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Rad Center</label>
                    <input type="text" id="appRadCenter" placeholder="50">
                </div>

                <div class="form-group">
                    <label>Manufacturer</label>
                    <input type="text" id="appManufacturer" placeholder="ej: Ericsson">
                </div>

                <div class="form-group">
                    <label>Model</label>
                    <input type="text" id="appModel" placeholder="ej: 840590003">
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="appQuantity" min="1" value="1">
                </div>

                <div class="form-group">
                    <label>Coax Size (if applicable)</label>
                    <input type="text" id="appCoaxSize" placeholder="Optional">
                </div>

                <button class="btn btn-success" onclick="addAppurtenance()">Guardar</button>
                <button class="btn btn-secondary" onclick="cancelAppurtenance()">Cancelar</button>
            </div>

            <div class="appurtenance-list" id="appurtenanceList"></div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Photo Documentation -->
        <div class="form-section" id="section3">
            <h2>Documentaci√≥n Fotogr√°fica</h2>
            
            <div class="photo-requirements">
                <h3>üì∏ Fotos Requeridas</h3>
                <ul>
                    <li>Tome al menos 5 fotos en total para continuar</li>
                    <li>Puede tomar m√∫ltiples fotos por categor√≠a</li>
                    <li>Las fotos se guardan autom√°ticamente</li>
                </ul>
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>Modo Demo:</strong> 
                    <button class="btn btn-secondary" onclick="skipPhotoValidation()" style="margin-left: 10px;">
                        Saltar validaci√≥n de fotos
                    </button>
                </div>
            </div>

            <div class="photo-grid" id="photoGrid">
                <!-- Photo items will be generated by JavaScript -->
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div class="form-section" id="section4">
            <h2>Revisar Informaci√≥n</h2>
            
            <div class="review-section">
                <h3>Informaci√≥n del Sitio</h3>
                <div id="siteReview"></div>
            </div>

            <div class="review-section">
                <h3>Equipos Instalados</h3>
                <div id="equipmentReview"></div>
            </div>

            <div class="review-section">
                <h3>Documentaci√≥n Fotogr√°fica</h3>
                <div id="photoReview"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 5: Submit -->
        <div class="form-section" id="section5">
            <h2>Enviar Reporte</h2>
            
            <div style="text-align: center; padding: 40px 20px; position: relative; z-index: 1;">
                <h3>¬øEst√° listo para enviar el reporte?</h3>
                <p style="margin: 20px 0; color: #666;">
                    Al enviar, se generar√° un PDF y se enviar√° autom√°ticamente a accounting@newcomm2000.com
                </p>
                
                <button class="btn btn-primary btn-block" onclick="showReportSummary()" style="margin-bottom: 10px; font-size: 16px;">
                    üìÑ Ver Resumen del Reporte
                </button>
                
                <button class="btn btn-success btn-block" onclick="submitReport()" style="font-size: 18px; padding: 15px;">
                    ‚úì Enviar Reporte
                </button>
                
                <div id="submitStatus" style="margin-top: 20px;"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let reportData = {
            basic: {},
            gps: {},
            appurtenances: [],
            photos: {},
            measurements: {}, // Nuevo objeto para mediciones
            metadata: { // Nuevo objeto para metadata
                appVersion: '2.2',
                deviceInfo: navigator.userAgent,
                createdAt: new Date().toISOString()
            }
        };

        // Photo types configuration - Updated with exact names from knowledge base
        const photoTypes = [
            { id: 'equipment_room', name: 'Post Equipment Room or Pad', required: 4, description: 'Equipment room/pad photos' },
            { id: 'cabinet_doors', name: 'Cabinet or Shelter Doors', required: 2, description: 'Open and closed door photos' },
            { id: 'safety_lines', name: 'Safety Lines', required: 4, description: 'All safety line assemblies' },
            { id: 'antenna_labels', name: 'Antenna Labels', required: 6, description: 'Labels for all antennas' },
            { id: 'radio_labels', name: 'Radio Labels', required: 3, description: 'Labels for all radios' },
            { id: 'compound_post', name: 'Compound Post Pictures', required: 4, description: 'Compound area photos' },
            { id: 'sectors_ground', name: 'Sectors from Ground', required: 3, description: 'Sectors 1, 2, and 3' },
            { id: 'sector_posts', name: 'Sector Post Pictures', required: 3, description: 'Detailed sector photos' },
            { id: 'tape_measurements', name: 'Tape Drop Measurements', required: 6, description: 'All measurement photos' },
            { id: 'tower_measurements', name: 'Tower Height Measurements', required: 2, description: 'Tower and tallest point' },
            { id: 'beacon', name: 'Beacon Photos', required: 2, description: 'Beacon and label' }
        ];

        // Initialize app
        window.onload = function() {
            document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
            generatePhotoGrid();
            loadSavedData();
            updateStorageIndicator();
            optimizeStorage();
        };

        // Storage management functions
        function checkStorageSpace() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }
                return (totalSize / 1024 / 1024).toFixed(2);
            } catch (e) {
                return 'Unknown';
            }
        }

        function updateStorageIndicator() {
            const indicator = document.getElementById('storageIndicator');
            if (indicator) {
                const usedMB = checkStorageSpace();
                const usedNum = parseFloat(usedMB);
                
                indicator.textContent = `${usedMB} MB`;
                
                if (usedNum > 4.5) {
                    indicator.style.color = 'red';
                    indicator.textContent += ' (CR√çTICO)';
                } else if (usedNum > 3) {
                    indicator.style.color = 'orange';
                    indicator.textContent += ' (alto)';
                } else {
                    indicator.style.color = 'green';
                }
            }
        }

        function optimizeStorage() {
            const currentSize = parseFloat(checkStorageSpace());
            
            if (currentSize > 4) {
                showNotification('Optimizando almacenamiento...', 'info');
                clearOldReports();
                
                if (parseFloat(checkStorageSpace()) > 3) {
                    Object.keys(reportData.photos).forEach(photoType => {
                        const photos = reportData.photos[photoType];
                        if (photos && photos.length > 2) {
                            reportData.photos[photoType] = photos.slice(-2);
                        }
                    });
                    updatePhotoCounts();
                }
                
                updateStorageIndicator();
                showNotification('Almacenamiento optimizado', 'success');
            }
        }

        function clearOldReports() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('RPT-')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
        }

        function clearAllData() {
            if (confirm('¬øEliminar todos los datos guardados? Esto borrar√° reportes anteriores.')) {
                localStorage.clear();
                reportData = {
                    basic: {},
                    gps: {},
                    appurtenances: [],
                    photos: {}
                };
                showNotification('Datos eliminados correctamente', 'success');
                updateStorageIndicator();
                location.reload();
            }
        }

        // Navigation functions
        function nextStep() {
            if (validateCurrentStep()) {
                saveCurrentStep();
                if (currentStep < 5) {
                    currentStep++;
                    showStep(currentStep);
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('section' + step).classList.add('active');
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            if (step === 4) {
                updateReview();
            }
            
            window.scrollTo(0, 0);
        }

        // Validation functions
        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    const requiredFields = ['siteId', 'siteName', 'customerSiteId', 'customerSiteName', 
                                          'radiosInstalled', 'antennasInstalled', 'teamLeader', 
                                          'completionDate', 'tpTenant'];
                    for (let field of requiredFields) {
                        if (!document.getElementById(field).value) {
                            showNotification('Por favor complete todos los campos requeridos', 'error');
                            document.getElementById(field).focus();
                            return false;
                        }
                    }
                    // GPS ya no es obligatorio en la validaci√≥n
                    if (!reportData.gps.latitude) {
                        const confirmNoGPS = confirm('No has capturado la ubicaci√≥n GPS. ¬øDeseas continuar sin GPS o ingresarla manualmente?');
                        if (!confirmNoGPS) {
                            showManualGPS();
                            return false;
                        }
                    }
                    return true;
                    
                case 2:
                    if (reportData.appurtenances.length === 0) {
                        showNotification('Por favor agregue al menos un equipo', 'error');
                        return false;
                    }
                    return true;
                    
                case 3:
                    let totalPhotos = 0;
                    Object.values(reportData.photos).forEach(photoArray => {
                        if (Array.isArray(photoArray)) {
                            totalPhotos += photoArray.length;
                        }
                    });
                    
                    if (totalPhotos < 5) {
                        showNotification('Por favor tome al menos 5 fotos para continuar', 'error');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }

        function saveCurrentStep() {
            try {
                switch(currentStep) {
                    case 1:
                        const timestamp = Date.now();
                        const randomNum = Math.floor(Math.random() * 1000);
                        const autoSiteId = document.getElementById('siteId').value || `AUTO-${timestamp}-${randomNum}`;
                        
                        reportData.basic = {
                            siteId: autoSiteId,
                            siteName: document.getElementById('siteName').value,
                            customerSiteId: document.getElementById('customerSiteId').value,
                            customerSiteName: document.getElementById('customerSiteName').value,
                            radiosInstalled: document.getElementById('radiosInstalled').value,
                            antennasInstalled: document.getElementById('antennasInstalled').value,
                            teamLeader: document.getElementById('teamLeader').value,
                            towerTop: document.getElementById('towerTop').value,
                            completionDate: document.getElementById('completionDate').value,
                            tpTenant: document.getElementById('tpTenant').value,
                            submittedBy: 'Field Technician',
                            submissionTimestamp: new Date().toISOString(),
                            uniqueReportId: `RPT-${timestamp}-${randomNum}`
                        };
                        
                        // Guardar mediciones si existen
                        reportData.measurements = {
                            towerHeight: document.getElementById('towerHeight').value || '',
                            sector1TapeDrop: document.getElementById('sector1TapeDrop').value || '',
                            sector2TapeDrop: document.getElementById('sector2TapeDrop').value || '',
                            sector3TapeDrop: document.getElementById('sector3TapeDrop').value || '',
                            tallestPoint: document.getElementById('tallestPoint').value || ''
                        };
                        break;
                }
                
                try {
                    localStorage.setItem('towerReport', JSON.stringify(reportData));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        clearOldReports();
                        try {
                            localStorage.setItem('towerReport', JSON.stringify(reportData));
                        } catch (e2) {
                            showNotification('Almacenamiento lleno. Algunas fotos no se guardaron.', 'error');
                            const minimalData = {
                                basic: reportData.basic,
                                gps: reportData.gps,
                                appurtenances: reportData.appurtenances,
                                photos: {}
                            };
                            localStorage.setItem('towerReport', JSON.stringify(minimalData));
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Error al guardar. Continuando sin guardar.', 'error');
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem('towerReport');
            if (saved) {
                reportData = JSON.parse(saved);
                if (reportData.basic) {
                    Object.keys(reportData.basic).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = reportData.basic[key];
                        }
                    });
                }
                if (reportData.gps.latitude) {
                    showGPSStatus(true);
                }
                updateAppurtenanceList();
                updatePhotoCounts();
            }
        }

        // GPS Functions
        function getGPSLocation() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = '<div class="spinner"></div><p>Obteniendo ubicaci√≥n...</p>';
            
            if (!navigator.geolocation) {
                showGPSStatus(false, 'Geolocalizaci√≥n no soportada en este navegador');
                showManualGPSOption();
                return;
            }

            // Opciones optimizadas para mejor rendimiento
            const options = {
                enableHighAccuracy: false, // Desactivado para obtener ubicaci√≥n m√°s r√°pida
                timeout: 10000, // Reducido a 10 segundos
                maximumAge: 600000 // Acepta ubicaciones de hasta 10 minutos
            };
            
            // Intentar obtener ubicaci√≥n
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    reportData.gps = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        altitude: position.coords.altitude || 0,
                        accuracy: position.coords.accuracy
                    };
                    showGPSStatus(true);
                    saveCurrentStep();
                },
                (error) => {
                    console.error('GPS Error:', error);
                    let errorMessage = 'Error desconocido';
                    
                    switch(error.code) {
                        case 1: // PERMISSION_DENIED
                            errorMessage = 'Permisos de ubicaci√≥n denegados. Ve a Configuraci√≥n > Safari > Ubicaci√≥n y act√≠vala.';
                            break;
                        case 2: // POSITION_UNAVAILABLE
                            errorMessage = 'Ubicaci√≥n no disponible. Intenta en un √°rea con mejor se√±al.';
                            break;
                        case 3: // TIMEOUT
                            errorMessage = 'Tiempo agotado obteniendo ubicaci√≥n. Puedes intentar de nuevo o ingresar manualmente.';
                            break;
                        default:
                            errorMessage = `Error de ubicaci√≥n: ${error.message || 'Desconocido'}`;
                    }
                    
                    showGPSStatus(false, errorMessage);
                    showManualGPSOption();
                },
                options
            );
        }

        function showManualGPSOption() {
            const statusDiv = document.getElementById('gpsStatus');
            const existingButton = statusDiv.querySelector('button');
            if (!existingButton) {
                statusDiv.innerHTML += `
                    <div style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="showManualGPS()" style="font-size: 14px;">
                            üìç Ingresar ubicaci√≥n manualmente
                        </button>
                        <button class="btn btn-primary" onclick="getGPSLocation()" style="font-size: 14px; margin-left: 10px;">
                            üîÑ Reintentar GPS
                        </button>
                    </div>
                `;
            }
        }

        function showManualGPS() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                    <h4>Ubicaci√≥n Manual</h4>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Ingresa las coordenadas del sitio. Puedes obtenerlas de Google Maps.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                        <div>
                            <label style="font-size: 12px;">Latitud</label>
                            <input type="number" id="manualLat" placeholder="ej: 18.4671" step="any" style="padding: 8px; width: 100%;">
                        </div>
                        <div>
                            <label style="font-size: 12px;">Longitud</label>
                            <input type="number" id="manualLng" placeholder="ej: -66.1185" step="any" style="padding: 8px; width: 100%;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveManualGPS()" style="font-size: 14px;">
                            ‚úì Guardar Ubicaci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="getGPSLocation()" style="font-size: 14px;">
                            üîÑ Reintentar GPS
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;">
                        <strong>Tip:</strong> En Google Maps, mant√©n presionado un punto y copia las coordenadas.
                    </p>
                </div>
            `;
            
            // Auto-focus en el primer campo
            setTimeout(() => {
                const latInput = document.getElementById('manualLat');
                if (latInput) latInput.focus();
            }, 100);
        }

        function saveManualGPS() {
            const lat = document.getElementById('manualLat').value;
            const lng = document.getElementById('manualLng').value;
            
            if (!lat || !lng) {
                showNotification('Por favor ingresa latitud y longitud', 'error');
                return;
            }
            
            if (Math.abs(lat) > 90 || Math.abs(lng) > 180) {
                showNotification('Coordenadas inv√°lidas. Verifica los valores.', 'error');
                return;
            }
            
            reportData.gps = {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                altitude: 0,
                accuracy: 0,
                manual: true
            };
            
            showGPSStatus(true);
            saveCurrentStep();
            showNotification('Ubicaci√≥n manual guardada correctamente', 'success');
        }

        function showGPSStatus(success, message = '') {
            const statusDiv = document.getElementById('gpsStatus');
            if (success) {
                const isManual = reportData.gps.manual ? ' (Manual)' : '';
                statusDiv.innerHTML = `
                    <div class="gps-status success">
                        ‚úì GPS Capturado${isManual}: ${reportData.gps.latitude.toFixed(7)}, ${reportData.gps.longitude.toFixed(7)}
                        ${!reportData.gps.manual ? `<br>Precisi√≥n: ¬±${reportData.gps.accuracy.toFixed(1)}m` : ''}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="gps-status error">
                        ‚úó Error: ${message}
                    </div>
                `;
            }
        }

        // Appurtenance Functions
        function showAppurtenanceForm() {
            document.getElementById('appurtenanceForm').style.display = 'block';
        }

        function cancelAppurtenance() {
            document.getElementById('appurtenanceForm').style.display = 'none';
            ['appType', 'appRadCenter', 'appManufacturer', 'appModel', 'appQuantity', 'appCoaxSize'].forEach(id => {
                document.getElementById(id).value = id === 'appQuantity' ? '1' : '';
            });
        }

        function addAppurtenance() {
            const appurtenance = {
                type: document.getElementById('appType').value,
                radCenter: document.getElementById('appRadCenter').value,
                manufacturer: document.getElementById('appManufacturer').value,
                model: document.getElementById('appModel').value,
                quantity: document.getElementById('appQuantity').value,
                coaxSize: document.getElementById('appCoaxSize').value
            };
            
            reportData.appurtenances.push(appurtenance);
            updateAppurtenanceList();
            cancelAppurtenance();
            saveCurrentStep();
        }

        function updateAppurtenanceList() {
            const listDiv = document.getElementById('appurtenanceList');
            listDiv.innerHTML = '';
            
            reportData.appurtenances.forEach((app, index) => {
                const item = document.createElement('div');
                item.className = 'appurtenance-item';
                item.innerHTML = `
                    <div class="appurtenance-info">
                        <h4>${app.type} - ${app.manufacturer}</h4>
                        <p>Model: ${app.model} | Qty: ${app.quantity} | Rad: ${app.radCenter}</p>
                    </div>
                    <button class="btn btn-danger" onclick="removeAppurtenance(${index})">√ó</button>
                `;
                listDiv.appendChild(item);
            });
        }

        function removeAppurtenance(index) {
            reportData.appurtenances.splice(index, 1);
            updateAppurtenanceList();
            saveCurrentStep();
        }

        // Photo Functions
        function generatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            photoTypes.forEach(type => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <h4>${type.name}</h4>
                    <div class="photo-capture">
                        <input type="file" 
                               accept="image/*" 
                               capture="environment" 
                               multiple
                               class="camera-input" 
                               id="photo_${type.id}"
                               onchange="handlePhotoCapture('${type.id}', this)">
                        <label for="photo_${type.id}" class="camera-btn">
                            üì∑ Tomar Foto (${type.required} requeridas)
                        </label>
                    </div>
                    <div id="preview_${type.id}"></div>
                    <div class="photo-count">
                        <span id="count_${type.id}">0</span> de ${type.required} fotos
                    </div>
                    <div class="photo-status ${(reportData.photos[type.id] || []).length >= type.required ? 'complete' : 'pending'}" 
                         id="status_${type.id}">
                        ${(reportData.photos[type.id] || []).length >= type.required ? '‚úì Completo' : '‚è≥ Pendiente'}
                    </div>
                `;
                grid.appendChild(photoItem);
            });
            
            updatePhotoCounts();
        }

        function handlePhotoCapture(typeId, input) {
            const files = Array.from(input.files);
            if (!reportData.photos[typeId]) {
                reportData.photos[typeId] = [];
            }
            
            files.forEach(file => {
                const currentSize = checkStorageSpace();
                if (parseFloat(currentSize) > 4.5) {
                    showNotification('Almacenamiento casi lleno. Limpiando fotos antiguas...', 'info');
                    clearOldReports();
                }
                
                compressImage(file, 400, 0.5, (compressedDataUrl) => {
                    try {
                        reportData.photos[typeId].push({
                            data: compressedDataUrl,
                            timestamp: new Date().toISOString(),
                            name: file.name
                        });
                        updatePhotoPreview(typeId);
                        updatePhotoCounts();
                        saveCurrentStep();
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            showNotification('Almacenamiento lleno. Use "Limpiar datos" primero.', 'error');
                        }
                    }
                });
            });
        }

        function compressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxSize = 400;
                    if (width > height) {
                        if (width > maxSize) {
                            height = (maxSize / width) * height;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (maxSize / height) * width;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5);
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updatePhotoPreview(typeId) {
            const previewDiv = document.getElementById(`preview_${typeId}`);
            const photos = reportData.photos[typeId] || [];
            
            previewDiv.innerHTML = photos.map((photo, index) => `
                <img src="${photo.data}" class="photo-preview" alt="Photo ${index + 1}" style="width: 100px; height: 100px; object-fit: cover; margin: 5px;">
            `).join('');
        }

        function updatePhotoCounts() {
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                const countSpan = document.getElementById(`count_${type.id}`);
                const statusDiv = document.getElementById(`status_${type.id}`);
                
                if (countSpan) {
                    countSpan.textContent = photos.length;
                }
                
                if (statusDiv) {
                    if (photos.length >= type.required) {
                        statusDiv.className = 'photo-status complete';
                        statusDiv.textContent = '‚úì Completo';
                    } else {
                        statusDiv.className = 'photo-status pending';
                        statusDiv.textContent = '‚è≥ Pendiente';
                    }
                }
            });
        }

        function skipPhotoValidation() {
            photoTypes.forEach(type => {
                if (!reportData.photos[type.id]) {
                    reportData.photos[type.id] = [];
                }
                reportData.photos[type.id].push({
                    data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    timestamp: new Date().toISOString(),
                    name: 'demo_photo.png'
                });
            });
            
            updatePhotoCounts();
            saveCurrentStep();
            showNotification('Fotos de demostraci√≥n agregadas. Ahora puede continuar.', 'success');
        }

        // Review Functions
        function updateReview() {
            const siteReview = document.getElementById('siteReview');
            siteReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Site ID:</span>
                    <span class="review-value">${reportData.basic.siteId || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Site Name:</span>
                    <span class="review-value">${reportData.basic.siteName || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Team Leader:</span>
                    <span class="review-value">${reportData.basic.teamLeader || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">GPS Location:</span>
                    <span class="review-value">${reportData.gps.latitude ? `${reportData.gps.latitude.toFixed(6)}, ${reportData.gps.longitude.toFixed(6)}` : 'N/A'}</span>
                </div>
            `;
            
            const equipmentReview = document.getElementById('equipmentReview');
            equipmentReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Radios:</span>
                    <span class="review-value">${reportData.basic.radiosInstalled || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Antennas:</span>
                    <span class="review-value">${reportData.basic.antennasInstalled || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Equipment Items:</span>
                    <span class="review-value">${reportData.appurtenances.length} tipos</span>
                </div>
            `;
            
            const photoReview = document.getElementById('photoReview');
            let totalPhotos = 0;
            let completedTypes = 0;
            
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                totalPhotos += photos.length;
                if (photos.length >= type.required) {
                    completedTypes++;
                }
            });
            
            photoReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Total de fotos:</span>
                    <span class="review-value">${totalPhotos}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Categor√≠as completas:</span>
                    <span class="review-value">${completedTypes} de ${photoTypes.length}</span>
                </div>
            `;
        }

        // Submit and PDF Functions
        async function sendToSharePoint(reportData) {
            const POWER_AUTOMATE_URL = 'https://prod-19.westus.logic.azure.com:443/workflows/1170c524ac7e4e9c98e817550c91f1d0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JdS7ZO75Zm5eCaImMEoyGfDp3qzLUlNYLlo1J_dHGjE';
            
            // Generar ReportID √∫nico usando timestamp + random + contador
            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 100000); // N√∫mero aleatorio m√°s grande
            const uniqueReportID = `RPT-${timestamp}-${randomNum}`; // Removido siteId para hacerlo √∫nico siempre
            
            // Preparar AppurtenanceData con toda la informaci√≥n adicional
            const appurtenanceDataJSON = {
                appurtenances: reportData.appurtenances || [],
                measurements: reportData.measurements || {},
                gpsDetails: {
                    latitude: reportData.gps.latitude || 0,
                    longitude: reportData.gps.longitude || 0,
                    altitude: reportData.gps.altitude || 0,
                    accuracy: reportData.gps.accuracy || 0,
                    method: reportData.gps.manual ? 'manual' : 'auto'
                },
                metadata: reportData.metadata || {}
            };
            
            // Preparar PhotoLinks con informaci√≥n detallada de fotos
            const photoLinksJSON = {
                totalPhotos: 0,
                categories: {},
                photoMetadata: {}
            };
            
            // Contar fotos y organizar por categor√≠a
            Object.keys(reportData.photos).forEach(category => {
                const photos = reportData.photos[category] || [];
                photoLinksJSON.totalPhotos += photos.length;
                photoLinksJSON.categories[category] = photos.length;
                
                // Agregar metadata de cada foto
                photos.forEach((photo, index) => {
                    const photoKey = `${category}_${index + 1}`;
                    photoLinksJSON.photoMetadata[photoKey] = {
                        timestamp: photo.timestamp,
                        name: photo.name || photoKey,
                        category: photoTypes.find(t => t.id === category)?.name || category
                    };
                });
            });
            
            const dataToSend = {
                Title: reportData.basic.teamLeader || 'Field Technician',
                SubmittedBy: reportData.basic.submittedBy || 'Field Technician',
                SubmissionTimestamp: new Date().toISOString(),
                ReportID: uniqueReportID,
                TowerProviderSiteID: reportData.basic.siteId || '',
                TowerProviderSiteName: reportData.basic.siteName || '',
                CustomerSiteID: reportData.basic.customerSiteId || '',
                CustomerSiteName: reportData.basic.customerSiteName || '',
                RadiosInstalled: parseInt(reportData.basic.radiosInstalled) || 0,
                AntennasInstalled: parseInt(reportData.basic.antennasInstalled) || 0,
                TeamLeader: reportData.basic.teamLeader || '',
                TowerTopInstallation: reportData.basic.towerTop === 'yes',
                CompletionDate: reportData.basic.completionDate || new Date().toISOString().split('T')[0],
                TPTenant: reportData.basic.tpTenant || '',
                Latitude: reportData.gps.latitude || 0,
                Longitude: reportData.gps.longitude || 0,
                AppurtenanceData: JSON.stringify(appurtenanceDataJSON),
                PhotoLinks: JSON.stringify(photoLinksJSON),
                ReportStatus: 'DraftSubmittedPDF'
            };
            
            try {
                const response = await fetch(POWER_AUTOMATE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                if (response.ok) {
                    return true;
                } else {
                    console.error('Error response:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Network/Connection error:', error);
                return false;
            }
        }

        async function submitReport() {
            const submitBtn = event.target;
            const statusDiv = document.getElementById('submitStatus');
            
            submitBtn.disabled = true;
            statusDiv.innerHTML = '<div class="spinner"></div><p>Enviando reporte a SharePoint...</p>';
            
            try {
                const reportId = `RPT-${Date.now()}-${Math.floor(Math.random() * 100000)}`; // ID √∫nico sin siteId
                localStorage.setItem(reportId, JSON.stringify(reportData));
                
                const sentToSharePoint = await sendToSharePoint(reportData);
                
                if (sentToSharePoint) {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(232, 245, 233, 0.9); padding: 20px; border-radius: 6px; text-align: left;">
                            <h3 style="color: #2e7d32;">‚úì Reporte Enviado a SharePoint</h3>
                            <p>ID: ${reportId}</p>
                            <p style="margin-top: 15px;">
                                <strong>‚úì Guardado localmente</strong><br>
                                <strong>‚úì Enviado a SharePoint</strong>
                            </p>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                                    ‚ûï Crear Nuevo Reporte
                                </button>
                                <button class="btn btn-primary" onclick="sendDetailedEmail('${reportId}')" style="flex: 1;">
                                    üìß Enviar Email Detallado
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(255, 243, 205, 0.9); padding: 20px; border-radius: 6px; text-align: left;">
                            <h3 style="color: #856404;">‚ö†Ô∏è Guardado Solo Localmente</h3>
                            <p>ID: ${reportId}</p>
                            <p style="margin-top: 15px;">
                                El reporte se guard√≥ en el dispositivo pero no se pudo enviar a SharePoint.
                            </p>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="retrySharePoint('${reportId}')" style="flex: 1;">
                                    üîÑ Reintentar Env√≠o
                                </button>
                                <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                                    ‚ûï Nuevo Reporte
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                submitBtn.disabled = false;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="background: rgba(255, 235, 238, 0.9); padding: 20px; border-radius: 6px;">
                        <h3 style="color: #c62828;">Error al guardar</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            Recargar P√°gina
                        </button>
                    </div>
                `;
                submitBtn.disabled = false;
            }
        }

        async function retrySharePoint(reportId) {
            const savedData = localStorage.getItem(reportId);
            if (savedData) {
                const data = JSON.parse(savedData);
                const statusDiv = document.getElementById('submitStatus');
                
                statusDiv.innerHTML = '<div class="spinner"></div><p>Reintentando env√≠o...</p>';
                
                const sent = await sendToSharePoint(data);
                
                if (sent) {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(232, 245, 233, 0.9); padding: 20px; border-radius: 6px;">
                            <h3 style="color: #2e7d32;">‚úì Enviado Exitosamente</h3>
                            <p>El reporte se envi√≥ a SharePoint.</p>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                                    ‚ûï Crear Nuevo Reporte
                                </button>
                                <button class="btn btn-primary" onclick="location.href='mailto:accounting@newcomm2000.com?subject=Tower Report ${reportId}'" style="flex: 1;">
                                    üìß Enviar por Email
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(255, 235, 238, 0.9); padding: 20px; border-radius: 6px;">
                            <h3 style="color: #c62828;">Error al enviar</h3>
                            <p>No se pudo conectar con SharePoint. Verifique su conexi√≥n.</p>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary" onclick="retrySharePoint('${reportId}')" style="flex: 1;">
                                    üîÑ Reintentar
                                </button>
                                <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                                    ‚ûï Nuevo Reporte
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        }

        function startNewReport() {
            reportData = {
                basic: {},
                gps: {},
                appurtenances: [],
                photos: {}
            };
            
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type === 'date') {
                    field.value = new Date().toISOString().split('T')[0];
                } else if (field.id === 'appQuantity') {
                    field.value = '1';
                } else {
                    field.value = '';
                }
            });
            
            currentStep = 1;
            showStep(1);
            
            document.getElementById('gpsStatus').innerHTML = '';
            document.getElementById('appurtenanceList').innerHTML = '';
            
            generatePhotoGrid();
            
            showNotification('Nuevo reporte iniciado', 'success');
        }

        function showReportSummary() {
            // Calcular el total de fotos
            let totalPhotos = 0;
            Object.values(reportData.photos).forEach(photoArray => {
                if (Array.isArray(photoArray)) {
                    totalPhotos += photoArray.length;
                }
            });

            const summaryHTML = `
                <div style="background: rgba(245, 245, 245, 0.9); padding: 20px; border-radius: 6px; margin: 20px 0;">
                    <h3 style="color: #0066cc; margin-bottom: 15px;">Resumen del Reporte</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333;">Informaci√≥n del Sitio</h4>
                        <p><strong>Site ID:</strong> ${reportData.basic.siteId || 'N/A'}</p>
                        <p><strong>Site Name:</strong> ${reportData.basic.siteName || 'N/A'}</p>
                        <p><strong>Team Leader:</strong> ${reportData.basic.teamLeader || 'N/A'}</p>
                        <p><strong>Fecha:</strong> ${reportData.basic.completionDate || 'N/A'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333;">Equipos Instalados</h4>
                        <p><strong>Radios:</strong> ${reportData.basic.radiosInstalled || 0}</p>
                        <p><strong>Antenas:</strong> ${reportData.basic.antennasInstalled || 0}</p>
                        <p><strong>Equipos registrados:</strong> ${reportData.appurtenances.length}</p>
                    </div>
                    
                    ${reportData.measurements && (reportData.measurements.towerHeight || reportData.measurements.sector1TapeDrop) ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #333;">Mediciones</h4>
                        ${reportData.measurements.towerHeight ? `<p><strong>Tower Height:</strong> ${reportData.measurements.towerHeight}</p>` : ''}
                        ${reportData.measurements.sector1TapeDrop ? `<p><strong>Sector 1:</strong> ${reportData.measurements.sector1TapeDrop}</p>` : ''}
                        ${reportData.measurements.sector2TapeDrop ? `<p><strong>Sector 2:</strong> ${reportData.measurements.sector2TapeDrop}</p>` : ''}
                        ${reportData.measurements.sector3TapeDrop ? `<p><strong>Sector 3:</strong> ${reportData.measurements.sector3TapeDrop}</p>` : ''}
                        ${reportData.measurements.tallestPoint ? `<p><strong>Tallest Point:</strong> ${reportData.measurements.tallestPoint}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    <div>
                        <h4 style="color: #333;">Documentaci√≥n</h4>
                        <p><strong>Total de fotos:</strong> ${totalPhotos}</p>
                        <p><strong>GPS:</strong> ${reportData.gps.latitude ? '‚úì Capturado' : '‚úó No capturado'}</p>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="closeReportSummary()" style="margin-top: 15px;">
                        Cerrar Resumen
                    </button>
                </div>
            `;
            
            const statusDiv = document.getElementById('submitStatus');
            statusDiv.innerHTML = summaryHTML;
            showNotification('Resumen del reporte mostrado', 'info');
        }

        function closeReportSummary() {
            document.getElementById('submitStatus').innerHTML = '';
        }

        function sendDetailedEmail(reportId) {
            // Crear un resumen detallado para el email
            const emailSubject = `Tower Provider Report - ${reportData.basic.siteName || reportId}`;
            
            const emailBody = `
TOWER PROVIDER REPORT
=====================

SITE INFORMATION:
- Site ID: ${reportData.basic.siteId || 'N/A'}
- Site Name: ${reportData.basic.siteName || 'N/A'}
- Customer Site ID: ${reportData.basic.customerSiteId || 'N/A'}
- Customer Site Name: ${reportData.basic.customerSiteName || 'N/A'}

INSTALLATION DETAILS:
- Radios Installed: ${reportData.basic.radiosInstalled || '0'}
- Antennas Installed: ${reportData.basic.antennasInstalled || '0'}
- Team Leader: ${reportData.basic.teamLeader || 'N/A'}
- Tower Top Installation: ${reportData.basic.towerTop || 'N/A'}
- Completion Date: ${reportData.basic.completionDate || 'N/A'}
- TP Tenant: ${reportData.basic.tpTenant || 'N/A'}

GPS LOCATION:
- Latitude: ${reportData.gps.latitude || 'N/A'}
- Longitude: ${reportData.gps.longitude || 'N/A'}
- Accuracy: ${reportData.gps.accuracy ? `¬±${reportData.gps.accuracy.toFixed(1)}m` : 'N/A'}

${reportData.measurements && (reportData.measurements.towerHeight || reportData.measurements.sector1TapeDrop) ? `
MEASUREMENTS:
- Tower Height: ${reportData.measurements.towerHeight || 'N/A'}
- Sector 1 Tape Drop: ${reportData.measurements.sector1TapeDrop || 'N/A'}
- Sector 2 Tape Drop: ${reportData.measurements.sector2TapeDrop || 'N/A'}
- Sector 3 Tape Drop: ${reportData.measurements.sector3TapeDrop || 'N/A'}
- Tallest Point: ${reportData.measurements.tallestPoint || 'N/A'}
` : ''}

EQUIPMENT INSTALLED (${reportData.appurtenances.length} items):
${reportData.appurtenances.map((app, i) => 
`${i + 1}. ${app.type} - ${app.manufacturer} ${app.model} (Qty: ${app.quantity})`
).join('\n')}

PHOTO DOCUMENTATION:
- Total Photos: ${Object.values(reportData.photos).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0)}
${Object.entries(reportData.photos).map(([category, photos]) => {
    const catName = photoTypes.find(t => t.id === category)?.name || category;
    return `- ${catName}: ${photos ? photos.length : 0} photos`;
}).join('\n')}

REPORT DETAILS:
- Report ID: ${reportId}
- Submitted by: ${reportData.basic.submittedBy || 'Field Technician'}
- Submission Time: ${new Date().toLocaleString()}

---
This report has been submitted to SharePoint.
For the complete PDF report with all photos, please check SharePoint or request it from the system administrator.

Newcomm Management Services Corp.
PO Box 4116, Vega Baja PR 00694
Phone: 787-718-2600
            `.trim();
            
            // Codificar el body para URL
            const encodedBody = encodeURIComponent(emailBody);
            
            // Crear el link mailto con body
            const mailtoLink = `mailto:accounting@newcomm2000.com?subject=${encodeURIComponent(emailSubject)}&body=${encodedBody}`;
            
            // Verificar si el link es muy largo (algunos clientes de email tienen l√≠mites)
            if (mailtoLink.length > 2000) {
                // Si es muy largo, crear una versi√≥n resumida
                const shortBody = `
Tower Provider Report - ${reportData.basic.siteName || 'N/A'}
Site ID: ${reportData.basic.siteId || 'N/A'}
Report ID: ${reportId}

Please check SharePoint for the complete report with all details and photos.

Submitted by: ${reportData.basic.submittedBy || 'Field Technician'}
Date: ${new Date().toLocaleString()}
                `.trim();
                
                window.location.href = `mailto:accounting@newcomm2000.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(shortBody)}`;
                showNotification('Email abierto con resumen corto (l√≠mite de caracteres)', 'info');
            } else {
                window.location.href = mailtoLink;
                showNotification('Email abierto con todos los detalles', 'success');
            }
        }

        // Notification function
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
