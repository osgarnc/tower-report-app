<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0066cc">
    <title>Tower Report Mobile</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            position: relative;
        }

        /* Header */
        .header {
            background-color: #0066cc;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .step.active {
            background-color: #0066cc;
            color: white;
        }

        .step.completed {
            background-color: #4caf50;
            color: white;
        }

        /* Form Sections */
        .form-section {
            display: none;
            padding: 20px;
            animation: slideIn 0.3s ease-out;
        }

        .form-section.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0066cc;
        }

        .required {
            color: #f44336;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background-color: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0052a3;
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .btn-secondary {
            background-color: #757575;
            color: white;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        /* GPS Status */
        .gps-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }

        .gps-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .gps-status.error {
            background-color: #ffebee;
            color: #c62828;
        }

        /* Appurtenance List */
        .appurtenance-list {
            margin-top: 20px;
        }

        .appurtenance-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appurtenance-info h4 {
            margin: 0 0 5px 0;
            color: #0066cc;
        }

        .appurtenance-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        /* Photo Section */
        .photo-requirements {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .photo-requirements h3 {
            margin-bottom: 10px;
            color: #1565c0;
        }

        .photo-requirements ul {
            margin-left: 20px;
        }

        .photo-grid {
            display: grid;
            gap: 15px;
        }

        .photo-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .photo-item h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .photo-capture {
            position: relative;
            margin-bottom: 10px;
        }

        .camera-input {
            display: none;
        }

        .camera-btn {
            background-color: #0066cc;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn:hover {
            background-color: #0052a3;
        }

        .photo-preview {
            margin-top: 10px;
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-count {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .photo-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .photo-status.complete {
            background-color: #4caf50;
            color: white;
        }

        .photo-status.pending {
            background-color: #ff9800;
            color: white;
        }

        /* Review Section */
        .review-section {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .review-section h3 {
            margin-bottom: 10px;
            color: #0066cc;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-weight: 500;
            color: #666;
        }

        .review-value {
            color: #333;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .notification.success {
            background-color: #4caf50;
        }

        .notification.error {
            background-color: #f44336;
        }

        .notification.info {
            background-color: #2196f3;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 20px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Tower Provider Report</h1>
        </header>

        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
            <div class="step" id="step5">5</div>
        </div>

        <!-- Step 1: Basic Information -->
        <div class="form-section active" id="section1">
            <h2>Informaci√≥n B√°sica</h2>
            
            <!-- Storage management -->
            <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Espacio usado: <span id="storageIndicator">calculando...</span></span>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 5px 10px;">
                        Limpiar datos
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Tower Provider Site ID <span class="required">*</span></label>
                <input type="text" id="siteId" placeholder="ej: 10028307" required>
            </div>

            <div class="form-group">
                <label>Tower Provider Site Name <span class="required">*</span></label>
                <input type="text" id="siteName" placeholder="ej: Vega Baja DT" required>
            </div>

            <div class="form-group">
                <label>Customer Site ID <span class="required">*</span></label>
                <input type="text" id="customerSiteId" placeholder="ej: 10028307" required>
            </div>

            <div class="form-group">
                <label>Customer Site Name <span class="required">*</span></label>
                <input type="text" id="customerSiteName" placeholder="ej: Vega Baja DT" required>
            </div>

            <div class="form-group">
                <label>Radios Installed <span class="required">*</span></label>
                <input type="number" id="radiosInstalled" min="0" placeholder="3" required>
            </div>

            <div class="form-group">
                <label>Antennas Installed <span class="required">*</span></label>
                <input type="number" id="antennasInstalled" min="0" placeholder="6" required>
            </div>

            <div class="form-group">
                <label>Team Leader <span class="required">*</span></label>
                <input type="text" id="teamLeader" placeholder="ej: Christopher Rodriguez" required>
            </div>

            <div class="form-group">
                <label>Tower Top Installation <span class="required">*</span></label>
                <select id="towerTop" required>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

            <div class="form-group">
                <label>Completion Date <span class="required">*</span></label>
                <input type="date" id="completionDate" required>
            </div>

            <div class="form-group">
                <label>TP Tenant <span class="required">*</span></label>
                <input type="text" id="tpTenant" placeholder="ej: Liberty" required>
            </div>

            <div class="form-group">
                <button class="btn btn-success btn-block" onclick="getGPSLocation()">
                    üìç Obtener Ubicaci√≥n GPS
                </button>
                <div id="gpsStatus"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Appurtenance Information -->
        <div class="form-section" id="section2">
            <h2>Informaci√≥n de Equipos</h2>
            
            <button class="btn btn-primary btn-block" onclick="showAppurtenanceForm()">
                + Agregar Equipo
            </button>

            <div id="appurtenanceForm" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label>Type</label>
                    <select id="appType">
                        <option value="Antenna">Antenna</option>
                        <option value="RRU">RRU</option>
                        <option value="Cable">Cable</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Rad Center</label>
                    <input type="text" id="appRadCenter" placeholder="50">
                </div>

                <div class="form-group">
                    <label>Manufacturer</label>
                    <input type="text" id="appManufacturer" placeholder="ej: Ericsson">
                </div>

                <div class="form-group">
                    <label>Model</label>
                    <input type="text" id="appModel" placeholder="ej: 840590003">
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="appQuantity" min="1" value="1">
                </div>

                <div class="form-group">
                    <label>Coax Size (if applicable)</label>
                    <input type="text" id="appCoaxSize" placeholder="Optional">
                </div>

                <button class="btn btn-success" onclick="addAppurtenance()">Guardar</button>
                <button class="btn btn-secondary" onclick="cancelAppurtenance()">Cancelar</button>
            </div>

            <div class="appurtenance-list" id="appurtenanceList"></div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Photo Documentation -->
        <div class="form-section" id="section3">
            <h2>Documentaci√≥n Fotogr√°fica</h2>
            
            <div class="photo-requirements">
                <h3>üì∏ Fotos Requeridas</h3>
                <ul>
                    <li>Tome al menos 5 fotos en total para continuar</li>
                    <li>Puede tomar m√∫ltiples fotos por categor√≠a</li>
                    <li>Las fotos se guardan autom√°ticamente</li>
                </ul>
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>Modo Demo:</strong> 
                    <button class="btn btn-secondary" onclick="skipPhotoValidation()" style="margin-left: 10px;">
                        Saltar validaci√≥n de fotos
                    </button>
                </div>
            </div>

            <div class="photo-grid" id="photoGrid">
                <!-- Photo items will be generated by JavaScript -->
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div class="form-section" id="section4">
            <h2>Revisar Informaci√≥n</h2>
            
            <div class="review-section">
                <h3>Informaci√≥n del Sitio</h3>
                <div id="siteReview"></div>
            </div>

            <div class="review-section">
                <h3>Equipos Instalados</h3>
                <div id="equipmentReview"></div>
            </div>

            <div class="review-section">
                <h3>Documentaci√≥n Fotogr√°fica</h3>
                <div id="photoReview"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 5: Submit -->
        <div class="form-section" id="section5">
            <h2>Enviar Reporte</h2>
            
            <div style="text-align: center; padding: 40px 20px;">
                <h3>¬øEst√° listo para enviar el reporte?</h3>
                <p style="margin: 20px 0; color: #666;">
                    Al enviar, se generar√° un PDF y se enviar√° autom√°ticamente a accounting@newcomm2000.com
                </p>
                
                <button class="btn btn-primary btn-block" onclick="generateTowerReportPDF()" style="margin-bottom: 10px; font-size: 16px;">
                    üìÑ Solo Generar PDF
                </button>
                
                <button class="btn btn-success btn-block" onclick="submitReport()" style="font-size: 18px; padding: 15px;">
                    ‚úì Enviar Reporte
                </button>
                
                <div id="submitStatus" style="margin-top: 20px;"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="previousStep()">
                    ‚Üê Anterior
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let reportData = {
            basic: {},
            gps: {},
            appurtenances: [],
            photos: {}
        };

        // Photo types configuration - Simplified
        const photoTypes = [
            { id: 'equipment_room', name: 'Equipment Room / Pad', required: 2 },
            { id: 'cabinet_doors', name: 'Cabinet Doors (Open & Close)', required: 2 },
            { id: 'safety_lines', name: 'Safety Lines (All)', required: 2 },
            { id: 'sectors_ground', name: 'Sectors from Ground (1,2,3)', required: 3 },
            { id: 'antenna_labels', name: 'Antenna Labels', required: 2 },
            { id: 'radio_labels', name: 'Radio Labels', required: 2 },
            { id: 'sector_posts', name: 'Sector Post Pictures', required: 3 },
            { id: 'tape_measurements', name: 'Tape Drop Measurements', required: 2 },
            { id: 'general_site', name: 'General Site Photos', required: 2 }
        ];

        // Initialize app
        window.onload = function() {
            // Set today's date as default
            document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
            
            // Generate photo grid
            generatePhotoGrid();
            
            // Load saved data if exists
            loadSavedData();
            
            // Update storage indicator
            updateStorageIndicator();
            
            // Optimizar almacenamiento autom√°ticamente si es necesario
            optimizeStorage();
        };

        // Update storage indicator - MEJORADA
        function updateStorageIndicator() {
            const indicator = document.getElementById('storageIndicator');
            if (indicator) {
                const usedMB = checkStorageSpace();
                const usedNum = parseFloat(usedMB);
                
                indicator.textContent = `${usedMB} MB`;
                
                if (usedNum > 4.5) {
                    indicator.style.color = 'red';
                    indicator.textContent += ' (CR√çTICO)';
                } else if (usedNum > 3) {
                    indicator.style.color = 'orange';
                    indicator.textContent += ' (alto)';
                } else {
                    indicator.style.color = 'green';
                }
            }
        }

        // Clear all data function
        function clearAllData() {
            if (confirm('¬øEliminar todos los datos guardados? Esto borrar√° reportes anteriores.')) {
                localStorage.clear();
                reportData = {
                    basic: {},
                    gps: {},
                    appurtenances: [],
                    photos: {}
                };
                showNotification('Datos eliminados correctamente', 'success');
                updateStorageIndicator();
                location.reload();
            }
        }

        // Navigation functions
        function nextStep() {
            console.log('NextStep called. Current step:', currentStep);
            
            if (validateCurrentStep()) {
                saveCurrentStep();
                if (currentStep < 5) {
                    currentStep++;
                    console.log('Moving to step:', currentStep);
                    showStep(currentStep);
                } else {
                    console.log('Already at last step');
                }
            } else {
                console.log('Validation failed for step:', currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show current section
            document.getElementById('section' + step).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            // Update review section if on step 4
            if (step === 4) {
                updateReview();
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Validation functions
        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    const requiredFields = ['siteId', 'siteName', 'customerSiteId', 'customerSiteName', 
                                          'radiosInstalled', 'antennasInstalled', 'teamLeader', 
                                          'completionDate', 'tpTenant'];
                    for (let field of requiredFields) {
                        if (!document.getElementById(field).value) {
                            showNotification('Por favor complete todos los campos requeridos', 'error');
                            document.getElementById(field).focus();
                            return false;
                        }
                    }
                    if (!reportData.gps.latitude) {
                        showNotification('Por favor capture la ubicaci√≥n GPS', 'error');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (reportData.appurtenances.length === 0) {
                        showNotification('Por favor agregue al menos un equipo', 'error');
                        return false;
                    }
                    return true;
                    
                case 3:
                    // Check if at least some photos are taken
                    let totalPhotos = 0;
                    Object.values(reportData.photos).forEach(photoArray => {
                        totalPhotos += photoArray.length;
                    });
                    
                    if (totalPhotos < 5) {
                        showNotification('Por favor tome al menos 5 fotos para continuar', 'error');
                        return false;
                    }
                    
                    // Optional: Show warning if not all photos are taken
                    let missingCount = 0;
                    photoTypes.forEach(type => {
                        const photos = reportData.photos[type.id] || [];
                        if (photos.length < type.required) {
                            missingCount += type.required - photos.length;
                        }
                    });
                    
                    if (missingCount > 0 && totalPhotos < 20) {
                        if (!confirm(`Faltan ${missingCount} fotos. ¬øDesea continuar de todos modos?`)) {
                            return false;
                        }
                    }
                    
                    return true;
                    
                default:
                    return true;
            }
        }

        function saveCurrentStep() {
            try {
                switch(currentStep) {
                    case 1:
                        // Generar un ID √∫nico autom√°ticamente
                        const timestamp = Date.now();
                        const randomNum = Math.floor(Math.random() * 1000);
                        const autoSiteId = document.getElementById('siteId').value || `AUTO-${timestamp}-${randomNum}`;
                        
                        reportData.basic = {
                            siteId: autoSiteId,
                            siteName: document.getElementById('siteName').value,
                            customerSiteId: document.getElementById('customerSiteId').value,
                            customerSiteName: document.getElementById('customerSiteName').value,
                            radiosInstalled: document.getElementById('radiosInstalled').value,
                            antennasInstalled: document.getElementById('antennasInstalled').value,
                            teamLeader: document.getElementById('teamLeader').value,
                            towerTop: document.getElementById('towerTop').value,
                            completionDate: document.getElementById('completionDate').value,
                            tpTenant: document.getElementById('tpTenant').value,
                            submittedBy: 'Field Technician',
                            submissionTimestamp: new Date().toISOString(),
                            uniqueReportId: `RPT-${timestamp}-${randomNum}` // ID √∫nico para cada reporte
                        };
                        break;
                }
                
                // Try to save to localStorage
                try {
                    localStorage.setItem('towerReport', JSON.stringify(reportData));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        // If storage is full, clear old reports
                        clearOldReports();
                        // Try again
                        try {
                            localStorage.setItem('towerReport', JSON.stringify(reportData));
                        } catch (e2) {
                            showNotification('Almacenamiento lleno. Algunas fotos no se guardaron.', 'error');
                            // Save without photos as last resort
                            const minimalData = {
                                basic: reportData.basic,
                                gps: reportData.gps,
                                appurtenances: reportData.appurtenances,
                                photos: {} // Empty photos to save space
                            };
                            localStorage.setItem('towerReport', JSON.stringify(minimalData));
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Error al guardar. Continuando sin guardar.', 'error');
            }
        }

        // Clear old reports to free space - MEJORADA
        function clearOldReports() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('RPT-')) {
                    keysToRemove.push(key);
                }
            }
            // Remove old reports
            keysToRemove.forEach(key => localStorage.removeItem(key));
            showNotification('Se limpiaron reportes antiguos para liberar espacio', 'info');
        }

        // Nueva funci√≥n para limpiar fotos antiguas
        function clearOldPhotos() {
            // Limpiar fotos de reportes anteriores
            clearOldReports();
            
            // Si a√∫n hay problemas, reducir fotos del reporte actual
            if (reportData.photos) {
                Object.keys(reportData.photos).forEach(photoType => {
                    const photos = reportData.photos[photoType];
                    if (photos && photos.length > 3) {
                        // Mantener solo las 3 fotos m√°s recientes por tipo
                        reportData.photos[photoType] = photos.slice(-3);
                    }
                });
                updatePhotoCounts();
                showNotification('Se redujeron fotos para liberar espacio', 'info');
            }
        }

        // Add storage indicator - MEJORADA
        function checkStorageSpace() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }
                const usedMB = (totalSize / 1024 / 1024).toFixed(2);
                return usedMB;
            } catch (e) {
                return 'Unknown';
            }
        }

        // Funci√≥n para optimizar almacenamiento autom√°ticamente
        function optimizeStorage() {
            const currentSize = parseFloat(checkStorageSpace());
            
            if (currentSize > 4) {
                showNotification('Optimizando almacenamiento...', 'info');
                
                // 1. Limpiar reportes antiguos
                clearOldReports();
                
                // 2. Si a√∫n hay problemas, comprimir m√°s las fotos actuales
                if (parseFloat(checkStorageSpace()) > 3) {
                    Object.keys(reportData.photos).forEach(photoType => {
                        const photos = reportData.photos[photoType];
                        if (photos && photos.length > 2) {
                            reportData.photos[photoType] = photos.slice(-2);
                        }
                    });
                    updatePhotoCounts();
                }
                
                updateStorageIndicator();
                showNotification('Almacenamiento optimizado', 'success');
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem('towerReport');
            if (saved) {
                reportData = JSON.parse(saved);
                // Restore form values
                if (reportData.basic) {
                    Object.keys(reportData.basic).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = reportData.basic[key];
                        }
                    });
                }
                // Restore GPS status
                if (reportData.gps.latitude) {
                    showGPSStatus(true);
                }
                // Restore appurtenances
                updateAppurtenanceList();
                // Update photo counts
                updatePhotoCounts();
            }
        }

        // GPS Functions - MEJORADAS para iOS
        function getGPSLocation() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = '<div class="spinner"></div><p>Obteniendo ubicaci√≥n...</p>';
            
            if (!navigator.geolocation) {
                showGPSStatus(false, 'Geolocalizaci√≥n no soportada en este navegador');
                return;
            }

            // Opciones m√°s compatibles con iOS
            const options = {
                enableHighAccuracy: false, // Cambiar a false para iOS
                timeout: 15000, // M√°s tiempo
                maximumAge: 300000 // 5 minutos de cache
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    reportData.gps = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        altitude: position.coords.altitude || 0,
                        accuracy: position.coords.accuracy
                    };
                    showGPSStatus(true);
                    saveCurrentStep();
                },
                (error) => {
                    console.error('GPS Error:', error);
                    let errorMessage = 'Error desconocido';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Permisos de ubicaci√≥n denegados. Ve a Configuraci√≥n > Safari > Ubicaci√≥n y act√≠vala.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Ubicaci√≥n no disponible. Intenta en un √°rea con mejor se√±al.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Tiempo agotado. Intenta de nuevo.';
                            break;
                        default:
                            errorMessage = `Error de ubicaci√≥n: ${error.message}`;
                    }
                    
                    showGPSStatus(false, errorMessage);
                    
                    // Opci√≥n de ubicaci√≥n manual para iOS
                    const statusDiv = document.getElementById('gpsStatus');
                    statusDiv.innerHTML += `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="showManualGPS()" style="font-size: 14px;">
                                üìç Ingresar ubicaci√≥n manualmente
                            </button>
                        </div>
                    `;
                },
                options
            );
        }

        // Nueva funci√≥n para GPS manual
        function showManualGPS() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                    <h4>Ubicaci√≥n Manual</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                        <input type="number" id="manualLat" placeholder="Latitud" step="any" style="padding: 8px;">
                        <input type="number" id="manualLng" placeholder="Longitud" step="any" style="padding: 8px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveManualGPS()" style="font-size: 14px;">
                            Guardar Ubicaci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="getGPSLocation()" style="font-size: 14px;">
                            Reintentar GPS
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Puedes usar Google Maps para obtener las coordenadas exactas del sitio.
                    </p>
                </div>
            `;
        }

        // Funci√≥n para guardar GPS manual
        function saveManualGPS() {
            const lat = document.getElementById('manualLat').value;
            const lng = document.getElementById('manualLng').value;
            
            if (!lat || !lng) {
                showNotification('Por favor ingresa latitud y longitud', 'error');
                return;
            }
            
            if (Math.abs(lat) > 90 || Math.abs(lng) > 180) {
                showNotification('Coordenadas inv√°lidas. Verifica los valores.', 'error');
                return;
            }
            
            reportData.gps = {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                altitude: 0,
                accuracy: 0,
                manual: true
            };
            
            showGPSStatus(true);
            saveCurrentStep();
            showNotification('Ubicaci√≥n manual guardada correctamente', 'success');
        }

        function showGPSStatus(success, message = '') {
            const statusDiv = document.getElementById('gpsStatus');
            if (success) {
                const isManual = reportData.gps.manual ? ' (Manual)' : '';
                statusDiv.innerHTML = `
                    <div class="gps-status success">
                        ‚úì GPS Capturado${isManual}: ${reportData.gps.latitude.toFixed(7)}, ${reportData.gps.longitude.toFixed(7)}
                        ${!reportData.gps.manual ? `<br>Precisi√≥n: ¬±${reportData.gps.accuracy.toFixed(1)}m` : ''}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="gps-status error">
                        ‚úó Error: ${message}
                    </div>
                `;
            }
        }

        // GPS Functions - MEJORADAS para iOS
        function getGPSLocation() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = '<div class="spinner"></div><p>Obteniendo ubicaci√≥n...</p>';
            
            if (!navigator.geolocation) {
                showGPSStatus(false, 'Geolocalizaci√≥n no soportada en este navegador');
                return;
            }

            // Opciones m√°s compatibles con iOS
            const options = {
                enableHighAccuracy: false, // Cambiar a false para iOS
                timeout: 15000, // M√°s tiempo
                maximumAge: 300000 // 5 minutos de cache
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    reportData.gps = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        altitude: position.coords.altitude || 0,
                        accuracy: position.coords.accuracy
                    };
                    showGPSStatus(true);
                    saveCurrentStep();
                },
                (error) => {
                    console.error('GPS Error:', error);
                    let errorMessage = 'Error desconocido';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Permisos de ubicaci√≥n denegados. Ve a Configuraci√≥n > Safari > Ubicaci√≥n y act√≠vala.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Ubicaci√≥n no disponible. Intenta en un √°rea con mejor se√±al.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Tiempo agotado. Intenta de nuevo.';
                            break;
                        default:
                            errorMessage = `Error de ubicaci√≥n: ${error.message}`;
                    }
                    
                    showGPSStatus(false, errorMessage);
                    
                    // Opci√≥n de ubicaci√≥n manual para iOS
                    const statusDiv = document.getElementById('gpsStatus');
                    statusDiv.innerHTML += `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="showManualGPS()" style="font-size: 14px;">
                                üìç Ingresar ubicaci√≥n manualmente
                            </button>
                        </div>
                    `;
                },
                options
            );
        }

        // Nueva funci√≥n para GPS manual
        function showManualGPS() {
            const statusDiv = document.getElementById('gpsStatus');
            statusDiv.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                    <h4>Ubicaci√≥n Manual</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                        <input type="number" id="manualLat" placeholder="Latitud" step="any" style="padding: 8px;">
                        <input type="number" id="manualLng" placeholder="Longitud" step="any" style="padding: 8px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveManualGPS()" style="font-size: 14px;">
                            Guardar Ubicaci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="getGPSLocation()" style="font-size: 14px;">
                            Reintentar GPS
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Puedes usar Google Maps para obtener las coordenadas exactas del sitio.
                    </p>
                </div>
            `;
        }

        // Funci√≥n para guardar GPS manual
        function saveManualGPS() {
            const lat = document.getElementById('manualLat').value;
            const lng = document.getElementById('manualLng').value;
            
            if (!lat || !lng) {
                showNotification('Por favor ingresa latitud y longitud', 'error');
                return;
            }
            
            if (Math.abs(lat) > 90 || Math.abs(lng) > 180) {
                showNotification('Coordenadas inv√°lidas. Verifica los valores.', 'error');
                return;
            }
            
            reportData.gps = {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                altitude: 0,
                accuracy: 0,
                manual: true
            };
            
            showGPSStatus(true);
            saveCurrentStep();
            showNotification('Ubicaci√≥n manual guardada correctamente', 'success');
        }

        function showGPSStatus(success, message = '') {
            const statusDiv = document.getElementById('gpsStatus');
            if (success) {
                const isManual = reportData.gps.manual ? ' (Manual)' : '';
                statusDiv.innerHTML = `
                    <div class="gps-status success">
                        ‚úì GPS Capturado${isManual}: ${reportData.gps.latitude.toFixed(7)}, ${reportData.gps.longitude.toFixed(7)}
                        ${!reportData.gps.manual ? `<br>Precisi√≥n: ¬±${reportData.gps.accuracy.toFixed(1)}m` : ''}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="gps-status error">
                        ‚úó Error: ${message}
                    </div>
                `;
            }
        }

        // Appurtenance Functions
        function showAppurtenanceForm() {
            document.getElementById('appurtenanceForm').style.display = 'block';
        }

        function cancelAppurtenance() {
            document.getElementById('appurtenanceForm').style.display = 'none';
            // Clear form
            ['appType', 'appRadCenter', 'appManufacturer', 'appModel', 'appQuantity', 'appCoaxSize'].forEach(id => {
                document.getElementById(id).value = id === 'appQuantity' ? '1' : '';
            });
        }

        function addAppurtenance() {
            const appurtenance = {
                type: document.getElementById('appType').value,
                radCenter: document.getElementById('appRadCenter').value,
                manufacturer: document.getElementById('appManufacturer').value,
                model: document.getElementById('appModel').value,
                quantity: document.getElementById('appQuantity').value,
                coaxSize: document.getElementById('appCoaxSize').value
            };
            
            reportData.appurtenances.push(appurtenance);
            updateAppurtenanceList();
            cancelAppurtenance();
            saveCurrentStep();
        }

        function updateAppurtenanceList() {
            const listDiv = document.getElementById('appurtenanceList');
            listDiv.innerHTML = '';
            
            reportData.appurtenances.forEach((app, index) => {
                const item = document.createElement('div');
                item.className = 'appurtenance-item';
                item.innerHTML = `
                    <div class="appurtenance-info">
                        <h4>${app.type} - ${app.manufacturer}</h4>
                        <p>Model: ${app.model} | Qty: ${app.quantity} | Rad: ${app.radCenter}</p>
                    </div>
                    <button class="btn btn-danger" onclick="removeAppurtenance(${index})">√ó</button>
                `;
                listDiv.appendChild(item);
            });
        }

        function removeAppurtenance(index) {
            reportData.appurtenances.splice(index, 1);
            updateAppurtenanceList();
            saveCurrentStep();
        }

        // Photo Functions
        function generatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            photoTypes.forEach(type => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <h4>${type.name}</h4>
                    <div class="photo-capture">
                        <input type="file" 
                               accept="image/*" 
                               capture="environment" 
                               multiple
                               class="camera-input" 
                               id="photo_${type.id}"
                               onchange="handlePhotoCapture('${type.id}', this)">
                        <label for="photo_${type.id}" class="camera-btn">
                            üì∑ Tomar Foto (${type.required} requeridas)
                        </label>
                    </div>
                    <div id="preview_${type.id}"></div>
                    <div class="photo-count">
                        <span id="count_${type.id}">0</span> de ${type.required} fotos
                    </div>
                    <div class="photo-status ${(reportData.photos[type.id] || []).length >= type.required ? 'complete' : 'pending'}" 
                         id="status_${type.id}">
                        ${(reportData.photos[type.id] || []).length >= type.required ? '‚úì Completo' : '‚è≥ Pendiente'}
                    </div>
                `;
                grid.appendChild(photoItem);
            });
            
            updatePhotoCounts();
        }

        function handlePhotoCapture(typeId, input) {
            const files = Array.from(input.files);
            if (!reportData.photos[typeId]) {
                reportData.photos[typeId] = [];
            }
            
            files.forEach(file => {
                // Verificar espacio antes de agregar foto
                const currentSize = checkStorageSpace();
                if (parseFloat(currentSize) > 4.5) {
                    showNotification('Almacenamiento casi lleno. Limpiando fotos antiguas...', 'info');
                    clearOldPhotos();
                }
                
                // Compress image before saving - m√°s agresivo
                compressImage(file, 400, 0.5, (compressedDataUrl) => {
                    try {
                        reportData.photos[typeId].push({
                            data: compressedDataUrl,
                            timestamp: new Date().toISOString(),
                            name: file.name
                        });
                        updatePhotoPreview(typeId);
                        updatePhotoCounts();
                        saveCurrentStep();
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            showNotification('Almacenamiento lleno. Use "Limpiar datos" primero.', 'error');
                        }
                    }
                });
            });
        }

        // Image compression function - MEJORADA para reducir tama√±o
        function compressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Reducir m√°s agresivamente el tama√±o
                    const maxSize = 400; // Reducido de 800 a 400
                    if (width > height) {
                        if (width > maxSize) {
                            height = (maxSize / width) * height;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (maxSize / height) * width;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Comprimir m√°s agresivamente
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5); // Reducido de 0.7 a 0.5
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updatePhotoPreview(typeId) {
            const previewDiv = document.getElementById(`preview_${typeId}`);
            const photos = reportData.photos[typeId] || [];
            
            previewDiv.innerHTML = photos.map((photo, index) => `
                <img src="${photo.data}" class="photo-preview" alt="Photo ${index + 1}" style="width: 100px; height: 100px; object-fit: cover; margin: 5px;">
            `).join('');
        }

        function updatePhotoCounts() {
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                const countSpan = document.getElementById(`count_${type.id}`);
                const statusDiv = document.getElementById(`status_${type.id}`);
                
                if (countSpan) {
                    countSpan.textContent = photos.length;
                }
                
                if (statusDiv) {
                    if (photos.length >= type.required) {
                        statusDiv.className = 'photo-status complete';
                        statusDiv.textContent = '‚úì Completo';
                    } else {
                        statusDiv.className = 'photo-status pending';
                        statusDiv.textContent = '‚è≥ Pendiente';
                    }
                }
            });
        }

        // Review Functions
        function updateReview() {
            // Site Review
            const siteReview = document.getElementById('siteReview');
            siteReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Site ID:</span>
                    <span class="review-value">${reportData.basic.siteId || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Site Name:</span>
                    <span class="review-value">${reportData.basic.siteName || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Team Leader:</span>
                    <span class="review-value">${reportData.basic.teamLeader || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">GPS Location:</span>
                    <span class="review-value">${reportData.gps.latitude ? `${reportData.gps.latitude.toFixed(6)}, ${reportData.gps.longitude.toFixed(6)}` : 'N/A'}</span>
                </div>
            `;
            
            // Equipment Review
            const equipmentReview = document.getElementById('equipmentReview');
            equipmentReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Radios:</span>
                    <span class="review-value">${reportData.basic.radiosInstalled || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Antennas:</span>
                    <span class="review-value">${reportData.basic.antennasInstalled || 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Equipment Items:</span>
                    <span class="review-value">${reportData.appurtenances.length} tipos</span>
                </div>
            `;
            
            // Photo Review
            const photoReview = document.getElementById('photoReview');
            let totalPhotos = 0;
            let completedTypes = 0;
            
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                totalPhotos += photos.length;
                if (photos.length >= type.required) {
                    completedTypes++;
                }
            });
            
            photoReview.innerHTML = `
                <div class="review-item">
                    <span class="review-label">Total de fotos:</span>
                    <span class="review-value">${totalPhotos}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Categor√≠as completas:</span>
                    <span class="review-value">${completedTypes} de ${photoTypes.length}</span>
                </div>
            `;
        }

        // Funci√≥n para enviar a SharePoint via Power Automate - CON FOTOS Y APPURTENANCES
        async function sendToSharePoint(reportData) {
            // URL de Power Automate ACTUALIZADA
            const POWER_AUTOMATE_URL = 'https://prod-19.westus.logic.azure.com:443/workflows/1170c524ac7e4e9c98e817550c91f1d0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JdS7ZO75Zm5eCaImMEoyGfDp3qzLUlNYLlo1J_dHGjE';
            
            // Generar ID √∫nico para este reporte espec√≠fico
            const timestamp = Date.now();
            const uniqueReportID = `RPT-${reportData.basic.siteId}-${timestamp}`;
            
            // Preparar datos para enviar - INCLUYENDO FOTOS Y APPURTENANCES
            const dataToSend = {
                submittedBy: reportData.basic.submittedBy || 'Field Technician',
                submissionTimestamp: new Date().toISOString(),
                reportID: uniqueReportID,
                siteId: reportData.basic.siteId || '',
                siteName: reportData.basic.siteName || '',
                customerSiteId: reportData.basic.customerSiteId || '',
                customerSiteName: reportData.basic.customerSiteName || '',
                radiosInstalled: reportData.basic.radiosInstalled || '0',
                antennasInstalled: reportData.basic.antennasInstalled || '0',
                teamLeader: reportData.basic.teamLeader || '',
                towerTop: reportData.basic.towerTop || 'no',
                completionDate: reportData.basic.completionDate || '',
                tpTenant: reportData.basic.tpTenant || '',
                latitude: reportData.gps.latitude || 0,
                longitude: reportData.gps.longitude || 0,
                appurtenances: reportData.appurtenances || [],
                photos: reportData.photos || {}
            };
            
            try {
                console.log('üöÄ Enviando a Power Automate...');
                console.log('üìç URL:', POWER_AUTOMATE_URL);
                console.log('üì¶ Datos a enviar (sin fotos en log):', {
                    ...dataToSend,
                    photos: `${Object.keys(dataToSend.photos).length} categor√≠as de fotos`
                });
                console.log('üÜî Report ID √∫nico:', uniqueReportID);
                
                const response = await fetch(POWER_AUTOMATE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                console.log('üìä Response status:', response.status);
                console.log('‚úÖ Response ok:', response.ok);
                
                if (response.ok) {
                    const responseText = await response.text();
                    console.log('‚úÖ Response body:', responseText);
                    console.log('‚úÖ Enviado exitosamente a SharePoint');
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', response.status, response.statusText);
                    console.error('‚ùå Error body:', errorText);
                    
                    if (response.status === 400 && errorText.includes('duplicate')) {
                        console.error('‚ùå Error: Campo duplicado detectado');
                        showNotification('Error: Verifica configuraci√≥n de campos √∫nicos en SharePoint', 'error');
                    } else if (response.status === 401) {
                        showNotification('Error 401: Verifica la configuraci√≥n del flow', 'error');
                    } else {
                        showNotification(`Error ${response.status}: ${response.statusText}`, 'error');
                    }
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Network/Connection error:', error);
                showNotification('Error de conexi√≥n. Verifica tu internet.', 'error');
                return false;
            }
        }

        // Submit Functions - RESTAURADA para usar SharePoint
        async function submitReport() {
            const submitBtn = event.target;
            const statusDiv = document.getElementById('submitStatus');
            
            submitBtn.disabled = true;
            statusDiv.innerHTML = '<div class="spinner"></div><p>Enviando reporte a SharePoint...</p>';
            
            try {
                // Save report locally first
                const reportId = `RPT-${reportData.basic.siteId}-${Date.now()}`;
                localStorage.setItem(reportId, JSON.stringify(reportData));
                
                // Enviar a SharePoint
                const sentToSharePoint = await sendToSharePoint(reportData);
                
                if (sentToSharePoint) {
                    // √âxito - enviado a SharePoint
                    statusDiv.innerHTML = `
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 6px; text-align: left;">
                            <h3 style="color: #2e7d32;">‚úì Reporte Enviado a SharePoint</h3>
                            <p>ID: ${reportId}</p>
                            <p style="margin-top: 15px;">
                                <strong>‚úì Guardado localmente</strong><br>
                                <strong>‚úì Enviado a SharePoint</strong>
                            </p>
                            <button class="btn btn-success" onclick="startNewReport()" style="margin-top: 10px;">
                                Crear Nuevo Reporte
                            </button>
                        </div>
                    `;
                } else {
                    // Fallo al enviar a SharePoint - pero guardado localmente
                    statusDiv.innerHTML = `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 6px; text-align: left;">
                            <h3 style="color: #856404;">‚ö†Ô∏è Guardado Solo Localmente</h3>
                            <p>ID: ${reportId}</p>
                            <p style="margin-top: 15px;">
                                El reporte se guard√≥ en el dispositivo pero no se pudo enviar a SharePoint.
                                <br><strong>Revisa la consola del navegador (F12) para m√°s detalles.</strong>
                            </p>
                            <button class="btn btn-primary" onclick="retrySharePoint('${reportId}')">
                                üîÑ Reintentar Env√≠o
                            </button>
                            <button class="btn btn-secondary" onclick="downloadReport('${reportId}')" style="margin-left: 10px;">
                                üì• Descargar JSON
                            </button>
                            <button class="btn btn-success" onclick="startNewReport()" style="margin-left: 10px;">
                                ‚ûï Nuevo Reporte
                            </button>
                        </div>
                    `;
                }
                
                submitBtn.disabled = false;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="background: #ffebee; padding: 20px; border-radius: 6px;">
                        <h3 style="color: #c62828;">Error al guardar</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            Recargar P√°gina
                        </button>
                    </div>
                `;
                submitBtn.disabled = false;
            }
        }

        // Funci√≥n para reintentar env√≠o a SharePoint
        async function retrySharePoint(reportId) {
            const savedData = localStorage.getItem(reportId);
            if (savedData) {
                const data = JSON.parse(savedData);
                const statusDiv = document.getElementById('submitStatus');
                
                statusDiv.innerHTML = '<div class="spinner"></div><p>Reintentando env√≠o...</p>';
                
                const sent = await sendToSharePoint(data);
                
                if (sent) {
                    statusDiv.innerHTML = `
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 6px;">
                            <h3 style="color: #2e7d32;">‚úì Enviado Exitosamente</h3>
                            <p>El reporte se envi√≥ a SharePoint.</p>
                            <button class="btn btn-success" onclick="startNewReport()">
                                Crear Nuevo Reporte
                            </button>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="background: #ffebee; padding: 20px; border-radius: 6px;">
                            <h3 style="color: #c62828;">Error al enviar</h3>
                            <p>No se pudo conectar con SharePoint. Verifique su conexi√≥n.</p>
                            <button class="btn btn-primary" onclick="retrySharePoint('${reportId}')">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        // La funci√≥n downloadReport
        function downloadReport(reportId) {
            const data = localStorage.getItem(reportId);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Funci√≥n para iniciar nuevo reporte
        function startNewReport() {
            // Clear current report data but keep localStorage for submitted reports
            reportData = {
                basic: {},
                gps: {},
                appurtenances: [],
                photos: {}
            };
            
            // Clear form fields
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type === 'date') {
                    field.value = new Date().toISOString().split('T')[0];
                } else if (field.id === 'appQuantity') {
                    field.value = '1';
                } else {
                    field.value = '';
                }
            });
            
            // Reset to first step
            currentStep = 1;
            showStep(1);
            
            // Clear status displays
            document.getElementById('gpsStatus').innerHTML = '';
            document.getElementById('appurtenanceList').innerHTML = '';
            
            // Regenerate photo grid
            generatePhotoGrid();
            
            showNotification('Nuevo reporte iniciado', 'success');
        }

        // Add skip validation function for testing
        function skipPhotoValidation() {
            // Add dummy photos for testing
            photoTypes.forEach(type => {
                if (!reportData.photos[type.id]) {
                    reportData.photos[type.id] = [];
                }
                // Add dummy photo data
                reportData.photos[type.id].push({
                    data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    timestamp: new Date().toISOString(),
                    name: 'demo_photo.png'
                });
            });
            
            updatePhotoCounts();
            saveCurrentStep();
            showNotification('Fotos de demostraci√≥n agregadas. Ahora puede continuar.', 'success');
        }

        // Notification function
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // FUNCI√ìN PARA GENERAR PDF - NUEVA FUNCI√ìN AGREGADA
        async function generateTowerReportPDF() {
            if (!window.jspdf || !reportData) {
                showNotification('‚ùå No se puede generar PDF en este momento', 'error');
                return false;
            }

            try {
                showNotification('üìÑ Generando PDF...', 'info');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                let currentY = 20;

                // Header de la empresa (igual que tu reporte HTML)
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text('PO Box 4116', pageWidth - 15, 15, { align: 'right' });
                pdf.text('Vega Baja PR 00694', pageWidth - 15, 20, { align: 'right' });
                pdf.text('t. 787-718-2600', pageWidth - 15, 25, { align: 'right' });
                pdf.text('accounting@newcomm2000.com', pageWidth - 15, 30, { align: 'right' });

                // Logo NEWCOMM
                pdf.setFontSize(24);
                pdf.setTextColor(0, 102, 204);
                pdf.setFont(undefined, 'bold');
                pdf.text('NEWCOMM', pageWidth / 2, 45, { align: 'center' });
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('MANAGEMENT SERVICES CORP.', pageWidth / 2, 52, { align: 'center' });

                // T√≠tulo del reporte
                currentY = 70;
                pdf.setFontSize(20);
                pdf.setTextColor(0, 102, 204);
                pdf.setFont(undefined, 'bold');
                pdf.text('TOWER PROVIDER REPORT', pageWidth / 2, currentY, { align: 'center' });
                
                currentY += 15;

                // Informaci√≥n de env√≠o
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont(undefined, 'normal');
                const basic = reportData.basic || {};
                const submissionDate = new Date().toLocaleString();
                pdf.text(`Submitted by: ${basic.submittedBy || 'Field Tech'}`, 15, currentY);
                pdf.text(`Submission: ${submissionDate}`, 15, currentY + 5);
                pdf.text(`Report ID: RPT-${basic.siteId}-${Date.now()}`, 15, currentY + 10);
                
                currentY += 25;

                // SECCI√ìN: SITE INFORMATION
                pdf.setFontSize(14);
                pdf.setTextColor(0, 102, 204);
                pdf.setFont(undefined, 'bold');
                pdf.text('SITE INFORMATION', 15, currentY);
                currentY += 10;

                // Site Information
                pdf.setFontSize(9);
                pdf.setTextColor(0, 0, 0);
                
                const addInfo = (label, value, isLeft = true) => {
                    const x = isLeft ? 15 : pageWidth / 2 + 10;
                    pdf.setFont(undefined, 'bold');
                    pdf.text(label + ':', x, currentY);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(String(value || 'N/A'), x, currentY + 4);
                    if (!isLeft) currentY += 12;
                };

                addInfo('Tower Provider Site ID', basic.siteId, true);
                addInfo('Tower Provider Site Name', basic.siteName, false);
                addInfo('Customer Site ID', basic.customerSiteId, true);
                addInfo('Customer Site Name', basic.customerSiteName, false);

                // SECCI√ìN: INSTALLATION DETAILS
                currentY += 10;
                pdf.setFontSize(14);
                pdf.setTextColor(0, 102, 204);
                pdf.setFont(undefined, 'bold');
                pdf.text('INSTALLATION DETAILS', 15, currentY);
                currentY += 10;

                addInfo('Radios Installed', basic.radiosInstalled, true);
                addInfo('Antennas Installed', basic.antennasInstalled, false);
                addInfo('Team Leader', basic.teamLeader, true);
                addInfo('Tower Top Installation', basic.towerTop, false);
                addInfo('Completion Date', basic.completionDate, true);
                addInfo('TP Tenant', basic.tpTenant, false);

                // SECCI√ìN: GPS LOCATION
                currentY += 10;
                const gps = reportData.gps || {};
                pdf.setFontSize(14);
                pdf.setTextColor(0, 102, 204);
                pdf.setFont(undefined, 'bold');
                pdf.text('üó∫Ô∏è GPS LOCATION', 15, currentY);
                currentY += 10;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Latitude: ${gps.latitude || 0}`, 15, currentY);
                pdf.text(`Longitude: ${gps.longitude || 0}`, 15, currentY + 5);
                pdf.text(`Google Maps: https://www.google.com/maps?q=${gps.latitude},${gps.longitude}`, 15, currentY + 10);
                currentY += 20;

                // SECCI√ìN: EQUIPMENT INSTALLED
                if (reportData.appurtenances && reportData.appurtenances.length > 0) {
                    currentY += 10;
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 102, 204);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('APPURTENANCE INFORMATION', 15, currentY);
                    currentY += 10;

                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    reportData.appurtenances.forEach((app, index) => {
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`${index + 1}. ${app.type || 'Equipment'}`, 20, currentY);
                        pdf.setFont(undefined, 'normal');
                        pdf.text(`Manufacturer: ${app.manufacturer || 'N/A'}`, 25, currentY + 4);
                        pdf.text(`Model: ${app.model || 'N/A'}`, 25, currentY + 8);
                        pdf.text(`Quantity: ${app.quantity || 'N/A'}`, 25, currentY + 12);
                        currentY += 18;
                    });
                }

                // SECCI√ìN: PHOTO DOCUMENTATION
                currentY += 10;
                if (reportData.photos && Object.keys(reportData.photos).length > 0) {
                    let totalPhotos = 0;
                    Object.values(reportData.photos).forEach(photoArray => {
                        totalPhotos += photoArray.length;
                    });

                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 102, 204);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`üì∏ PHOTO DOCUMENTATION (${totalPhotos} photos captured)`, 15, currentY);
                    currentY += 10;

                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    Object.keys(reportData.photos).forEach(category => {
                        const photos = reportData.photos[category];
                        if (photos && photos.length > 0) {
                            const categoryName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            pdf.setFont(undefined, 'bold');
                            pdf.text(`‚Ä¢ ${categoryName}:`, 20, currentY);
                            pdf.setFont(undefined, 'normal');
                            pdf.text(`${photos.length} photos captured`, 80, currentY);
                            currentY += 6;
                        }
                    });
                }

                // Footer
                currentY += 20;
                pdf.setFontSize(10);
                pdf.setTextColor(0, 102, 204);
                pdf.setFont(undefined, 'bold');
                pdf.text('Newcomm Management Services Corp.', pageWidth / 2, currentY, { align: 'center' });
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.setFont(undefined, 'normal');
                pdf.text('PO Box 4116, Vega Baja PR 00694 | Phone: 787-718-2600', pageWidth / 2, currentY + 5, { align: 'center' });
                pdf.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, currentY + 10, { align: 'center' });

                // Generar nombre del archivo
                const timestamp = new Date().toISOString().slice(0, 10);
                const siteId = basic.siteId || 'Site';
                const filename = `Tower_Report_${siteId}_${timestamp}.pdf`;

                // Guardar PDF
                pdf.save(filename);
                
                showNotification(`‚úÖ PDF generado: ${filename}`, 'success');
                return true;

            } catch (error) {
                console.error('Error generando PDF:', error);
                showNotification('‚ùå Error al generar PDF: ' + error.message, 'error');
                return false;
            }
        }
    </script>
</body>
</html>
