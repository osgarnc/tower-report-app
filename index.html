<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0066cc">
<meta name="author" content="Newcomm Management Services Corp.">
<meta name="copyright" content="Â© 2025 Newcomm Management Services Corp.">
<meta name="description" content="Tower Provider Report - Professional Mobile Application">
<title>Tower Report Mobile v9.30 - SharePoint Auth</title>

<!-- MSAL.js desde CDN -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background-color: #f5f5f5;
    color: #333;
    overflow-x: hidden;
}

.app-container {
    max-width: 600px;
    margin: 0 auto;
    background-color: white;
    min-height: 100vh;
    position: relative;
}

/* Login Screen */
.login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
    color: white;
}

.login-container {
    background: white;
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    max-width: 400px;
    width: 100%;
    text-align: center;
}

.login-logo {
    width: 150px;
    margin-bottom: 30px;
}

.login-title {
    color: #333;
    font-size: 24px;
    margin-bottom: 10px;
}

.login-subtitle {
    color: #666;
    font-size: 14px;
    margin-bottom: 30px;
}

.login-btn {
    background-color: #0066cc;
    color: white;
    padding: 15px 30px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
}

.login-btn:hover {
    background-color: #0052a3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,102,204,0.3);
}

.login-error {
    background-color: #ffebee;
    color: #c62828;
    padding: 10px;
    border-radius: 6px;
    margin-top: 20px;
    font-size: 14px;
}

.login-info {
    background-color: #e3f2fd;
    color: #1565c0;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 14px;
    text-align: left;
}

.user-info {
    background-color: #e3f2fd;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

.user-info strong {
    color: #1565c0;
}

.logout-btn {
    background-color: #f44336;
    color: white;
    padding: 5px 15px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
}

/* Header */
.header {
    background-color: #0066cc;
    color: white;
    padding: 15px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 20px;
    font-weight: 500;
}

.step-indicator {
    display: flex;
    justify-content: center;
    padding: 20px;
    gap: 10px;
}

.step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s;
}

.step.active {
    background-color: #0066cc;
    color: white;
}

.step.completed {
    background-color: #4caf50;
    color: white;
}

/* Form Sections */
.form-section {
    display: none;
    padding: 20px;
    animation: slideIn 0.3s ease-out;
}

.form-section.active {
    display: block;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
}

input[type="text"],
input[type="number"],
input[type="date"],
select,
textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: #0066cc;
}

.required {
    color: #f44336;
}

/* Equipment Requirements Notice */
.equipment-requirements {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 14px;
}

.equipment-requirements h4 {
    margin-bottom: 10px;
    color: #856404;
}

.equipment-requirements ul {
    margin-left: 20px;
    margin-bottom: 0;
}

.equipment-requirements li {
    margin-bottom: 5px;
}

/* Buttons */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    display: inline-block;
}

.btn-primary {
    background-color: #0066cc;
    color: white;
}

.btn-primary:hover {
    background-color: #0052a3;
}

.btn-success {
    background-color: #4caf50;
    color: white;
}

.btn-secondary {
    background-color: #757575;
    color: white;
}

.btn-danger {
    background-color: #f44336;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-block {
    width: 100%;
    display: block;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

/* GPS Status */
.gps-status {
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 14px;
}

.gps-status.success {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.gps-status.error {
    background-color: #ffebee;
    color: #c62828;
}

.gps-status.warning {
    background-color: #fff3cd;
    color: #856404;
}

/* Appurtenance List */
.appurtenance-list {
    margin-top: 20px;
}

.appurtenance-item {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.appurtenance-info h4 {
    margin: 0 0 5px 0;
    color: #0066cc;
}

.appurtenance-info p {
    margin: 0;
    font-size: 14px;
    color: #666;
}

.equipment-counter {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.equipment-counter h4 {
    color: #1565c0;
    margin-bottom: 10px;
}

.counter-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
}

.counter-item.complete {
    color: #2e7d32;
}

.counter-item.incomplete {
    color: #f44336;
}

/* Photo Section */
.photo-requirements {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.photo-requirements h3 {
    margin-bottom: 10px;
    color: #1565c0;
}

.photo-requirements ul {
    margin-left: 20px;
}

.photo-grid {
    display: grid;
    gap: 15px;
}

.photo-item {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
}

.photo-item h4 {
    margin-bottom: 10px;
    color: #333;
    font-size: 16px;
}

.photo-capture {
    position: relative;
    margin-bottom: 10px;
}

.camera-input {
    display: none;
}

.camera-btn {
    background-color: #0066cc;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 10px;
    margin-bottom: 10px;
}

.camera-btn:hover {
    background-color: #0052a3;
}

.gallery-btn {
    background-color: #4caf50;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.gallery-btn:hover {
    background-color: #388e3c;
}

.photo-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
}

.photo-preview-item {
    position: relative;
    display: inline-block;
}

.photo-preview {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.photo-delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.photo-delete-btn:hover {
    background-color: #d32f2f;
}

.photo-count {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.photo-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 5px;
}

.photo-status.complete {
    background-color: #4caf50;
    color: white;
}

.photo-status.pending {
    background-color: #ff9800;
    color: white;
}

/* Estilos para las secciones de sectores */
.sector-photo-section {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #0066cc;
}

.sector-photo-section h4 {
    color: #0066cc;
    margin-bottom: 15px;
    font-size: 18px;
}

/* Review Section */
.review-section {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.review-section h3 {
    margin-bottom: 10px;
    color: #0066cc;
}

.review-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #e0e0e0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-label {
    font-weight: 500;
    color: #666;
}

.review-value {
    color: #333;
}

/* Loading Spinner */
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #0066cc;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Notifications */
.notification {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translate(-50%, -20px);
    }
    to {
        opacity: 1;
        transform: translate(-50%, 0);
    }
}

.notification.success {
    background-color: #4caf50;
}

.notification.error {
    background-color: #f44336;
}

.notification.info {
    background-color: #2196f3;
}

/* Copyright Footer */
.copyright-footer {
    text-align: center;
    padding: 20px;
    font-size: 12px;
    color: #999;
    border-top: 1px solid #eee;
    margin-top: 40px;
}

/* Dynamic Sectors Styles */
.sectors-info {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.sectors-info h4 {
    color: #1565c0;
    margin-bottom: 10px;
}

.sector-tape-inputs {
    display: grid;
    gap: 10px;
    margin-top: 10px;
}

/* Report Search Styles */
.report-search-container {
    padding: 20px;
    background: #f5f5f5;
    border-radius: 8px;
    margin: 20px 0;
}

/* Responsive */
@media (max-width: 480px) {
    .header h1 {
        font-size: 18px;
    }
    
    .btn {
        font-size: 14px;
        padding: 10px 20px;
    }
    
    .photo-preview {
        width: 60px;
        height: 60px;
    }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-container">
        <h2 class="login-title">Tower Provider Report</h2>
        <p class="login-subtitle">Inicie sesiÃ³n con su cuenta de Microsoft 365</p>
        
        <button class="login-btn" onclick="signIn()">
            <svg width="20" height="20" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
                <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
                <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
            </svg>
            Iniciar sesiÃ³n con Microsoft
        </button>
        
        <div id="loginError" style="display: none;" class="login-error"></div>
        
        <div style="margin-top: 20px; font-size: 12px; color: #666;">
            <p>VersiÃ³n 9.30 - BÃºsqueda y EdiciÃ³n de Reportes</p>
        </div>
    </div>
</div>

<!-- Main App (Hidden until authenticated) -->
<div id="mainApp" class="app-container" style="display: none;">
    <div class="user-info">
        <span>Usuario: <strong id="userDisplayName">-</strong></span>
        <div>
            <button class="btn btn-secondary" onclick="showReportSearch()" style="margin-right: 10px; padding: 5px 15px; font-size: 12px;">
                ð Buscar
            </button>
            <button class="logout-btn" onclick="signOut()">Cerrar SesiÃ³n</button>
        </div>
    </div>
    
    <header class="header">
        <h1>Tower Provider Report</h1>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">VersiÃ³n 9.30 - BÃºsqueda y EdiciÃ³n</div>
    </header>
    
    <div class="step-indicator">
        <div class="step active" id="step1">1</div>
        <div class="step" id="step2">2</div>
        <div class="step" id="step3">3</div>
        <div class="step" id="step4">4</div>
        <div class="step" id="step5">5</div>
    </div>
    
    <!-- Step 1: Basic Information -->
    <div class="form-section active" id="section1">
        <h2>InformaciÃ³n BÃ¡sica</h2>
        
        <!-- Storage management -->
        <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Espacio usado: <span id="storageIndicator">calculando...</span></span>
                <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 5px 10px;">
                    Limpiar datos
                </button>
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">App v9.30 - BÃºsqueda y EdiciÃ³n</div>
        </div>
        
        <div class="form-group">
            <label>Tower Provider Site ID <span class="required">*</span></label>
            <input type="text" id="siteId" placeholder="ej: 10028307" required>
        </div>
        
        <div class="form-group">
            <label>Tower Provider Site Name <span class="required">*</span></label>
            <input type="text" id="siteName" placeholder="ej: Vega Baja DT" required>
        </div>
        
        <div class="form-group">
            <label>Customer Site ID <span class="required">*</span></label>
            <input type="text" id="customerSiteId" placeholder="ej: 10028307" required>
        </div>
        
        <div class="form-group">
            <label>Customer Site Name <span class="required">*</span></label>
            <input type="text" id="customerSiteName" placeholder="ej: Vega Baja DT" required>
        </div>
        
        <!-- Nueva secciÃ³n para cantidad de sectores -->
        <div class="form-group" style="background: #e3f2fd; padding: 15px; border-radius: 6px;">
            <label>Number of Sectors <span class="required">*</span></label>
            <select id="sectorsCount" required onchange="updateSectorRequirements()">
                <option value="">Seleccione cantidad de sectores</option>
                <option value="1">1 Sector</option>
                <option value="2">2 Sectores</option>
                <option value="3">3 Sectores</option>
                <option value="4">4 Sectores</option>
                <option value="5">5 Sectores</option>
                <option value="6">6 Sectores</option>
            </select>
            <p style="font-size: 12px; color: #1565c0; margin-top: 10px;">
                La cantidad de sectores determinarÃ¡ las mediciones de tape drop y fotos requeridas
            </p>
        </div>
        
        <div class="form-group">
            <label>Radios Installed <span class="required">*</span></label>
            <input type="number" id="radiosInstalled" min="0" placeholder="3" required onchange="updateEquipmentRequirements()">
        </div>
        
        <div class="form-group">
            <label>Antennas Installed <span class="required">*</span></label>
            <input type="number" id="antennasInstalled" min="0" placeholder="6" required onchange="updateEquipmentRequirements()">
        </div>
        
        <div class="form-group">
            <label>Cables Installed <span class="required">*</span></label>
            <input type="number" id="cablesInstalled" min="0" placeholder="12" required onchange="updateEquipmentRequirements()">
        </div>
        
        <div class="form-group">
            <label>Team Leader <span class="required">*</span></label>
            <input type="text" id="teamLeader" placeholder="ej: Christopher Rodriguez" required>
        </div>
        
        <div class="form-group">
            <label>Tower Top Installation <span class="required">*</span></label>
            <select id="towerTop" required onchange="updateMeasurementRequirements()">
                <option value="">Seleccione una opciÃ³n</option>
                <option value="yes">Yes - At Tower Top</option>
                <option value="near-top">Near Top (Within 10' of top)</option>
                <option value="no">No - Below 10' from top</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Completion Date <span class="required">*</span></label>
            <input type="date" id="completionDate" required>
        </div>
        
        <!-- GPS Section - Now Required -->
        <div style="background: #ffebee; padding: 15px; border-radius: 6px; margin-top: 20px; margin-bottom: 20px;">
            <h3 style="color: #c62828; margin-bottom: 10px;">ð UbicaciÃ³n GPS (OBLIGATORIO)</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                La ubicaciÃ³n GPS es <strong>obligatoria</strong> para continuar.
            </p>
            <button class="btn btn-primary" onclick="getGPSLocation()">
                ð Capturar GPS AutomÃ¡tico
            </button>
            <button class="btn btn-secondary" onclick="showManualGPS()" style="margin-left: 10px;">
                âï¸ Ingresar Manual
            </button>
            <div id="gpsStatus" style="margin-top: 15px;"></div>
        </div>
        
        <!-- Mediciones Section - OBLIGATORIO para todos los sectores -->
        <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <h3 style="color: #1565c0; margin-bottom: 10px;">ð Mediciones (OBLIGATORIO)</h3>
            
            <!-- Sector Tape Drops - DinÃ¡mico segÃºn cantidad -->
            <div id="sectorTapeDrops">
                <p style="text-align: center; color: #666;">Seleccione la cantidad de sectores para ver los campos de tape drop</p>
            </div>
            
            <!-- Tower Height y Tallest Point - Condicional -->
            <div id="towerMeasurements" style="margin-top: 20px;">
                <h4 style="color: #1565c0; margin-bottom: 10px;">Tower Measurements</h4>
                <p id="heightRequirementText" style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Seleccione "Tower Top Installation" para ver requisitos
                </p>
                <div class="form-group">
                    <label>Tower Height <span class="required" id="towerHeightRequired" style="display: none;">*</span></label>
                    <input type="number" id="towerHeight" placeholder="Feet" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Tallest Point <span class="required" id="tallestPointRequired" style="display: none;">*</span></label>
                    <input type="number" id="tallestPoint" placeholder="Feet" min="0" step="0.1">
                </div>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 2: Appurtenance Information -->
    <div class="form-section" id="section2">
        <h2>InformaciÃ³n de Equipos</h2>
        
        <!-- Equipment Requirements Alert -->
        <div class="equipment-requirements" id="equipmentRequirements" style="display: none;">
            <h4>â ï¸ Requisitos de Equipos</h4>
            <ul id="requirementsList"></ul>
        </div>
        
        <!-- Equipment Counter -->
        <div class="equipment-counter">
            <h4>Contador de Equipos</h4>
            <div id="equipmentCounter"></div>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="showAppurtenanceForm()">
            + Agregar Equipo
        </button>
        
        <div id="appurtenanceForm" style="display: none; margin-top: 20px;">
            <div class="form-group">
                <label>Type</label>
                <select id="appType">
                    <option value="Antenna">Antenna</option>
                    <option value="Radio">Radio</option>
                    <option value="Cable">Cable</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Rad Center</label>
                <input type="text" id="appRadCenter" placeholder="50">
            </div>
            
            <div class="form-group">
                <label>Manufacturer</label>
                <input type="text" id="appManufacturer" placeholder="ej: Ericsson">
            </div>
            
            <div class="form-group">
                <label>Model</label>
                <input type="text" id="appModel" placeholder="ej: 840590003">
            </div>
            
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="appQuantity" min="1" value="1">
            </div>
            
            <div class="form-group">
                <label>Coax Size</label>
                <select id="appCoaxSize">
                    <option value="N/A">N/A</option>
                    <option value="7/8">7/8</option>
                    <option value="1 5/8">1 5/8</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="addAppurtenance()">Guardar</button>
            <button class="btn btn-secondary" onclick="cancelAppurtenance()">Cancelar</button>
        </div>
        
        <div class="appurtenance-list" id="appurtenanceList"></div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
            <button class="btn btn-primary" onclick="nextStep()">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 3: Photo Documentation -->
    <div class="form-section" id="section3">
        <h2>DocumentaciÃ³n FotogrÃ¡fica</h2>
        
        <div class="photo-requirements">
            <h3>ð¸ Fotos Requeridas</h3>
            <ul>
                <li>Las fotos se organizan por categorÃ­as y sectores</li>
                <li>Cada sector tiene su propia secciÃ³n de fotos</li>
                <li>Puede tomar fotos con la cÃ¡mara o seleccionar desde la galerÃ­a</li>
                <li>Puede eliminar fotos individuales si se equivoca</li>
                <li>Las fotos se guardan automÃ¡ticamente</li>
            </ul>
        </div>
        
        <div class="photo-grid" id="photoGrid">
            <!-- Photo items will be generated by JavaScript dynamically -->
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
            <button class="btn btn-primary" onclick="nextStep()">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 4: Review -->
    <div class="form-section" id="section4">
        <h2>Revisar InformaciÃ³n</h2>
        
        <div class="review-section">
            <h3>InformaciÃ³n BÃ¡sica</h3>
            <div id="basicReview"></div>
        </div>
        
        <div class="review-section">
            <h3>GPS</h3>
            <div id="gpsReview"></div>
        </div>
        
        <div class="review-section">
            <h3>Equipos</h3>
            <div id="equipmentReview"></div>
        </div>
        
        <div class="review-section">
            <h3>Mediciones</h3>
            <div id="measurementsReview"></div>
        </div>
        
        <div class="review-section">
            <h3>Fotos</h3>
            <div id="photoReview"></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
            <button class="btn btn-primary" onclick="nextStep()">
                Continuar â
            </button>
        </div>
    </div>
    
    <!-- Step 5: Submit -->
    <div class="form-section" id="section5">
        <h2>Enviar Reporte</h2>
        
        <div style="text-align: center; padding: 40px;">
            <h3 style="color: #0066cc; margin-bottom: 20px;">Â¿Listo para enviar?</h3>
            <p style="margin-bottom: 30px;">
                Se enviarÃ¡ el reporte a SharePoint con toda la informaciÃ³n y fotos capturadas.
            </p>
            <button class="btn btn-success btn-block" onclick="submitReport()" style="font-size: 18px; padding: 15px;">
                ð¤ Enviar a SharePoint
            </button>
        </div>
        
        <div id="submitStatus"></div>
    </div>
    
    <div class="copyright-footer">
        <p>Â© 2025 Newcomm Management Services Corp.</p>
        <p>PO Box 4116, Vega Baja PR 00694</p>
        <p>v9.30 - BÃºsqueda y EdiciÃ³n de Reportes</p>
    </div>
</div>

<script>
// MSAL Configuration
const msalConfig = {
    auth: {
        clientId: '893a922e-fe91-48cd-a14e-c0ed5c47c89e',
        authority: 'https://login.microsoftonline.com/f7e7f3f0-3647-48aa-8709-c96797c88b86',
        redirectUri: window.location.origin
    },
    cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: true
    }
};

const loginRequest = {
    scopes: ['user.read', 'openid', 'profile', 'email']
};

let msalInstance;
let currentAccount = null;

// Initialize MSAL
window.addEventListener('load', async () => {
    msalInstance = new msal.PublicClientApplication(msalConfig);
    
    try {
        const response = await msalInstance.handleRedirectPromise();
        if (response && response.account) {
            currentAccount = response.account;
            showMainApp();
        } else {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentAccount = accounts[0];
                showMainApp();
            }
        }
    } catch (error) {
        console.error('Error handling redirect:', error);
        showLoginError('Error al procesar la autenticaciÃ³n. Por favor, intente nuevamente.');
    }
    
    updateStorageIndicator();
    setInterval(updateStorageIndicator, 5000);
});

// Authentication Functions
async function signIn() {
    try {
        await msalInstance.loginRedirect(loginRequest);
    } catch (error) {
        console.error('Login error:', error);
        showLoginError('Error al iniciar sesiÃ³n. Por favor, intente nuevamente.');
    }
}

async function signOut() {
    try {
        await msalInstance.logoutRedirect({
            account: currentAccount
        });
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/';
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showMainApp() {
    if (currentAccount) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userDisplayName').textContent = 
            currentAccount.name || currentAccount.username || 'Usuario';
        
        // Initialize report data with user info
        reportData.metadata.submittedBy = currentAccount.name || 'Unknown User';
        reportData.metadata.submittedByEmail = currentAccount.username || 'unknown@email.com';
        reportData.basic.submittedBy = currentAccount.name || 'Unknown User';
        reportData.basic.submittedByEmail = currentAccount.username || 'unknown@email.com';
        
        // Load saved data if exists
        loadSavedData();
    }
}

// Global Variables
let currentStep = 1;
let reportData = {
    basic: {},
    gps: {},
    appurtenances: [],
    photos: {},
    measurements: {},
    metadata: {
        appVersion: '9.30',
        deviceInfo: navigator.userAgent,
        createdAt: new Date().toISOString()
    }
};

let photoTypes = [];

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
});

// Equipment Functions - Update equipment requirements when counts change
function updateEquipmentRequirements() {
    const radios = parseInt(document.getElementById('radiosInstalled').value) || 0;
    const antennas = parseInt(document.getElementById('antennasInstalled').value) || 0;
    const cables = parseInt(document.getElementById('cablesInstalled').value) || 0;
    
    // Update photo types based on equipment
    updatePhotoTypes();
    
    // Update equipment counter
    updateEquipmentCounter();
}

function updateEquipmentCounter() {
    const radios = parseInt(document.getElementById('radiosInstalled').value) || 0;
    const antennas = parseInt(document.getElementById('antennasInstalled').value) || 0;
    const cables = parseInt(document.getElementById('cablesInstalled').value) || 0;
    
    const radioCount = reportData.appurtenances.filter(a => a.type === 'Radio').reduce((sum, a) => sum + parseInt(a.quantity), 0);
    const antennaCount = reportData.appurtenances.filter(a => a.type === 'Antenna').reduce((sum, a) => sum + parseInt(a.quantity), 0);
    const cableCount = reportData.appurtenances.filter(a => a.type === 'Cable').reduce((sum, a) => sum + parseInt(a.quantity), 0);
    
    const counterDiv = document.getElementById('equipmentCounter');
    counterDiv.innerHTML = `
        <div class="counter-item ${radioCount >= radios ? 'complete' : 'incomplete'}">
            <span>Radios</span>
            <span>${radioCount} / ${radios}</span>
        </div>
        <div class="counter-item ${antennaCount >= antennas ? 'complete' : 'incomplete'}">
            <span>Antenas</span>
            <span>${antennaCount} / ${antennas}</span>
        </div>
        <div class="counter-item ${cableCount >= cables ? 'complete' : 'incomplete'}">
            <span>Cables</span>
            <span>${cableCount} / ${cables}</span>
        </div>
    `;
    
    // Show requirements alert if needed
    const requirementsDiv = document.getElementById('equipmentRequirements');
    const requirementsList = document.getElementById('requirementsList');
    
    const missing = [];
    if (radioCount < radios) missing.push(`Faltan ${radios - radioCount} radio(s)`);
    if (antennaCount < antennas) missing.push(`Faltan ${antennas - antennaCount} antena(s)`);
    if (cableCount < cables) missing.push(`Faltan ${cables - cableCount} cable(s)`);
    
    if (missing.length > 0) {
        requirementsList.innerHTML = missing.map(m => `<li>${m}</li>`).join('');
        requirementsDiv.style.display = 'block';
    } else {
        requirementsDiv.style.display = 'none';
    }
}

// Sector Requirements Functions
function updateSectorRequirements() {
    const sectorsCount = parseInt(document.getElementById('sectorsCount').value) || 0;
    const sectorTapeDropsDiv = document.getElementById('sectorTapeDrops');
    
    // Clear existing inputs
    sectorTapeDropsDiv.innerHTML = '';
    
    if (sectorsCount > 0) {
        const gridStyle = sectorsCount <= 3 ? 'grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));' : 'grid-template-columns: 1fr 1fr;';
        
        sectorTapeDropsDiv.innerHTML = `
            <h4 style="color: #1565c0; margin-bottom: 10px;">Tape Drop por Sector (OBLIGATORIO)</h4>
            <div class="sector-tape-inputs" style="display: grid; ${gridStyle} gap: 10px;">
                ${Array.from({length: sectorsCount}, (_, i) => `
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label>Sector ${i + 1} Tape Drop <span class="required">*</span></label>
                        <input type="number" id="sector${i + 1}TapeDrop" placeholder="Feet" required min="0" step="0.1">
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        sectorTapeDropsDiv.innerHTML = '<p style="text-align: center; color: #666;">Seleccione la cantidad de sectores</p>';
    }
    
    // Update photo types when sectors change
    updatePhotoTypes();
}

// Update photo types based on sectors and equipment
function updatePhotoTypes() {
    const sectorsCount = parseInt(document.getElementById('sectorsCount').value) || 0;
    const radiosCount = parseInt(document.getElementById('radiosInstalled').value) || 0;
    const antennasCount = parseInt(document.getElementById('antennasInstalled').value) || 0;
    
    // Reset photo types
    photoTypes = [
        {
            id: 'equipment_room',
            name: 'Post Equipment Room or Pad',
            required: 4, // Siempre 4 fotos como solicitaste
            description: 'Equipment room/pad photos (4 photos required)'
        },
        {
            id: 'cabinet_doors',
            name: 'Cabinet or Shelter Doors',
            required: 2,
            description: 'Open and closed door photos'
        },
        {
            id: 'safety_lines',
            name: 'Safety Lines',
            required: 4,
            description: 'All safety line assemblies'
        }
    ];
    
    // Antenna labels based on antenna count
    if (antennasCount > 0) {
        photoTypes.push({
            id: 'antenna_labels',
            name: 'Antenna Labels',
            required: antennasCount, // DinÃ¡mico segÃºn cantidad de antenas
            description: `Labels for all ${antennasCount} antennas`
        });
    }
    
    // Radio labels based on radio count
    if (radiosCount > 0) {
        photoTypes.push({
            id: 'radio_labels',
            name: 'Radio Labels',
            required: radiosCount, // DinÃ¡mico segÃºn cantidad de radios
            description: `Labels for all ${radiosCount} radios`
        });
    }
    
    // Compound post pictures - 1 per sector from ground
    if (sectorsCount > 0) {
        photoTypes.push({
            id: 'compound_post',
            name: 'Compound Post Pictures',
            required: 4, // siempre 4 fotos
            description: `4 compound post photos (always required)`
        });
    }
    
    // Sectors from ground
    if (sectorsCount > 0) {
        photoTypes.push({
            id: 'sectors_ground',
            name: 'Sectors from Ground',
            required: sectorsCount, // DinÃ¡mico segÃºn cantidad de sectores
            description: `All ${sectorsCount} sectors`
        });
    }
    
    // Crear categorÃ­as individuales para cada sector - Post Pictures
    for (let i = 1; i <= sectorsCount; i++) {
        photoTypes.push({
            id: `sector_${i}_general_view`,
            name: `Sector ${i} - General View from Behind`,
            required: 1,
            description: `General view from behind of Sector ${i}`,
            sectorGroup: true,
            sectorNumber: i,
            photoType: 'general_view'
        });
        photoTypes.push({
            id: `sector_${i}_cables_back`,
            name: `Sector ${i} - Cables Going Back`,
            required: 1,
            description: `Cables going back for Sector ${i}`,
            sectorGroup: true,
            sectorNumber: i,
            photoType: 'cables_back'
        });
        photoTypes.push({
            id: `sector_${i}_sector_view`,
            name: `Sector ${i} - Sector View`,
            required: 1,
            description: `Sector view for Sector ${i}`,
            sectorGroup: true,
            sectorNumber: i,
            photoType: 'sector_view'
        });
    }
    
    // Crear categorÃ­as individuales para tape drop por sector
    for (let i = 1; i <= sectorsCount; i++) {
        photoTypes.push({
            id: `sector_${i}_tapedrop`,
            name: `Sector ${i} - Tape Drop Measurements`,
            required: 2,
            description: `Tape drop measurement photos for Sector ${i} (2 photos required)`,
            tapeDropGroup: true,
            sectorNumber: i
        });
    }
    
    // Tower measurements
    photoTypes.push({
        id: 'tower_measurements',
        name: 'Tower Height Measurements',
        required: 2,
        description: 'Tower and tallest point'
    });
    
    // Beacon photos
    photoTypes.push({
        id: 'beacon',
        name: 'Beacon Photos',
        required: 2,
        description: 'Beacon and label'
    });
    
    // Regenerate photo grid if we're on step 3
    if (currentStep === 3) {
        generatePhotoGrid();
    }
}

// FunciÃ³n para mapear fotos dinÃ¡micamente segÃºn sectores - NUEVA FUNCIONALIDAD v8.0
function mapPhotosForSharePoint(reportData) {
    const sectorsCount = parseInt(reportData.basic.sectorsCount) || 0;
    
    // Helper function para obtener foto por Ã­ndice
    function getPhotoByIndex(category, index) {
        const photos = reportData.photos[category] || [];
        return photos[index] ? photos[index].data : 'N/A';
    }
    
    function getPhotoTimestamp(category, index) {
        const photos = reportData.photos[category] || [];
        return photos[index] ? photos[index].timestamp : '';
    }
    
    // Mapeo base de fotos (no dependen de sectores)
    const photoMapping = {
        // Antenna photos - dinÃ¡mico segÃºn cantidad instalada
        antenna1Photo: getPhotoByIndex('antenna_labels', 0),
        antenna2Photo: getPhotoByIndex('antenna_labels', 1),
        antenna3Photo: getPhotoByIndex('antenna_labels', 2),
        antenna4Photo: getPhotoByIndex('antenna_labels', 3),
        antenna5Photo: getPhotoByIndex('antenna_labels', 4),
        antenna6Photo: getPhotoByIndex('antenna_labels', 5),
        
        // Radio photos - dinÃ¡mico segÃºn cantidad instalada
        radio1Photo: getPhotoByIndex('radio_labels', 0),
        radio2Photo: getPhotoByIndex('radio_labels', 1),
        radio3Photo: getPhotoByIndex('radio_labels', 2),
        
        // Post equipment room photos (siempre 4 requeridas)
        postPhoto1: getPhotoByIndex('equipment_room', 0),
        postPhoto2: getPhotoByIndex('equipment_room', 1),
        postPhoto3: getPhotoByIndex('equipment_room', 2),
        postPhoto4: getPhotoByIndex('equipment_room', 3),
        
        // Timestamps para post photos
        postPhoto1Timestamp: getPhotoTimestamp('equipment_room', 0),
        postPhoto2Timestamp: getPhotoTimestamp('equipment_room', 1),
        postPhoto3Timestamp: getPhotoTimestamp('equipment_room', 2),
        postPhoto4Timestamp: getPhotoTimestamp('equipment_room', 3),
        
        // Cabinet photos (siempre 2)
        cabinetOpenPhoto: getPhotoByIndex('cabinet_doors', 0),
        cabinetClosePhoto: getPhotoByIndex('cabinet_doors', 1),
        cabinetOpenTimestamp: getPhotoTimestamp('cabinet_doors', 0),
        cabinetCloseTimestamp: getPhotoTimestamp('cabinet_doors', 1),
        
        // Safety line photos (siempre 4)
        safetyTopPhoto: getPhotoByIndex('safety_lines', 0),
        safetySectorPhoto: getPhotoByIndex('safety_lines', 1),
        safetyUpPhoto: getPhotoByIndex('safety_lines', 2),
        safetyBottomPhoto: getPhotoByIndex('safety_lines', 3),
        safetyTopTimestamp: getPhotoTimestamp('safety_lines', 0),
        safetySectorTimestamp: getPhotoTimestamp('safety_lines', 1),
        safetyUpTimestamp: getPhotoTimestamp('safety_lines', 2),
        safetyBottomTimestamp: getPhotoTimestamp('safety_lines', 3),
        
        // Compound post pictures (4 fotos siempre)
        compoundPhoto1: getPhotoByIndex('compound_post', 0),
        compoundPhoto2: getPhotoByIndex('compound_post', 1),
        compoundPhoto3: getPhotoByIndex('compound_post', 2),
        compoundPhoto4: getPhotoByIndex('compound_post', 3),
        compoundPhoto1Timestamp: getPhotoTimestamp('compound_post', 0),
        compoundPhoto2Timestamp: getPhotoTimestamp('compound_post', 1),
        compoundPhoto3Timestamp: getPhotoTimestamp('compound_post', 2),
        compoundPhoto4Timestamp: getPhotoTimestamp('compound_post', 3),
        
        // Tower measurements (siempre 2)
        towerTapeDropPhoto: getPhotoByIndex('tower_measurements', 0),
        tallestPointPhoto: getPhotoByIndex('tower_measurements', 1),
        
        // Beacon photos (siempre 2)
        beaconPhoto: getPhotoByIndex('beacon', 0),
        beaconLabelPhoto: getPhotoByIndex('beacon', 1)
    };
    
    // Agregar fotos de sectores desde el suelo (dinÃ¡mico)
    for (let i = 1; i <= Math.max(sectorsCount, 6); i++) {
        photoMapping[`sector${i}GroundPhoto`] = getPhotoByIndex('sectors_ground', i - 1);
    }
    
    // Agregar fotos especÃ­ficas por sector (dinÃ¡mico)
    for (let i = 1; i <= sectorsCount; i++) {
        // General view from behind
        photoMapping[`sector${i}GeneralViewPhoto`] = getPhotoByIndex(`sector_${i}_general_view`, 0);
        
        // Cables going back
        photoMapping[`sector${i}CablesBackPhoto`] = getPhotoByIndex(`sector_${i}_cables_back`, 0);
        
        // Sector view
        photoMapping[`sector${i}SectorViewPhoto`] = getPhotoByIndex(`sector_${i}_sector_view`, 0);
        
        // Tape drop photos (2 por sector)
        photoMapping[`sector${i}TapeDropPhoto1`] = getPhotoByIndex(`sector_${i}_tapedrop`, 0);
        photoMapping[`sector${i}TapeDropPhoto2`] = getPhotoByIndex(`sector_${i}_tapedrop`, 1);
        
        // Timestamps para tape drop
        photoMapping[`sector${i}TapeDropPhoto1Timestamp`] = getPhotoTimestamp(`sector_${i}_tapedrop`, 0);
        photoMapping[`sector${i}TapeDropPhoto2Timestamp`] = getPhotoTimestamp(`sector_${i}_tapedrop`, 1);
    }
    
    return photoMapping;
}

// Update measurement requirements based on tower top selection
function updateMeasurementRequirements() {
    const towerTopValue = document.getElementById('towerTop').value;
    const towerHeightRequired = document.getElementById('towerHeightRequired');
    const tallestPointRequired = document.getElementById('tallestPointRequired');
    const heightRequirementText = document.getElementById('heightRequirementText');
    const towerHeightInput = document.getElementById('towerHeight');
    const tallestPointInput = document.getElementById('tallestPoint');
    
    if (towerTopValue === 'yes' || towerTopValue === 'near-top') {
        // Si estÃ¡ en el tope o cerca, son obligatorios
        towerHeightRequired.style.display = 'inline';
        tallestPointRequired.style.display = 'inline';
        towerHeightInput.setAttribute('required', 'required');
        tallestPointInput.setAttribute('required', 'required');
        heightRequirementText.innerHTML = '<strong style="color: #c62828;">OBLIGATORIO</strong> - InstalaciÃ³n en el tope o cerca del tope';
    } else if (towerTopValue === 'no') {
        // Si no estÃ¡ en el tope, son opcionales
        towerHeightRequired.style.display = 'none';
        tallestPointRequired.style.display = 'none';
        towerHeightInput.removeAttribute('required');
        tallestPointInput.removeAttribute('required');
        heightRequirementText.innerHTML = '<strong style="color: #1565c0;">OPCIONAL</strong> - InstalaciÃ³n debajo de 10\' del tope';
    } else {
        // No se ha seleccionado nada
        heightRequirementText.textContent = 'Seleccione "Tower Top Installation" para ver requisitos';
    }
}

// Navigation functions
function nextStep() {
    if (validateCurrentStep()) {
        saveCurrentStep();
        if (currentStep < 5) {
            currentStep++;
            showStep(currentStep);
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

function showStep(step) {
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.getElementById('section' + step).classList.add('active');
    
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
            stepEl.classList.add('completed');
        } else if (index + 1 === step) {
            stepEl.classList.add('active');
        }
    });
    
    // Generate photo grid when entering step 3
    if (step === 3) {
        generatePhotoGrid();
    }
    
    if (step === 4) {
        updateReview();
    }
    
    window.scrollTo(0, 0);
}

// Validation functions - ACTUALIZADO PARA GPS OBLIGATORIO, EQUIPOS, SECTORES Y MEDICIONES
function validateCurrentStep() {
    switch(currentStep) {
        case 1:
            // Validar campos bÃ¡sicos
            const requiredFields = ['siteId', 'siteName', 'customerSiteId', 'customerSiteName', 
                                    'sectorsCount', 'radiosInstalled', 'antennasInstalled', 
                                    'cablesInstalled', 'teamLeader', 'towerTop', 'completionDate'];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value) {
                    showNotification(`Por favor complete el campo: ${element.previousElementSibling.textContent}`, 'error');
                    element.focus();
                    return false;
                }
            }
            
            // Validar GPS (OBLIGATORIO)
            if (!reportData.gps.latitude || !reportData.gps.longitude) {
                showNotification('La ubicaciÃ³n GPS es obligatoria. Capture o ingrese las coordenadas.', 'error');
                document.getElementById('gpsStatus').scrollIntoView();
                return false;
            }
            
            // Validar tape drops segÃºn sectores
            const sectorsCount = parseInt(document.getElementById('sectorsCount').value) || 0;
            for (let i = 1; i <= sectorsCount; i++) {
                const tapeDrop = document.getElementById(`sector${i}TapeDrop`);
                if (!tapeDrop || !tapeDrop.value) {
                    showNotification(`Por favor ingrese el tape drop del Sector ${i}`, 'error');
                    if (tapeDrop) tapeDrop.focus();
                    return false;
                }
            }
            
            // Validar tower height y tallest point si es requerido
            const towerTop = document.getElementById('towerTop').value;
            if (towerTop === 'yes' || towerTop === 'near-top') {
                if (!document.getElementById('towerHeight').value) {
                    showNotification('Tower Height es obligatorio para instalaciones en el tope', 'error');
                    document.getElementById('towerHeight').focus();
                    return false;
                }
                if (!document.getElementById('tallestPoint').value) {
                    showNotification('Tallest Point es obligatorio para instalaciones en el tope', 'error');
                    document.getElementById('tallestPoint').focus();
                    return false;
                }
            }
            
            return true;
            
        case 2:
            // Validar equipos segÃºn cantidades instaladas
            const radios = parseInt(document.getElementById('radiosInstalled').value) || 0;
            const antennas = parseInt(document.getElementById('antennasInstalled').value) || 0;
            const cables = parseInt(document.getElementById('cablesInstalled').value) || 0;
            
            const radioCount = reportData.appurtenances.filter(a => a.type === 'Radio').reduce((sum, a) => sum + parseInt(a.quantity), 0);
            const antennaCount = reportData.appurtenances.filter(a => a.type === 'Antenna').reduce((sum, a) => sum + parseInt(a.quantity), 0);
            const cableCount = reportData.appurtenances.filter(a => a.type === 'Cable').reduce((sum, a) => sum + parseInt(a.quantity), 0);
            
            if (radioCount < radios) {
                showNotification(`Debe registrar al menos ${radios} radio(s). Actualmente: ${radioCount}`, 'error');
                return false;
            }
            if (antennaCount < antennas) {
                showNotification(`Debe registrar al menos ${antennas} antena(s). Actualmente: ${antennaCount}`, 'error');
                return false;
            }
            if (cableCount < cables) {
                showNotification(`Debe registrar al menos ${cables} cable(s). Actualmente: ${cableCount}`, 'error');
                return false;
            }
            
            return true;
            
        case 3:
            // Validar fotos requeridas
            let missingPhotos = [];
            photoTypes.forEach(type => {
                const photos = reportData.photos[type.id] || [];
                if (photos.length < type.required) {
                    missingPhotos.push(`${type.name}: ${photos.length}/${type.required}`);
                }
            });
            
            if (missingPhotos.length > 0) {
                showNotification('Fotos faltantes:\n' + missingPhotos.join('\n'), 'error');
                return false;
            }
            return true;
            
        default:
            return true;
    }
}

// Save current step data
function saveCurrentStep() {
    switch(currentStep) {
        case 1:
            // Guardar informaciÃ³n bÃ¡sica
            reportData.basic = {
                siteId: document.getElementById('siteId').value,
                siteName: document.getElementById('siteName').value,
                customerSiteId: document.getElementById('customerSiteId').value,
                customerSiteName: document.getElementById('customerSiteName').value,
                sectorsCount: document.getElementById('sectorsCount').value,
                radiosInstalled: document.getElementById('radiosInstalled').value,
                antennasInstalled: document.getElementById('antennasInstalled').value,
                cablesInstalled: document.getElementById('cablesInstalled').value,
                teamLeader: document.getElementById('teamLeader').value,
                towerTop: document.getElementById('towerTop').value,
                completionDate: document.getElementById('completionDate').value,
                submittedBy: reportData.metadata.submittedBy,
                submittedByEmail: reportData.metadata.submittedByEmail
            };
            
            // Guardar mediciones
            reportData.measurements = {};
            const sectorsCount = parseInt(document.getElementById('sectorsCount').value) || 0;
            for (let i = 1; i <= sectorsCount; i++) {
                const tapeDrop = document.getElementById(`sector${i}TapeDrop`);
                if (tapeDrop) {
                    reportData.measurements[`sector${i}TapeDrop`] = tapeDrop.value;
                }
            }
            
            // Guardar tower height y tallest point si existen
            const towerHeight = document.getElementById('towerHeight').value;
            const tallestPoint = document.getElementById('tallestPoint').value;
            if (towerHeight) reportData.measurements.towerHeight = towerHeight;
            if (tallestPoint) reportData.measurements.tallestPoint = tallestPoint;
            break;
    }
    
    // Guardar en localStorage
    try {
        localStorage.setItem('towerReport', JSON.stringify(reportData));
    } catch (error) {
        console.error('Error saving data:', error);
        if (error.name === 'QuotaExceededError') {
            showNotification('Almacenamiento lleno. Limpiando datos antiguos...', 'info');
            clearOldReports();
            try {
                localStorage.setItem('towerReport', JSON.stringify(reportData));
            } catch (e) {
                showNotification('No se pudo guardar. Almacenamiento lleno.', 'error');
            }
        }
    }
}

// GPS Functions
function getGPSLocation() {
    if (!navigator.geolocation) {
        showGPSStatus(false, 'GPS no soportado en este dispositivo');
        return;
    }
    
    showGPSStatus(false, 'Obteniendo ubicaciÃ³n...');
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            reportData.gps = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                altitude: position.coords.altitude || 0,
                timestamp: new Date().toISOString(),
                manual: false
            };
            showGPSStatus(true);
            saveCurrentStep();
        },
        (error) => {
            let message = 'Error al obtener GPS: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Permiso denegado';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'PosiciÃ³n no disponible';
                    break;
                case error.TIMEOUT:
                    message += 'Tiempo de espera agotado';
                    break;
                default:
                    message += 'Error desconocido';
            }
            showGPSStatus(false, message);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function showManualGPS() {
    const manualForm = `
        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 15px;">
            <h4 style="color: #856404;">Ingreso Manual de Coordenadas</h4>
            <div class="form-group">
                <label>Latitud <span class="required">*</span></label>
                <input type="number" id="manualLat" step="0.0000001" placeholder="18.4655" required>
            </div>
            <div class="form-group">
                <label>Longitud <span class="required">*</span></label>
                <input type="number" id="manualLng" step="0.0000001" placeholder="-66.1057" required>
            </div>
            <button class="btn btn-primary" onclick="saveManualGPS()">
                Guardar Coordenadas
            </button>
            <button class="btn btn-secondary" onclick="getGPSLocation()" style="margin-left: 10px;">
                Cancelar
            </button>
        </div>
    `;
    document.getElementById('gpsStatus').innerHTML = manualForm;
}

function saveManualGPS() {
    const lat = parseFloat(document.getElementById('manualLat').value);
    const lng = parseFloat(document.getElementById('manualLng').value);
    
    if (isNaN(lat) || isNaN(lng)) {
        showNotification('Por favor ingrese coordenadas vÃ¡lidas', 'error');
        return;
    }
    
    if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        showNotification('Coordenadas fuera de rango vÃ¡lido', 'error');
        return;
    }
    
    reportData.gps = {
        latitude: lat,
        longitude: lng,
        accuracy: 0,
        altitude: 0,
        timestamp: new Date().toISOString(),
        manual: true
    };
    
    showGPSStatus(true);
    saveCurrentStep();
}

function showGPSStatus(success, message = '') {
    const statusDiv = document.getElementById('gpsStatus');
    
    if (success) {
        const isManual = reportData.gps.manual ? ' (Manual)' : '';
        statusDiv.innerHTML = `
            <div class="gps-status success">
                â GPS Capturado${isManual}: ${reportData.gps.latitude.toFixed(7)}, ${reportData.gps.longitude.toFixed(7)}
                ${!reportData.gps.manual ? `<br>PrecisiÃ³n: Â±${reportData.gps.accuracy.toFixed(1)}m` : ''}
                <br>
                <button class="btn btn-secondary" onclick="showManualGPS()" style="margin-top: 10px; font-size: 12px;">
                    âï¸ Editar Coordenadas
                </button>
            </div>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="gps-status error">
                â ${message}
            </div>
        `;
    }
}

// Appurtenance Functions
function showAppurtenanceForm() {
    document.getElementById('appurtenanceForm').style.display = 'block';
}

function cancelAppurtenance() {
    document.getElementById('appurtenanceForm').style.display = 'none';
    ['appType', 'appRadCenter', 'appManufacturer', 'appModel', 'appQuantity', 'appCoaxSize'].forEach(id => {
        const element = document.getElementById(id);
        if (id === 'appQuantity') {
            element.value = '1';
        } else if (id === 'appCoaxSize') {
            element.value = 'N/A';
        } else {
            element.value = '';
        }
    });
}

function addAppurtenance() {
    const appurtenance = {
        type: document.getElementById('appType').value,
        radCenter: document.getElementById('appRadCenter').value,
        manufacturer: document.getElementById('appManufacturer').value,
        model: document.getElementById('appModel').value,
        quantity: document.getElementById('appQuantity').value,
        coaxSize: document.getElementById('appCoaxSize').value
    };
    
    reportData.appurtenances.push(appurtenance);
    updateAppurtenanceList();
    updateEquipmentCounter();
    cancelAppurtenance();
    saveCurrentStep();
}

function updateAppurtenanceList() {
    const listDiv = document.getElementById('appurtenanceList');
    listDiv.innerHTML = '';
    
    reportData.appurtenances.forEach((app, index) => {
        const item = document.createElement('div');
        item.className = 'appurtenance-item';
        item.innerHTML = `
            <div class="appurtenance-info">
                <h4>${app.type} - ${app.manufacturer}</h4>
                <p>Model: ${app.model} | Qty: ${app.quantity} | Rad: ${app.radCenter} | Coax: ${app.coaxSize}</p>
            </div>
            <button class="btn btn-danger" onclick="removeAppurtenance(${index})">Ã</button>
        `;
        listDiv.appendChild(item);
    });
}

function removeAppurtenance(index) {
    reportData.appurtenances.splice(index, 1);
    updateAppurtenanceList();
    updateEquipmentCounter();
    saveCurrentStep();
}

// Photo Functions - MEJORADAS PARA v9.30
function generatePhotoGrid() {
    const grid = document.getElementById('photoGrid');
    grid.innerHTML = '';
    
    // Make sure we have photo types defined
    if (photoTypes.length === 0) {
        updatePhotoTypes();
    }
    
    // Organizar fotos por grupos
    const generalPhotos = [];
    const sectorPhotos = {};
    const tapeDropPhotos = {};
    
    photoTypes.forEach(type => {
        if (type.sectorGroup) {
            if (!sectorPhotos[type.sectorNumber]) {
                sectorPhotos[type.sectorNumber] = [];
            }
            sectorPhotos[type.sectorNumber].push(type);
        } else if (type.tapeDropGroup) {
            tapeDropPhotos[type.sectorNumber] = type;
        } else {
            generalPhotos.push(type);
        }
    });
    
    // Crear secciÃ³n de fotos generales
    const generalSection = document.createElement('div');
    generalSection.innerHTML = '<h3 style="color: #0066cc; margin: 20px 0 10px 0;">Fotos Generales</h3>';
    grid.appendChild(generalSection);
    
    generalPhotos.forEach(type => {
        const photoItem = createPhotoItem(type);
        grid.appendChild(photoItem);
    });
    
    // Crear secciÃ³n de fotos por sector
    if (Object.keys(sectorPhotos).length > 0) {
        const sectorSection = document.createElement('div');
        sectorSection.innerHTML = '<h3 style="color: #0066cc; margin: 30px 0 10px 0;">Fotos de Sectores - Post Pictures</h3>';
        grid.appendChild(sectorSection);
        
        // Para cada sector
        Object.keys(sectorPhotos).sort((a, b) => parseInt(a) - parseInt(b)).forEach(sectorNum => {
            // Crear tÃ­tulo del sector
            const sectorTitle = document.createElement('div');
            sectorTitle.innerHTML = `<h4 style="background: #e3f2fd; color: #1565c0; padding: 10px; margin: 20px 0 10px 0; border-radius: 6px;">Sector ${sectorNum}</h4>`;
            grid.appendChild(sectorTitle);
            
            // Agregar cada tipo de foto para este sector
            sectorPhotos[sectorNum].forEach(type => {
                const photoItem = createPhotoItem(type);
                grid.appendChild(photoItem);
            });
        });
    }
    
    // Crear secciÃ³n de tape drop
    if (Object.keys(tapeDropPhotos).length > 0) {
        const tapeDropSection = document.createElement('div');
        tapeDropSection.innerHTML = '<h3 style="color: #0066cc; margin: 30px 0 10px 0;">Tape Drop Measurements</h3>';
        grid.appendChild(tapeDropSection);
        
        // Para cada sector
        Object.keys(tapeDropPhotos).sort((a, b) => parseInt(a) - parseInt(b)).forEach(sectorNum => {
            const type = tapeDropPhotos[sectorNum];
            const photoItem = createPhotoItem(type);
            grid.appendChild(photoItem);
        });
    }
    
    updatePhotoCounts();
}

function createPhotoItem(type) {
    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    photoItem.innerHTML = `
        <h4>${type.name}</h4>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">${type.description}</p>
        <div class="photo-capture">
            <input type="file" 
                   accept="image/*" 
                   capture="environment" 
                   multiple
                   class="camera-input" 
                   id="photo_camera_${type.id}" 
                   onchange="handlePhotoCapture('${type.id}', this)">
            <label for="photo_camera_${type.id}" class="camera-btn">
                ð· Tomar Foto
            </label>
            <input type="file" 
                   accept="image/*" 
                   multiple
                   class="camera-input" 
                   id="photo_gallery_${type.id}" 
                   onchange="handlePhotoCapture('${type.id}', this)">
            <label for="photo_gallery_${type.id}" class="gallery-btn">
                ð¼ï¸ GalerÃ­a
            </label>
        </div>
        <div class="photo-count">
            <span id="count_${type.id}">0</span> de ${type.required} fotos requeridas
        </div>
        <div class="photo-preview-container" id="preview_${type.id}"></div>
        <div class="photo-status ${(reportData.photos[type.id] || []).length >= type.required ? 'complete' : 'pending'}" id="status_${type.id}">
            ${(reportData.photos[type.id] || []).length >= type.required ? 'â Completo' : 'â± Pendiente'}
        </div>
    `;
    return photoItem;
}

function handlePhotoCapture(typeId, input) {
    const files = Array.from(input.files);
    if (!reportData.photos[typeId]) {
        reportData.photos[typeId] = [];
    }
    
    files.forEach(file => {
        const currentSize = checkStorageSpace();
        if (parseFloat(currentSize) > 4.5) {
            showNotification('Almacenamiento casi lleno. Limpiando fotos antiguas...', 'info');
            clearOldReports();
        }
        
        compressImage(file, 400, 0.5, (compressedDataUrl) => {
            try {
                reportData.photos[typeId].push({
                    data: compressedDataUrl,
                    timestamp: new Date().toISOString(),
                    name: file.name,
                    id: Date.now() + Math.random() // ID Ãºnico para cada foto
                });
                updatePhotoPreview(typeId);
                updatePhotoCounts();
                saveCurrentStep();
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    showNotification('Almacenamiento lleno. Use "Limpiar datos" primero.', 'error');
                }
            }
        });
    });
    
    // Clear the input to allow selecting the same file again
    input.value = '';
}

function compressImage(file, maxWidth, quality, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            const maxSize = 400;
            if (width > height) {
                if (width > maxSize) {
                    height = (maxSize / width) * height;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width = (maxSize / height) * width;
                    height = maxSize;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5);
            callback(compressedDataUrl);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function updatePhotoPreview(typeId) {
    const previewDiv = document.getElementById(`preview_${typeId}`);
    const photos = reportData.photos[typeId] || [];
    
    previewDiv.innerHTML = photos.map((photo, index) => `
        <div class="photo-preview-item">
            <img src="${photo.data}" class="photo-preview" alt="Photo ${index + 1}">
            <button class="photo-delete-btn" onclick="deletePhoto('${typeId}', ${index})" title="Eliminar foto">
                Ã
            </button>
        </div>
    `).join('');
}

function deletePhoto(typeId, photoIndex) {
    if (confirm('Â¿EstÃ¡ seguro de que desea eliminar esta foto?')) {
        if (reportData.photos[typeId] && reportData.photos[typeId][photoIndex]) {
            reportData.photos[typeId].splice(photoIndex, 1);
            updatePhotoPreview(typeId);
            updatePhotoCounts();
            saveCurrentStep();
            showNotification('Foto eliminada correctamente', 'success');
        }
    }
}

function updatePhotoCounts() {
    photoTypes.forEach(type => {
        const photos = reportData.photos[type.id] || [];
        const countSpan = document.getElementById(`count_${type.id}`);
        const statusDiv = document.getElementById(`status_${type.id}`);
        
        if (countSpan) {
            countSpan.textContent = photos.length;
        }
        
        if (statusDiv) {
            if (photos.length >= type.required) {
                statusDiv.className = 'photo-status complete';
                statusDiv.textContent = 'â Completo';
            } else {
                statusDiv.className = 'photo-status pending';
                statusDiv.textContent = 'â± Pendiente';
            }
        }
    });
}

// Review Functions
function updateReview() {
    const basicReview = document.getElementById('basicReview');
    basicReview.innerHTML = `
        <div class="review-item">
            <span class="review-label">Site ID:</span>
            <span class="review-value">${reportData.basic.siteId || 'N/A'}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Site Name:</span>
            <span class="review-value">${reportData.basic.siteName || 'N/A'}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Sectors:</span>
            <span class="review-value">${reportData.basic.sectorsCount || 'N/A'}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Team Leader:</span>
            <span class="review-value">${reportData.basic.teamLeader || 'N/A'}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Tower Top:</span>
            <span class="review-value">${reportData.basic.towerTop === 'yes' ? 'Yes - At Tower Top' :
                                         reportData.basic.towerTop === 'near-top' ? 'Near Top (Within 10\' of top)' :
                                         'No - Below 10\' from top'}</span>
        </div>
    `;
    
    const gpsReview = document.getElementById('gpsReview');
    gpsReview.innerHTML = `
        <div class="review-item">
            <span class="review-label">Latitude:</span>
            <span class="review-value">${reportData.gps.latitude?.toFixed(7) || 'N/A'}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Longitude:</span>
            <span class="review-value">${reportData.gps.longitude?.toFixed(7) || 'N/A'}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Method:</span>
            <span class="review-value">${reportData.gps.manual ? 'Manual' : 'GPS AutomÃ¡tico'}</span>
        </div>
    `;
    
    const equipmentReview = document.getElementById('equipmentReview');
    equipmentReview.innerHTML = `
        <div class="review-item">
            <span class="review-label">Total de equipos:</span>
            <span class="review-value">${reportData.appurtenances.length}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Radios:</span>
            <span class="review-value">${reportData.appurtenances.filter(a => a.type === 'Radio').reduce((sum, a) => sum + parseInt(a.quantity), 0)}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Antenas:</span>
            <span class="review-value">${reportData.appurtenances.filter(a => a.type === 'Antenna').reduce((sum, a) => sum + parseInt(a.quantity), 0)}</span>
        </div>
        <div class="review-item">
            <span class="review-label">Cables:</span>
            <span class="review-value">${reportData.appurtenances.filter(a => a.type === 'Cable').reduce((sum, a) => sum + parseInt(a.quantity), 0)}</span>
        </div>
    `;
    
    const measurementsReview = document.getElementById('measurementsReview');
    let measurementsHTML = '';
    
    // Tape drops
    const sectorsCount = parseInt(reportData.basic.sectorsCount) || 0;
    for (let i = 1; i <= sectorsCount; i++) {
        measurementsHTML += `
            <div class="review-item">
                <span class="review-label">Sector ${i} Tape Drop:</span>
                <span class="review-value">${reportData.measurements[`sector${i}TapeDrop`] || 'N/A'} (OBLIGATORIO)</span>
            </div>
        `;
    }
    
    // Tower height y tallest point
    if (reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') {
        measurementsHTML += `
            <div class="review-item">
                <span class="review-label">Tower Height:</span>
                <span class="review-value">${reportData.measurements.towerHeight || 'N/A'} (OBLIGATORIO)</span>
            </div>
            <div class="review-item">
                <span class="review-label">Tallest Point:</span>
                <span class="review-value">${reportData.measurements.tallestPoint || 'N/A'} (OBLIGATORIO)</span>
            </div>
        `;
    } else {
        measurementsHTML += `
            <div class="review-item">
                <span class="review-label">Tower Height:</span>
                <span class="review-value">${reportData.measurements.towerHeight || 'No requerido'}</span>
            </div>
            <div class="review-item">
                <span class="review-label">Tallest Point:</span>
                <span class="review-value">${reportData.measurements.tallestPoint || 'No requerido'}</span>
            </div>
        `;
    }
    
    measurementsReview.innerHTML = measurementsHTML;
    
    const photoReview = document.getElementById('photoReview');
    let totalPhotos = 0;
    let completedTypes = 0;
    
    photoTypes.forEach(type => {
        const photos = reportData.photos[type.id] || [];
        totalPhotos += photos.length;
        if (photos.length >= type.required) {
            completedTypes++;
        }
    });
    
    photoReview.innerHTML = `
        <div class="review-item">
            <span class="review-label">Total de fotos:</span>
            <span class="review-value">${totalPhotos}</span>
        </div>
        <div class="review-item">
            <span class="review-label">CategorÃ­as completas:</span>
            <span class="review-value">${completedTypes} de ${photoTypes.length}</span>
        </div>
    `;
}

// Submit and SharePoint Functions - ACTUALIZADO PARA v9.30 CON MAPEO DINÃMICO
async function sendToSharePoint(reportData) {
    const POWER_AUTOMATE_URL = 'https://prod-19.westus.logic.azure.com:443/workflows/1170c524ac7e4e9c98e817550c91f1d0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JdS7ZO75Zm5eCaImMEoyGfDp3qzLUlNYLlo1J_dHGjE';
    
    const timestamp = Date.now();
    const randomNum = Math.floor(Math.random() * 100000);
    const uniqueReportID = `RPT-${timestamp}-${randomNum}`;
    
    // Mapear las fotos dinÃ¡micamente - NUEVA FUNCIONALIDAD v8.0
    const photoMapping = mapPhotosForSharePoint(reportData);
    
    const appurtenanceDataJSON = {
        appurtenances: reportData.appurtenances || [],
        measurements: reportData.measurements || {},
        gpsDetails: {
            latitude: reportData.gps.latitude || 0,
            longitude: reportData.gps.longitude || 0,
            altitude: reportData.gps.altitude || 0,
            accuracy: reportData.gps.accuracy || 0,
            method: reportData.gps.manual ? 'manual' : 'auto',
            mapUrl: reportData.gps.mapUrl || null
        },
        metadata: reportData.metadata || {}
    };
    
    const photoLinksJSON = {
        totalPhotos: 0,
        categories: {},
        photoMetadata: {},
        // Agregar las fotos mapeadas tambiÃ©n para debug
        photoData: reportData.photos
    };
    
    Object.keys(reportData.photos).forEach(category => {
        const photos = reportData.photos[category] || [];
        photoLinksJSON.totalPhotos += photos.length;
        photoLinksJSON.categories[category] = photos.length;
        
        photos.forEach((photo, index) => {
            const photoKey = `${category}_${index + 1}`;
            photoLinksJSON.photoMetadata[photoKey] = {
                timestamp: photo.timestamp,
                name: photo.name || photoKey,
                category: photoTypes.find(t => t.id === category)?.name || category
            };
        });
    });
    
    // Interpretar el valor de towerTop para SharePoint
    let towerTopBoolean = false;
    if (reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') {
        towerTopBoolean = true;
    }
    
    const dataToSend = {
        Title: reportData.basic.teamLeader || 'Field Technician',
        SubmittedBy: reportData.basic.submittedBy || 'Field Technician',
        SubmittedByEmail: reportData.basic.submittedByEmail || 'unknown@email.com',
        SubmissionTimestamp: new Date().toISOString(),
        ReportID: uniqueReportID,
        TowerProviderSiteID: reportData.basic.siteId || '',
        TowerProviderSiteName: reportData.basic.siteName || '',
        CustomerSiteID: reportData.basic.customerSiteId || '',
        CustomerSiteName: reportData.basic.customerSiteName || '',
        SectorsCount: parseInt(reportData.basic.sectorsCount) || 0,
        RadiosInstalled: parseInt(reportData.basic.radiosInstalled) || 0,
        AntennasInstalled: parseInt(reportData.basic.antennasInstalled) || 0,
        CablesInstalled: parseInt(reportData.basic.cablesInstalled) || 0,
        TeamLeader: reportData.basic.teamLeader || '',
        TowerTopInstallation: towerTopBoolean,
        TowerTopInstallationDetails: reportData.basic.towerTop || 'no',
        CompletionDate: reportData.basic.completionDate || new Date().toISOString().split('T')[0],
        Latitude: reportData.gps.latitude || 0,
        Longitude: reportData.gps.longitude || 0,
        AppurtenanceData: JSON.stringify(appurtenanceDataJSON),
        PhotoLinks: JSON.stringify(photoLinksJSON),
        ReportStatus: 'DraftSubmittedPDF',
        
        // Incluir todas las fotos mapeadas dinÃ¡micamente - NUEVA FUNCIONALIDAD v8.0
        ...photoMapping
    };
    
    try {
        const response = await fetch(POWER_AUTOMATE_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(dataToSend)
        });
        
        if (response.ok) {
            return true;
        } else {
            console.error('Error response:', response.status, response.statusText);
            return false;
        }
    } catch (error) {
        console.error('Network/Connection error:', error);
        return false;
    }
}

async function submitReport() {
    const submitBtn = event.target;
    const statusDiv = document.getElementById('submitStatus');
    
    // Update submittedBy with current authenticated user
    reportData.basic.submittedBy = reportData.metadata.submittedBy || 'Unknown User';
    reportData.basic.submittedByEmail = reportData.metadata.submittedByEmail || 'unknown@email.com';
    
    submitBtn.disabled = true;
    statusDiv.innerHTML = '<div class="spinner"></div><p>Enviando reporte a SharePoint...</p>';
    
    try {
        const reportId = `RPT-${Date.now()}-${Math.floor(Math.random() * 100000)}`;
        localStorage.setItem(reportId, JSON.stringify(reportData));
        
        const sentToSharePoint = await sendToSharePoint(reportData);
        
        if (sentToSharePoint) {
            statusDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 20px; border-radius: 6px; text-align: left;">
                    <h3 style="color: #2e7d32;">â Reporte Enviado a SharePoint</h3>
                    <p>ID: ${reportId}</p>
                    <p>Enviado por: <strong>${reportData.basic.submittedBy}</strong></p>
                    <p style="margin-top: 15px;">
                        <strong>â Guardado localmente</strong><br>
                        <strong>â Enviado a SharePoint</strong><br>
                        <strong>â Fotos con funcionalidad mejorada (v9.30)</strong>
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                            â Crear Nuevo Reporte
                        </button>
                        <button class="btn btn-primary" onclick="sendDetailedEmail('${reportId}')" style="flex: 1;">
                            ð§ Enviar Email Detallado
                        </button>
                        <button class="btn btn-secondary" onclick="showReportSearch()" style="flex: 1;">
                            ð Buscar/Editar Reportes
                        </button>
                    </div>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div style="background: #fff3cd; padding: 20px; border-radius: 6px; text-align: left;">
                    <h3 style="color: #856404;">â ï¸ Guardado Solo Localmente</h3>
                    <p>ID: ${reportId}</p>
                    <p style="margin-top: 15px;">
                        El reporte se guardÃ³ en el dispositivo pero no se pudo enviar a SharePoint.
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="retrySharePoint('${reportId}')" style="flex: 1;">
                            ð Reintentar EnvÃ­o
                        </button>
                        <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                            â Nuevo Reporte
                        </button>
                        <button class="btn btn-secondary" onclick="showReportSearch()" style="flex: 1;">
                            ð Buscar/Editar Reportes
                        </button>
                    </div>
                </div>
            `;
        }
        
        submitBtn.disabled = false;
        
    } catch (error) {
        statusDiv.innerHTML = `
            <div style="background: #ffebee; padding: 20px; border-radius: 6px;">
                <h3 style="color: #c62828;">Error al guardar</h3>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="location.reload()">
                    Recargar PÃ¡gina
                </button>
            </div>
        `;
        submitBtn.disabled = false;
    }
}

async function retrySharePoint(reportId) {
    const savedData = localStorage.getItem(reportId);
    if (savedData) {
        const data = JSON.parse(savedData);
        const statusDiv = document.getElementById('submitStatus');
        
        statusDiv.innerHTML = '<div class="spinner"></div><p>Reintentando envÃ­o...</p>';
        
        const sent = await sendToSharePoint(data);
    
    if (sent) {
        document.getElementById('submitStatus').innerHTML = `
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2e7d32;">â Reenviado Exitosamente</h3>
                <p>El reporte actualizado se enviÃ³ a SharePoint.</p>
                <button class="btn btn-primary" onclick="showReportSearch()" style="margin-top: 15px;">
                    Buscar Otro Reporte
                </button>
            </div>
        `;
    } else {
        document.getElementById('submitStatus').innerHTML = `
            <div style="background: #ffebee; padding: 20px; border-radius: 8px;">
                <h3 style="color: #c62828;">Error al reenviar</h3>
                <p>No se pudo conectar con SharePoint.</p>
                <button class="btn btn-primary" onclick="resendToSharePoint('${reportId}')" style="margin-top: 15px;">
                    Reintentar
                </button>
            </div>
        `;
    }
}

function deleteReport(reportId) {
    if (confirm(`Â¿EstÃ¡ seguro de eliminar el reporte ${reportId}? Esta acciÃ³n no se puede deshacer.`)) {
        localStorage.removeItem(reportId);
        showNotification('Reporte eliminado', 'success');
        showReportSearch();
    }
}

// Utility Functions
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function saveCurrentStep() {
    // Save to localStorage
    try {
        localStorage.setItem('towerReport', JSON.stringify(reportData));
    } catch (error) {
        console.error('Error saving data:', error);
        if (error.name === 'QuotaExceededError') {
            showNotification('Almacenamiento lleno. Limpiando datos antiguos...', 'info');
            clearOldReports();
            try {
                localStorage.setItem('towerReport', JSON.stringify(reportData));
            } catch (e) {
                showNotification('No se pudo guardar. Almacenamiento lleno.', 'error');
                // Try saving minimal data
                const minimalData = {
                    basic: reportData.basic,
                    gps: reportData.gps,
                    appurtenances: reportData.appurtenances,
                    photos: {}
                };
                localStorage.setItem('towerReport', JSON.stringify(minimalData));
                showNotification('Guardado parcial. Algunas fotos no se guardaron.', 'error');
            }
        }
    }
}

function loadSavedData() {
    const saved = localStorage.getItem('towerReport');
    if (saved) {
        reportData = JSON.parse(saved);
        if (reportData.basic) {
            Object.keys(reportData.basic).forEach(key => {
                const element = document.getElementById(key);
                if (element && key !== 'submittedBy' && key !== 'submittedByEmail') {
                    element.value = reportData.basic[key];
                }
            });
            // Actualizar requisitos de mediciÃ³n si hay un valor de towerTop guardado
            if (reportData.basic.towerTop) {
                updateMeasurementRequirements();
            }
            // Actualizar sectores si hay un valor guardado
            if (reportData.basic.sectorsCount) {
                updateSectorRequirements();
            }
        }
        if (reportData.measurements) {
            Object.keys(reportData.measurements).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = reportData.measurements[key];
                }
            });
        }
        if (reportData.gps.latitude) {
            showGPSStatus(true);
        }
        updateAppurtenanceList();
        updatePhotoCounts();
        updateEquipmentRequirements();
    }
}

// Storage management functions
function checkStorageSpace() {
    try {
        let totalSize = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length;
            }
        }
        return (totalSize / 1024 / 1024).toFixed(2);
    } catch (e) {
        return 'Unknown';
    }
}

function updateStorageIndicator() {
    const indicator = document.getElementById('storageIndicator');
    if (indicator) {
        const usedMB = checkStorageSpace();
        const usedNum = parseFloat(usedMB);
        
        indicator.textContent = `${usedMB} MB`;
        
        if (usedNum > 4.5) {
            indicator.style.color = 'red';
            indicator.textContent += ' (CRÃTICO)';
        } else if (usedNum > 3) {
            indicator.style.color = 'orange';
            indicator.textContent += ' (alto)';
        } else {
            indicator.style.color = 'green';
        }
    }
}

function optimizeStorage() {
    const currentSize = parseFloat(checkStorageSpace());
    
    if (currentSize > 4) {
        showNotification('Optimizando almacenamiento...', 'info');
        clearOldReports();
        
        if (parseFloat(checkStorageSpace()) > 3) {
            Object.keys(reportData.photos).forEach(photoType => {
                const photos = reportData.photos[photoType];
                if (photos && photos.length > 2) {
                    reportData.photos[photoType] = photos.slice(-2);
                }
            });
            updatePhotoCounts();
        }
        
        updateStorageIndicator();
        showNotification('Almacenamiento optimizado', 'success');
    }
}

function clearOldReports() {
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('RPT-') && key !== 'towerReportSession') {
            keysToRemove.push(key);
        }
    }
    keysToRemove.forEach(key => localStorage.removeItem(key));
}

function clearAllData() {
    if (confirm('Â¿Eliminar todos los datos guardados? Esto no se puede deshacer.')) {
        // Save user info before clearing
        const userInfo = {
            submittedBy: reportData.metadata.submittedBy,
            submittedByEmail: reportData.metadata.submittedByEmail
        };
        
        localStorage.clear();
        
        // Reinitialize with user info
        reportData = {
            basic: {},
            gps: {},
            appurtenances: [],
            photos: {},
            measurements: {},
            metadata: {
                ...userInfo,
                appVersion: '9.30',
                deviceInfo: navigator.userAgent,
                createdAt: new Date().toISOString()
            }
        };
        
        location.reload();
    }
}
</script>
</body>
</html> sendToSharePoint(data);
        
        if (sent) {
            statusDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 20px; border-radius: 6px;">
                    <h3 style="color: #2e7d32;">â Enviado Exitosamente</h3>
                    <p>El reporte se enviÃ³ a SharePoint con fotos mejoradas (v9.30).</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                            â Crear Nuevo Reporte
                        </button>
                        <button class="btn btn-primary" onclick="location.href='mailto:accounting@newcomm2000.com?subject=Tower Report ${reportId}'" style="flex: 1;">
                            ð§ Enviar por Email
                        </button>
                    </div>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div style="background: #ffebee; padding: 20px; border-radius: 6px;">
                    <h3 style="color: #c62828;">Error al enviar</h3>
                    <p>No se pudo conectar con SharePoint. Verifique su conexiÃ³n.</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="retrySharePoint('${reportId}')" style="flex: 1;">
                            ð Reintentar
                        </button>
                        <button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
                            â Nuevo Reporte
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

function startNewReport() {
    // Mantener la informaciÃ³n del usuario
    const userInfo = {
        submittedBy: reportData.metadata.submittedBy,
        submittedByEmail: reportData.metadata.submittedByEmail
    };
    
    reportData = {
        basic: {},
        gps: {},
        appurtenances: [],
        photos: {},
        measurements: {},
        metadata: {
            ...userInfo,
            appVersion: '9.30',
            deviceInfo: navigator.userAgent,
            createdAt: new Date().toISOString()
        }
    };
    
    document.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.type === 'date') {
            field.value = new Date().toISOString().split('T')[0];
        } else if (field.id === 'appQuantity') {
            field.value = '1';
        } else if (field.id === 'appCoaxSize') {
            field.value = 'N/A';
        } else {
            field.value = '';
        }
    });
    
    currentStep = 1;
    showStep(1);
    
    document.getElementById('gpsStatus').innerHTML = '';
    document.getElementById('appurtenanceList').innerHTML = '';
    document.getElementById('sectorTapeDrops').innerHTML = '<p style="text-align: center; color: #666;">Seleccione la cantidad de sectores para ver los campos de tape drop</p>';
    
    // Reset photo types
    photoTypes = [];
    updateEquipmentCounter();
    updateMeasurementRequirements();
    
    showNotification('Nuevo reporte iniciado', 'success');
}

function showReportSummary() {
    let totalPhotos = 0;
    Object.values(reportData.photos).forEach(photoArray => {
        if (Array.isArray(photoArray)) {
            totalPhotos += photoArray.length;
        }
    });
    
    const sectorsCount = reportData.basic.sectorsCount || 0;
    let tapeDrpsHTML = '';
    for (let i = 1; i <= sectorsCount; i++) {
        tapeDrpsHTML += `<p><strong>Sector ${i} Tape Drop:</strong> ${reportData.measurements[`sector${i}TapeDrop`] || 'N/A'}</p>`;
    }
    
    const summaryHTML = `
        <div style="background: #f5f5f5; padding: 20px; border-radius: 6px; margin: 20px 0;">
            <h3 style="color: #0066cc; margin-bottom: 15px;">Resumen del Reporte v9.30</h3>
            
            <div style="margin-bottom: 15px;">
                <h4 style="color: #333;">InformaciÃ³n del Sitio</h4>
                <p><strong>Site ID:</strong> ${reportData.basic.siteId || 'N/A'}</p>
                <p><strong>Site Name:</strong> ${reportData.basic.siteName || 'N/A'}</p>
                <p><strong>Number of Sectors:</strong> ${sectorsCount}</p>
                <p><strong>Team Leader:</strong> ${reportData.basic.teamLeader || 'N/A'}</p>
                <p><strong>Enviado por:</strong> ${reportData.metadata.submittedBy || 'N/A'}</p>
                <p><strong>Fecha:</strong> ${reportData.basic.completionDate || 'N/A'}</p>
                <p><strong>Tower Top Installation:</strong> ${reportData.basic.towerTop === 'yes' ? 'Yes - At Tower Top' :
                    reportData.basic.towerTop === 'near-top' ? 'Near Top (Within 10\' of top)' :
                    'No - Below 10\' from top'}</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <h4 style="color: #333;">Equipos Instalados</h4>
                <p><strong>Radios:</strong> ${reportData.basic.radiosInstalled || 0}</p>
                <p><strong>Antenas:</strong> ${reportData.basic.antennasInstalled || 0}</p>
                <p><strong>Cables:</strong> ${reportData.basic.cablesInstalled || 0}</p>
                <p><strong>Equipos registrados:</strong> ${reportData.appurtenances.length}</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <h4 style="color: #333;">Mediciones (OBLIGATORIAS)</h4>
                ${tapeDrpsHTML}
                ${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? 
                    `<p><strong>Tower Height:</strong> ${reportData.measurements.towerHeight || 'N/A'} (OBLIGATORIO)</p>
                     <p><strong>Tallest Point:</strong> ${reportData.measurements.tallestPoint || 'N/A'} (OBLIGATORIO)</p>` :
                    `<p><strong>Tower Height:</strong> ${reportData.measurements.towerHeight || 'No requerido'}</p>
                     <p><strong>Tallest Point:</strong> ${reportData.measurements.tallestPoint || 'No requerido'}</p>`}
            </div>
            
            <div style="margin-bottom: 15px;">
                <h4 style="color: #333;">GPS</h4>
                <p><strong>Latitud:</strong> ${reportData.gps.latitude?.toFixed(7) || 'N/A'}</p>
                <p><strong>Longitud:</strong> ${reportData.gps.longitude?.toFixed(7) || 'N/A'}</p>
                <p><strong>MÃ©todo:</strong> ${reportData.gps.manual ? 'Manual' : 'GPS AutomÃ¡tico'}</p>
                ${!reportData.gps.manual && reportData.gps.accuracy ? `<p><strong>PrecisiÃ³n:</strong> Â±${reportData.gps.accuracy.toFixed(1)}m</p>` : ''}
            </div>
            
            <div>
                <h4 style="color: #333;">DocumentaciÃ³n FotogrÃ¡fica</h4>
                <p><strong>Total de fotos:</strong> ${totalPhotos}</p>
                <p><strong>VersiÃ³n de la App:</strong> 9.30 - BÃºsqueda y EdiciÃ³n de Reportes</p>
            </div>
        </div>
    `;
    
    return summaryHTML;
}

function sendDetailedEmail(reportId) {
    const savedData = localStorage.getItem(reportId);
    if (!savedData) {
        showNotification('Reporte no encontrado', 'error');
        return;
    }
    
    const reportData = JSON.parse(savedData);
    const sectorsCount = parseInt(reportData.basic.sectorsCount) || 0;
    
    let sectorMeasurements = '';
    for (let i = 1; i <= sectorsCount; i++) {
        sectorMeasurements += `- Sector ${i} Tape Drop: ${reportData.measurements[`sector${i}TapeDrop`] || 'N/A'} feet (REQUIRED)\n`;
    }
    
    const emailSubject = `Tower Provider Report v9.30 - ${reportData.basic.siteName || 'N/A'} - ${reportId}`;
    
    const emailBody = `
TOWER PROVIDER REPORT v9.30 - Enhanced Search and Edit Features
===============================================

SITE INFORMATION:
- Tower Provider Site ID: ${reportData.basic.siteId || 'N/A'}
- Tower Provider Site Name: ${reportData.basic.siteName || 'N/A'}
- Customer Site ID: ${reportData.basic.customerSiteId || 'N/A'}
- Customer Site Name: ${reportData.basic.customerSiteName || 'N/A'}

INSTALLATION DETAILS:
- Number of Sectors: ${sectorsCount}
- Radios Installed: ${reportData.basic.radiosInstalled || 0}
- Antennas Installed: ${reportData.basic.antennasInstalled || 0}
- Cables Installed: ${reportData.basic.cablesInstalled || 0}
- Team Leader: ${reportData.basic.teamLeader || 'N/A'}
- Tower Top Installation: ${reportData.basic.towerTop === 'yes' ? 'Yes - At Tower Top' :
    reportData.basic.towerTop === 'near-top' ? 'Near Top (Within 10\' of top)' :
    'No - Below 10\' from top'}
- Completion Date: ${reportData.basic.completionDate || 'N/A'}

GPS LOCATION (REQUIRED):
- Latitude: ${reportData.gps.latitude || 'N/A'}
- Longitude: ${reportData.gps.longitude || 'N/A'}
- Method: ${reportData.gps.manual ? 'Manual Entry' : 'Automatic GPS'}
- Accuracy: ${reportData.gps.accuracy ? `Â±${reportData.gps.accuracy.toFixed(1)}m` : 'N/A'}

MEASUREMENTS (REQUIRED):
${sectorMeasurements}- Tower Height: ${reportData.measurements.towerHeight || 'N/A'} ${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? '(REQUIRED)' : '(Optional)'}
- Tallest Point: ${reportData.measurements.tallestPoint || 'N/A'} ${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? '(REQUIRED)' : '(Optional)'}

EQUIPMENT INSTALLED (${reportData.appurtenances.length} items):
${reportData.appurtenances.map((app, i) => 
    `${i + 1}. ${app.type} - ${app.manufacturer} ${app.model} (Qty: ${app.quantity}, Coax: ${app.coaxSize})`
).join('\n')}

PHOTO DOCUMENTATION (v9.30 - Enhanced Photos with Search/Edit):
- Total Photos: ${Object.values(reportData.photos).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0)}
${Object.entries(reportData.photos).map(([category, photos]) => {
    const catName = photoTypes.find(t => t.id === category)?.name || category;
    return `- ${catName}: ${photos ? photos.length : 0} photos`;
}).join('\n')}

REPORT DETAILS:
- Report ID: ${reportId}
- Submitted by: ${reportData.basic.submittedBy || 'Field Technician'}
- Email: ${reportData.basic.submittedByEmail || 'N/A'}
- Submission Time: ${new Date().toLocaleString()}
- Report Version: 9.30 - Enhanced with Search and Edit Features

---
This report has been submitted to SharePoint with enhanced photo functionality.
GPS coordinates were ${reportData.gps.manual ? 'manually entered' : 'automatically captured'}.
All required measurements have been completed.
Photos can now be searched, viewed, and edited after submission.

Newcomm Management Services Corp.
PO Box 4116, Vega Baja PR 00694
Phone: 787-718-2600
`.trim();
    
    const encodedBody = encodeURIComponent(emailBody);
    
    const mailtoLink = `mailto:accounting@newcomm2000.com?subject=${encodeURIComponent(emailSubject)}&body=${encodedBody}`;
    
    if (mailtoLink.length > 2000) {
        const shortBody = `
Tower Provider Report v9.30 - ${reportData.basic.siteName || 'N/A'}
Site ID: ${reportData.basic.siteId || 'N/A'}
Sectors: ${sectorsCount}
Report ID: ${reportId}
GPS: ${reportData.gps.latitude || 'N/A'}, ${reportData.gps.longitude || 'N/A'}
Tower Top: ${reportData.basic.towerTop === 'yes' ? 'Yes' : reportData.basic.towerTop === 'near-top' ? 'Near Top' : 'No'}

Full report saved in SharePoint with search and edit capabilities.
        `.trim();
        
        window.location.href = `mailto:accounting@newcomm2000.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(shortBody)}`;
    } else {
        window.location.href = mailtoLink;
    }
}

// Search and Edit Functions - NUEVAS PARA v9.30
function showReportSearch() {
    const searchHTML = `
        <div class="report-search-container" style="padding: 20px; background: #f5f5f5; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0066cc; margin-bottom: 15px;">ð Buscar Reporte para Editar</h3>
            <div class="form-group">
                <label>Ingrese ID del Reporte:</label>
                <input type="text" id="searchReportId" placeholder="ej: RPT-1234567890-12345" style="width: 100%;">
            </div>
            <button class="btn btn-primary" onclick="searchReport()">
                Buscar Reporte
            </button>
            <button class="btn btn-secondary" onclick="showRecentReports()">
                Ver Reportes Recientes
            </button>
        </div>
        <div id="searchResults"></div>
    `;
    
    document.getElementById('submitStatus').innerHTML = searchHTML;
}

function searchReport() {
    const reportId = document.getElementById('searchReportId').value.trim();
    
    if (!reportId) {
        showNotification('Por favor ingrese un ID de reporte', 'error');
        return;
    }
    
    const savedData = localStorage.getItem(reportId);
    
    if (savedData) {
        const reportData = JSON.parse(savedData);
        showReportDetails(reportId, reportData);
    } else {
        document.getElementById('searchResults').innerHTML = `
            <div style="background: #ffebee; padding: 15px; border-radius: 6px; margin-top: 20px;">
                <p style="color: #c62828;">â No se encontrÃ³ el reporte con ID: ${reportId}</p>
            </div>
        `;
    }
}

function showRecentReports() {
    const reports = [];
    
    // Buscar todos los reportes en localStorage
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('RPT-')) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                reports.push({
                    id: key,
                    siteName: data.basic?.siteName || 'Sin nombre',
                    date: data.basic?.completionDate || 'Sin fecha',
                    submittedBy: data.basic?.submittedBy || 'Desconocido'
                });
            } catch (e) {
                console.error('Error parsing report:', key);
            }
        }
    }
    
    // Ordenar por mÃ¡s reciente
    reports.sort((a, b) => {
        const idA = parseInt(a.id.split('-')[1]);
        const idB = parseInt(b.id.split('-')[1]);
        return idB - idA;
    });
    
    // Mostrar mÃ¡ximo 10 reportes recientes
    const recentReports = reports.slice(0, 10);
    
    if (recentReports.length === 0) {
        document.getElementById('searchResults').innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px;">
                <p style="color: #856404;">No hay reportes guardados en este dispositivo.</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div style="margin-top: 20px;">
            <h4 style="color: #0066cc;">Reportes Recientes:</h4>
            <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    recentReports.forEach(report => {
        html += `
            <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 6px; border: 1px solid #ddd; cursor: pointer;"
                 onclick="searchReportById('${report.id}')">
                <div style="font-weight: bold; color: #0066cc;">${report.siteName}</div>
                <div style="font-size: 12px; color: #666;">
                    ID: ${report.id}<br>
                    Fecha: ${report.date}<br>
                    Por: ${report.submittedBy}
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    document.getElementById('searchResults').innerHTML = html;
}

function searchReportById(reportId) {
    document.getElementById('searchReportId').value = reportId;
    searchReport();
}

function showReportDetails(reportId, reportData) {
    let html = `
        <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3 style="color: #2e7d32;">â Reporte Encontrado</h3>
            <div style="margin: 15px 0;">
                <strong>ID:</strong> ${reportId}<br>
                <strong>Sitio:</strong> ${reportData.basic?.siteName || 'N/A'}<br>
                <strong>Fecha:</strong> ${reportData.basic?.completionDate || 'N/A'}<br>
                <strong>Por:</strong> ${reportData.basic?.submittedBy || 'N/A'}
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="editReportPhotos('${reportId}')">
                    ð· Editar Fotos
                </button>
                <button class="btn btn-secondary" onclick="viewReportPhotos('${reportId}')">
                    ðï¸ Ver Fotos
                </button>
                <button class="btn btn-danger" onclick="deleteReport('${reportId}')">
                    ðï¸ Eliminar Reporte
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('searchResults').innerHTML = html;
}

function editReportPhotos(reportId) {
    const savedData = localStorage.getItem(reportId);
    if (!savedData) {
        showNotification('Reporte no encontrado', 'error');
        return;
    }
    
    // Cargar los datos del reporte en la aplicaciÃ³n
    reportData = JSON.parse(savedData);
    
    // Asegurarse de que photoTypes estÃ© actualizado
    updatePhotoTypes();
    
    // Ir directamente al paso de fotos
    currentStep = 3;
    showStep(3);
    
    // Agregar indicador de que estamos editando
    const header = document.querySelector('#section3 h2');
    header.innerHTML = `Editando Fotos - ${reportId}`;
    
    // Agregar botÃ³n para guardar cambios
    const btnGroup = document.querySelector('#section3 .btn-group');
    btnGroup.innerHTML = `
        <button class="btn btn-secondary" onclick="cancelEdit()">
            â Cancelar EdiciÃ³n
        </button>
        <button class="btn btn-success" onclick="saveEditedReport('${reportId}')">
            ð¾ Guardar Cambios
        </button>
    `;
    
    showNotification('Modo de ediciÃ³n activado. Puede agregar o eliminar fotos.', 'info');
}

function viewReportPhotos(reportId) {
    const savedData = localStorage.getItem(reportId);
    if (!savedData) {
        showNotification('Reporte no encontrado', 'error');
        return;
    }
    
    const report = JSON.parse(savedData);
    let photoCount = 0;
    let html = `
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3 style="color: #0066cc;">ð¸ Fotos del Reporte ${reportId}</h3>
    `;
    
    // Mostrar todas las fotos por categorÃ­a
    Object.keys(report.photos).forEach(category => {
        const photos = report.photos[category] || [];
        if (photos.length > 0) {
            photoCount += photos.length;
            html += `
                <div style="margin: 20px 0;">
                    <h4 style="color: #666; border-bottom: 2px solid #eee; padding-bottom: 5px;">
                        ${category.replace(/_/g, ' ').toUpperCase()} (${photos.length} fotos)
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
            `;
            
            photos.forEach((photo, index) => {
                html += `
                    <div style="position: relative;">
                        <img src="${photo.data}" 
                             style="width: 150px; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                             onclick="viewFullPhoto('${photo.data}')"
                             alt="${category} - Foto ${index + 1}">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; 
                                    background: rgba(0,0,0,0.7); color: white; 
                                    padding: 2px 5px; font-size: 10px;">
                            ${new Date(photo.timestamp).toLocaleDateString()}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
    });
    
    html += `
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                <strong>Total de fotos:</strong> ${photoCount}
            </div>
            <button class="btn btn-primary" onclick="showReportSearch()" style="margin-top: 20px;">
                â Volver a BÃºsqueda
            </button>
        </div>
    `;
    
    document.getElementById('searchResults').innerHTML = html;
}

function viewFullPhoto(photoData) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <img src="${photoData}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
        <button onclick="this.parentElement.remove()" 
                style="position: absolute; top: 20px; right: 20px; 
                       background: white; color: black; border: none; 
                       padding: 10px 20px; border-radius: 6px; cursor: pointer;">
            â Cerrar
        </button>
    `;
    
    document.body.appendChild(modal);
}

function cancelEdit() {
    if (confirm('Â¿EstÃ¡ seguro de cancelar la ediciÃ³n? Los cambios no guardados se perderÃ¡n.')) {
        showReportSearch();
    }
}

function saveEditedReport(reportId) {
    try {
        // Guardar los cambios
        localStorage.setItem(reportId, JSON.stringify(reportData));
        
        showNotification('Cambios guardados exitosamente', 'success');
        
        // Mostrar opciones despuÃ©s de guardar
        document.getElementById('submitStatus').innerHTML = `
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2e7d32;">â Cambios Guardados</h3>
                <p>Las fotos del reporte ${reportId} han sido actualizadas.</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="resendToSharePoint('${reportId}')">
                        ð¤ Reenviar a SharePoint
                    </button>
                    <button class="btn btn-secondary" onclick="showReportSearch()">
                        ð Buscar Otro Reporte
                    </button>
                    <button class="btn btn-success" onclick="startNewReport()">
                        â Nuevo Reporte
                    </button>
                </div>
            </div>
        `;
    } catch (error) {
        showNotification('Error al guardar cambios: ' + error.message, 'error');
    }
}

async function resendToSharePoint(reportId) {
    const savedData = localStorage.getItem(reportId);
    if (!savedData) {
        showNotification('Reporte no encontrado', 'error');
        return;
    }
    
    const data = JSON.parse(savedData);
    document.getElementById('submitStatus').innerHTML = '<div class="spinner"></div><p>Reenviando a SharePoint...</p>';
    
    const sent = await
