<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0066cc">
<meta name="author" content="Newcomm Management Services Corp.">
<meta name="copyright" content="© 2025 Newcomm Management Services Corp.">
<meta name="description" content="Tower Provider Report - Professional Mobile Application">
<title>Tower Report Mobile v6.0 - SharePoint Auth</title>

<!-- MSAL.js desde CDN -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
background-color: #f5f5f5;
color: #333;
overflow-x: hidden;
}

.app-container {
max-width: 600px;
margin: 0 auto;
background-color: white;
min-height: 100vh;
position: relative;
}

/* Login Screen */
.login-screen {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
min-height: 100vh;
padding: 20px;
background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
color: white;
}

.login-container {
background: white;
padding: 40px;
border-radius: 10px;
box-shadow: 0 10px 30px rgba(0,0,0,0.2);
max-width: 400px;
width: 100%;
text-align: center;
}

.login-logo {
width: 150px;
margin-bottom: 30px;
}

.login-title {
color: #333;
font-size: 24px;
margin-bottom: 10px;
}

.login-subtitle {
color: #666;
font-size: 14px;
margin-bottom: 30px;
}

.login-btn {
background-color: #0066cc;
color: white;
padding: 15px 30px;
border: none;
border-radius: 6px;
font-size: 16px;
font-weight: 500;
cursor: pointer;
width: 100%;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
transition: all 0.3s;
}

.login-btn:hover {
background-color: #0052a3;
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,102,204,0.3);
}

.login-error {
background-color: #ffebee;
color: #c62828;
padding: 10px;
border-radius: 6px;
margin-top: 20px;
font-size: 14px;
}

.login-info {
background-color: #e3f2fd;
color: #1565c0;
padding: 15px;
border-radius: 6px;
margin-bottom: 20px;
font-size: 14px;
text-align: left;
}

.user-info {
background-color: #e3f2fd;
padding: 10px 15px;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 14px;
}

.user-info strong {
color: #1565c0;
}

.logout-btn {
background-color: #f44336;
color: white;
padding: 5px 15px;
border: none;
border-radius: 4px;
font-size: 12px;
cursor: pointer;
}

/* Header */
.header {
background-color: #0066cc;
color: white;
padding: 15px;
text-align: center;
position: sticky;
top: 0;
z-index: 100;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
font-size: 20px;
font-weight: 500;
}

.step-indicator {
display: flex;
justify-content: center;
padding: 20px;
gap: 10px;
}

.step {
width: 30px;
height: 30px;
border-radius: 50%;
background-color: #e0e0e0;
display: flex;
align-items: center;
justify-content: center;
font-size: 14px;
transition: all 0.3s;
}

.step.active {
background-color: #0066cc;
color: white;
}

.step.completed {
background-color: #4caf50;
color: white;
}

/* Form Sections */
.form-section {
display: none;
padding: 20px;
animation: slideIn 0.3s ease-out;
}

.form-section.active {
display: block;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateX(20px);
}
to {
opacity: 1;
transform: translateX(0);
}
}

.form-group {
margin-bottom: 20px;
}

label {
display: block;
margin-bottom: 5px;
font-weight: 500;
color: #555;
}

input[type="text"],
input[type="number"],
input[type="date"],
select,
textarea {
width: 100%;
padding: 12px;
border: 1px solid #ddd;
border-radius: 6px;
font-size: 16px;
transition: border-color 0.3s;
}

input:focus,
select:focus,
textarea:focus {
outline: none;
border-color: #0066cc;
}

.required {
color: #f44336;
}

/* Buttons */
.btn {
padding: 12px 24px;
border: none;
border-radius: 6px;
font-size: 16px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s;
text-align: center;
display: inline-block;
}

.btn-primary {
background-color: #0066cc;
color: white;
}

.btn-primary:hover {
background-color: #0052a3;
}

.btn-success {
background-color: #4caf50;
color: white;
}

.btn-secondary {
background-color: #757575;
color: white;
}

.btn-danger {
background-color: #f44336;
color: white;
}

.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}

.btn-block {
width: 100%;
display: block;
}

.btn-group {
display: flex;
gap: 10px;
margin-top: 30px;
}

/* GPS Status */
.gps-status {
padding: 10px;
border-radius: 6px;
margin-top: 10px;
font-size: 14px;
}

.gps-status.success {
background-color: #e8f5e9;
color: #2e7d32;
}

.gps-status.error {
background-color: #ffebee;
color: #c62828;
}

.gps-status.warning {
background-color: #fff3cd;
color: #856404;
}

/* Appurtenance List */
.appurtenance-list {
margin-top: 20px;
}

.appurtenance-item {
background-color: #f5f5f5;
padding: 15px;
border-radius: 6px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
}

.appurtenance-info h4 {
margin: 0 0 5px 0;
color: #0066cc;
}

.appurtenance-info p {
margin: 0;
font-size: 14px;
color: #666;
}

/* Photo Section */
.photo-requirements {
background-color: #e3f2fd;
padding: 15px;
border-radius: 6px;
margin-bottom: 20px;
}

.photo-requirements h3 {
margin-bottom: 10px;
color: #1565c0;
}

.photo-requirements ul {
margin-left: 20px;
}

.photo-grid {
display: grid;
gap: 15px;
}

.photo-item {
background-color: #f5f5f5;
padding: 15px;
border-radius: 6px;
text-align: center;
}

.photo-item h4 {
margin-bottom: 10px;
color: #333;
font-size: 16px;
}

.photo-capture {
position: relative;
margin-bottom: 10px;
}

.camera-input {
display: none;
}

.camera-btn {
background-color: #0066cc;
color: white;
padding: 10px 20px;
border-radius: 6px;
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 8px;
}

.camera-btn:hover {
background-color: #0052a3;
}

.photo-preview {
margin-top: 10px;
max-width: 100%;
max-height: 200px;
border-radius: 6px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.photo-count {
font-size: 14px;
color: #666;
margin-top: 5px;
}

.photo-status {
display: inline-block;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
margin-top: 5px;
}

.photo-status.complete {
background-color: #4caf50;
color: white;
}

.photo-status.pending {
background-color: #ff9800;
color: white;
}

/* Review Section */
.review-section {
background-color: #f5f5f5;
padding: 15px;
border-radius: 6px;
margin-bottom: 15px;
}

.review-section h3 {
margin-bottom: 10px;
color: #0066cc;
}

.review-item {
display: flex;
justify-content: space-between;
padding: 5px 0;
border-bottom: 1px solid #e0e0e0;
}

.review-item:last-child {
border-bottom: none;
}

.review-label {
font-weight: 500;
color: #666;
}

.review-value {
color: #333;
}

/* Loading Spinner */
.spinner {
border: 3px solid #f3f3f3;
border-top: 3px solid #0066cc;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 20px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Notifications */
.notification {
position: fixed;
top: 70px;
left: 50%;
transform: translateX(-50%);
padding: 15px 20px;
border-radius: 6px;
color: white;
font-weight: 500;
z-index: 1000;
animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
from {
opacity: 0;
transform: translate(-50%, -20px);
}
to {
opacity: 1;
transform: translate(-50%, 0);
}
}

.notification.success {
background-color: #4caf50;
}

.notification.error {
background-color: #f44336;
}

.notification.info {
background-color: #2196f3;
}

/* Copyright Footer */
.copyright-footer {
text-align: center;
padding: 20px;
font-size: 12px;
color: #999;
border-top: 1px solid #eee;
margin-top: 40px;
}

/* Responsive */
@media (max-width: 480px) {
.header h1 {
font-size: 18px;
}

.btn {
font-size: 14px;
padding: 10px 20px;
}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
<div class="login-container">
<h2 class="login-title">Tower Provider Report</h2>
<p class="login-subtitle">Inicie sesión con su cuenta de Microsoft 365</p>

<button class="login-btn" onclick="signIn()">
<svg width="20" height="20" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect x="1" y="1" width="9" height="9" fill="#F25022"/>
<rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
<rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
<rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
</svg>
Iniciar sesión con Microsoft
</button>

<div id="loginError" style="display: none;" class="login-error"></div>

<div style="margin-top: 20px; font-size: 12px; color: #666;">
<p>Versión 6.0 - SharePoint Integrado</p>
</div>
</div>
</div>

<!-- Main App (Hidden until authenticated) -->
<div id="mainApp" class="app-container" style="display: none;">
<div class="user-info">
<span>Usuario: <strong id="userDisplayName">-</strong></span>
<button class="logout-btn" onclick="signOut()">Cerrar Sesión</button>
</div>

<header class="header">
<h1>Tower Provider Report</h1>
<div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Versión 6.0 - SharePoint Auth</div>
</header>

<div class="step-indicator">
<div class="step active" id="step1">1</div>
<div class="step" id="step2">2</div>
<div class="step" id="step3">3</div>
<div class="step" id="step4">4</div>
<div class="step" id="step5">5</div>
</div>

<!-- Step 1: Basic Information -->
<div class="form-section active" id="section1">
<h2>Información Básica</h2>

<!-- Storage management -->
<div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<span>Espacio usado: <span id="storageIndicator">calculando...</span></span>
<button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 5px 10px;">
Limpiar datos
</button>
</div>
<div style="font-size: 11px; color: #666; margin-top: 5px;">App v6.0 SharePoint</div>
</div>

<div class="form-group">
<label>Tower Provider Site ID <span class="required">*</span></label>
<input type="text" id="siteId" placeholder="ej: 10028307" required>
</div>

<div class="form-group">
<label>Tower Provider Site Name <span class="required">*</span></label>
<input type="text" id="siteName" placeholder="ej: Vega Baja DT" required>
</div>

<div class="form-group">
<label>Customer Site ID <span class="required">*</span></label>
<input type="text" id="customerSiteId" placeholder="ej: 10028307" required>
</div>

<div class="form-group">
<label>Customer Site Name <span class="required">*</span></label>
<input type="text" id="customerSiteName" placeholder="ej: Vega Baja DT" required>
</div>

<div class="form-group">
<label>Radios Installed <span class="required">*</span></label>
<input type="number" id="radiosInstalled" min="0" placeholder="3" required>
</div>

<div class="form-group">
<label>Antennas Installed <span class="required">*</span></label>
<input type="number" id="antennasInstalled" min="0" placeholder="6" required>
</div>

<div class="form-group">
<label>Team Leader <span class="required">*</span></label>
<input type="text" id="teamLeader" placeholder="ej: Christopher Rodriguez" required>
</div>

<div class="form-group">
<label>Tower Top Installation <span class="required">*</span></label>
<select id="towerTop" required onchange="updateMeasurementRequirements()">
<option value="">Seleccione una opción</option>
<option value="yes">Yes - At Tower Top</option>
<option value="near-top">Near Top (Within 10' of top)</option>
<option value="no">No - Below 10' from top</option>
</select>
</div>

<div class="form-group">
<label>Completion Date <span class="required">*</span></label>
<input type="date" id="completionDate" required>
</div>

<div class="form-group">
<label>TP Tenant <span class="required">*</span></label>
<input type="text" id="tpTenant" placeholder="ej: Liberty" required>
</div>

<!-- GPS Section - Now Required -->
<div style="background: #ffebee; padding: 15px; border-radius: 6px; margin-top: 20px; margin-bottom: 20px;">
<h3 style="color: #c62828; margin-bottom: 10px;">📍 Ubicación GPS (OBLIGATORIO)</h3>
<p style="font-size: 14px; color: #666; margin-bottom: 15px;">
La ubicación GPS es <strong>obligatoria</strong> para continuar. Si el GPS automático falla, debe ingresar las coordenadas manualmente.
</p>
<button class="btn btn-success btn-block" onclick="getGPSLocation()">
📍 Obtener Ubicación GPS
</button>
<div id="gpsStatus"></div>
</div>

<!-- Sección de mediciones actualizada -->
<div style="background: #ffebee; padding: 15px; border-radius: 6px; margin-top: 20px;">
<h3 style="color: #c62828; margin-bottom: 15px;">📏 Mediciones de Torre (OBLIGATORIO)</h3>
<p style="font-size: 14px; color: #666; margin-bottom: 15px;">
<strong>Tape Drop de Sectores:</strong> Siempre obligatorio para todos los sectores.<br>
<strong>Tower Height y Tallest Point:</strong> <span id="heightRequirementText">Seleccione "Tower Top Installation" para ver requisitos</span>
</p>

<div class="form-group">
<label>Tower Height (ft) <span id="towerHeightRequired" style="display: none;" class="required">*</span></label>
<input type="text" id="towerHeight" placeholder="ej: 38.220">
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
<div class="form-group">
<label>Sector 1 Tape Drop <span class="required">*</span></label>
<input type="text" id="sector1TapeDrop" placeholder="ej: 15.5 ft" required>
</div>
<div class="form-group">
<label>Sector 2 Tape Drop <span class="required">*</span></label>
<input type="text" id="sector2TapeDrop" placeholder="ej: 16.2 ft" required>
</div>
<div class="form-group">
<label>Sector 3 Tape Drop <span class="required">*</span></label>
<input type="text" id="sector3TapeDrop" placeholder="ej: 14.8 ft" required>
</div>
</div>

<div class="form-group">
<label>Tallest Point Measurement (ft) <span id="tallestPointRequired" style="display: none;" class="required">*</span></label>
<input type="text" id="tallestPoint" placeholder="ej: 15.570">
</div>
</div>

<div class="btn-group">
<button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
Siguiente →
</button>
</div>
</div>

<!-- Step 2: Appurtenance Information -->
<div class="form-section" id="section2">
<h2>Información de Equipos</h2>

<button class="btn btn-primary btn-block" onclick="showAppurtenanceForm()">
+ Agregar Equipo
</button>

<div id="appurtenanceForm" style="display: none; margin-top: 20px;">
<div class="form-group">
<label>Type</label>
<select id="appType">
<option value="Antenna">Antenna</option>
<option value="RRU">RRU</option>
<option value="Cable">Cable</option>
<option value="Other">Other</option>
</select>
</div>

<div class="form-group">
<label>Rad Center</label>
<input type="text" id="appRadCenter" placeholder="50">
</div>

<div class="form-group">
<label>Manufacturer</label>
<input type="text" id="appManufacturer" placeholder="ej: Ericsson">
</div>

<div class="form-group">
<label>Model</label>
<input type="text" id="appModel" placeholder="ej: 840590003">
</div>

<div class="form-group">
<label>Quantity</label>
<input type="number" id="appQuantity" min="1" value="1">
</div>

<div class="form-group">
<label>Coax Size (if applicable)</label>
<input type="text" id="appCoaxSize" placeholder="Optional">
</div>

<button class="btn btn-success" onclick="addAppurtenance()">Guardar</button>
<button class="btn btn-secondary" onclick="cancelAppurtenance()">Cancelar</button>
</div>

<div class="appurtenance-list" id="appurtenanceList"></div>

<div class="btn-group">
<button class="btn btn-secondary" onclick="previousStep()">
← Anterior
</button>
<button class="btn btn-primary" onclick="nextStep()">
Siguiente →
</button>
</div>
</div>

<!-- Step 3: Photo Documentation -->
<div class="form-section" id="section3">
<h2>Documentación Fotográfica</h2>

<div class="photo-requirements">
<h3>📷 Fotos Requeridas</h3>
<ul>
<li>Tome al menos 5 fotos en total para continuar</li>
<li>Puede tomar múltiples fotos por categoría</li>
<li>Las fotos se guardan automáticamente</li>
</ul>
<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
<strong>Modo Demo:</strong>
<button class="btn btn-secondary" onclick="skipPhotoValidation()" style="margin-left: 10px;">
Saltar validación de fotos
</button>
</div>
</div>

<div class="photo-grid" id="photoGrid">
<!-- Photo items will be generated by JavaScript -->
</div>

<div class="btn-group">
<button class="btn btn-secondary" onclick="previousStep()">
← Anterior
</button>
<button class="btn btn-primary" onclick="nextStep()">
Siguiente →
</button>
</div>
</div>

<!-- Step 4: Review -->
<div class="form-section" id="section4">
<h2>Revisar Información</h2>

<div class="review-section">
<h3>Información del Sitio</h3>
<div id="siteReview"></div>
</div>

<div class="review-section">
<h3>Equipos Instalados</h3>
<div id="equipmentReview"></div>
</div>

<div class="review-section">
<h3>Documentación Fotográfica</h3>
<div id="photoReview"></div>
</div>

<div class="btn-group">
<button class="btn btn-secondary" onclick="previousStep()">
← Anterior
</button>
<button class="btn btn-primary" onclick="nextStep()">
Siguiente →
</button>
</div>
</div>

<!-- Step 5: Submit -->
<div class="form-section" id="section5">
<h2>Enviar Reporte</h2>

<div style="text-align: center; padding: 40px 20px;">
<h3>¿Está listo para enviar el reporte?</h3>
<p style="margin: 20px 0; color: #666;">
Al enviar, se generará un PDF y se enviará automáticamente a accounting@newcomm2000.com
</p>

<button class="btn btn-primary btn-block" onclick="showReportSummary()" style="margin-bottom: 10px; font-size: 16px;">
📄 Ver Resumen del Reporte
</button>

<button class="btn btn-success btn-block" onclick="submitReport()" style="font-size: 18px; padding: 15px;">
✓ Enviar Reporte
</button>

<div id="submitStatus" style="margin-top: 20px;"></div>
</div>

<div class="btn-group">
<button class="btn btn-secondary" onclick="previousStep()">
← Anterior
</button>
</div>
</div>

<!-- Copyright Footer -->
<div class="copyright-footer">
© 2025 Newcomm Management Services Corp. • All rights reserved • v6.0
</div>
</div>

<script>
// MSAL Configuration - Optimizado para móviles
const msalConfig = {
auth: {
clientId: '928a4b98-5894-4a97-b8b1-d8c489c22216',
authority: 'https://login.microsoftonline.com/93a307af-2b18-419b-82a4-da0d26ae31d0',
redirectUri: window.location.origin + window.location.pathname,
navigateToLoginRequestUrl: false // Importante para móviles
},
cache: {
cacheLocation: 'localStorage', // Cambiado a localStorage para persistencia
storeAuthStateInCookie: true // Habilitado para mejor compatibilidad móvil
},
system: {
loggerOptions: {
loggerCallback: (level, message, containsPii) => {
if (containsPii) return;
console.log(message);
},
logLevel: msal.LogLevel.Warning
}
}
};

// Create MSAL instance
const msalInstance = new msal.PublicClientApplication(msalConfig);

// Login request configuration
const loginRequest = {
scopes: ['User.Read'],
prompt: 'select_account' // Fuerza selección de cuenta en móviles
};

// Global variables
let currentAccount = null;
let currentStep = 1;
let reportData = {
basic: {},
gps: {},
appurtenances: [],
photos: {},
measurements: {},
metadata: {
appVersion: '6.0',
deviceInfo: navigator.userAgent,
createdAt: new Date().toISOString()
}
};

// Photo types configuration
const photoTypes = [
{ id: 'equipment_room', name: 'Post Equipment Room or Pad', required: 4, description: 'Equipment room/pad photos' },
{ id: 'cabinet_doors', name: 'Cabinet or Shelter Doors', required: 2, description: 'Open and closed door photos' },
{ id: 'safety_lines', name: 'Safety Lines', required: 4, description: 'All safety line assemblies' },
{ id: 'antenna_labels', name: 'Antenna Labels', required: 6, description: 'Labels for all antennas' },
{ id: 'radio_labels', name: 'Radio Labels', required: 3, description: 'Labels for all radios' },
{ id: 'compound_post', name: 'Compound Post Pictures', required: 4, description: 'Compound area photos' },
{ id: 'sectors_ground', name: 'Sectors from Ground', required: 3, description: 'Sectors 1, 2, and 3' },
{ id: 'sector_posts', name: 'Sector Post Pictures', required: 3, description: 'Detailed sector photos' },
{ id: 'tape_measurements', name: 'Tape Drop Measurements', required: 6, description: 'All measurement photos' },
{ id: 'tower_measurements', name: 'Tower Height Measurements', required: 2, description: 'Tower and tallest point' },
{ id: 'beacon', name: 'Beacon Photos', required: 2, description: 'Beacon and label' }
];

// Initialize MSAL - Mejorado para móviles
async function initializeMsal() {
try {
// Esperar a que MSAL esté completamente inicializado
await msalInstance.initialize();

// Manejar el redirect promise
const response = await msalInstance.handleRedirectPromise();

if (response) {
// Usuario viene de un redirect
currentAccount = response.account;
// Guardar el estado de autenticación
localStorage.setItem('isAuthenticated', 'true');
localStorage.setItem('userAccount', JSON.stringify(currentAccount));
await getUserDetails();
showMainApp();
} else {
// Verificar si hay cuentas en caché
const accounts = msalInstance.getAllAccounts();
if (accounts.length > 0) {
currentAccount = accounts[0];
msalInstance.setActiveAccount(currentAccount);

// Verificar si tenemos un token válido
try {
await msalInstance.acquireTokenSilent({
...loginRequest,
account: currentAccount
});
await getUserDetails();
showMainApp();
} catch (error) {
// Token expirado, necesita login
console.log('Token expired, need to login again');
localStorage.removeItem('isAuthenticated');
localStorage.removeItem('userAccount');
}
} else {
// Verificar localStorage para sesión persistente
const savedAuth = localStorage.getItem('isAuthenticated');
const savedAccount = localStorage.getItem('userAccount');

if (savedAuth === 'true' && savedAccount) {
try {
currentAccount = JSON.parse(savedAccount);
// Intentar obtener token silenciosamente
const tokenResponse = await msalInstance.acquireTokenSilent({
...loginRequest,
account: currentAccount,
forceRefresh: true
});
if (tokenResponse) {
await getUserDetails();
showMainApp();
}
} catch (error) {
console.log('Silent token acquisition failed:', error);
localStorage.removeItem('isAuthenticated');
localStorage.removeItem('userAccount');
}
}
}
}
} catch (error) {
console.error('Error during initialization:', error);
showLoginError('Error durante inicialización: ' + error.message);
}
}

// Sign in function - Optimizado para móviles
async function signIn() {
try {
// Detectar si es móvil
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

if (isMobile) {
// En móviles, usar redirect en lugar de popup
await msalInstance.loginRedirect(loginRequest);
} else {
// En desktop, intentar popup primero
try {
const response = await msalInstance.loginPopup(loginRequest);
currentAccount = response.account;
msalInstance.setActiveAccount(currentAccount);

// Guardar estado de autenticación
localStorage.setItem('isAuthenticated', 'true');
localStorage.setItem('userAccount', JSON.stringify(currentAccount));

await getUserDetails();
showMainApp();
} catch (popupError) {
console.error('Popup blocked, using redirect:', popupError);
await msalInstance.loginRedirect(loginRequest);
}
}
} catch (error) {
console.error('Login error:', error);
showLoginError('Error al iniciar sesión: ' + error.message);
}
}

// Sign out function - Actualizado
async function signOut() {
// Limpiar localStorage
localStorage.removeItem('isAuthenticated');
localStorage.removeItem('userAccount');
localStorage.removeItem('towerReport');

const logoutRequest = {
account: currentAccount,
postLogoutRedirectUri: window.location.origin + window.location.pathname
};
await msalInstance.logoutRedirect(logoutRequest);
}

// Get user details - Mejorado con reintentos
async function getUserDetails() {
try {
const tokenResponse = await msalInstance.acquireTokenSilent({
scopes: ['User.Read'],
account: currentAccount
});

const response = await fetch('https://graph.microsoft.com/v1.0/me', {
headers: {
'Authorization': `Bearer ${tokenResponse.accessToken}`
}
});

if (response.ok) {
const userData = await response.json();
document.getElementById('userDisplayName').textContent = userData.displayName || currentAccount.name;

// Store user info for reports
reportData.metadata.submittedBy = userData.displayName || currentAccount.name;
reportData.metadata.submittedByEmail = userData.mail || userData.userPrincipalName || currentAccount.username;

// Guardar información del usuario
localStorage.setItem('userName', userData.displayName || currentAccount.name);
localStorage.setItem('userEmail', userData.mail || userData.userPrincipalName || currentAccount.username);
}
} catch (error) {
console.error('Error getting user details:', error);

// Usar información guardada si está disponible
const savedName = localStorage.getItem('userName');
const savedEmail = localStorage.getItem('userEmail');

if (savedName) {
document.getElementById('userDisplayName').textContent = savedName;
reportData.metadata.submittedBy = savedName;
reportData.metadata.submittedByEmail = savedEmail || currentAccount.username;
} else {
document.getElementById('userDisplayName').textContent = currentAccount.name || 'Usuario';
reportData.metadata.submittedBy = currentAccount.name || 'Usuario';
reportData.metadata.submittedByEmail = currentAccount.username || 'unknown@email.com';
}
}
}

// Show login error
function showLoginError(message) {
const errorDiv = document.getElementById('loginError');
errorDiv.textContent = message;
errorDiv.style.display = 'block';
}

// Show main app - Con verificación adicional
function showMainApp() {
console.log('Showing main app for user:', currentAccount?.name);

// Asegurar que tenemos una cuenta válida
if (!currentAccount) {
console.error('No current account found');
location.reload();
return;
}

document.getElementById('loginScreen').style.display = 'none';
document.getElementById('mainApp').style.display = 'block';

// Prevenir el botón de retroceso en móviles
if (window.history && window.history.pushState) {
window.history.pushState(null, null, window.location.href);
window.onpopstate = function () {
window.history.pushState(null, null, window.location.href);
};
}

// Initialize app
document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
generatePhotoGrid();
loadSavedData();
updateStorageIndicator();
optimizeStorage();

// Guardar estado de la aplicación
sessionStorage.setItem('appState', 'mainApp');
}

// Función para actualizar los requisitos de medición según Tower Top Installation
function updateMeasurementRequirements() {
const towerTopValue = document.getElementById('towerTop').value;
const towerHeightRequired = document.getElementById('towerHeightRequired');
const tallestPointRequired = document.getElementById('tallestPointRequired');
const heightRequirementText = document.getElementById('heightRequirementText');

const towerHeightInput = document.getElementById('towerHeight');
const tallestPointInput = document.getElementById('tallestPoint');

if (towerTopValue === 'yes' || towerTopValue === 'near-top') {
// Si está en el tope o cerca del tope, tower height y tallest point son obligatorios
towerHeightRequired.style.display = 'inline';
tallestPointRequired.style.display = 'inline';
towerHeightInput.setAttribute('required', 'required');
tallestPointInput.setAttribute('required', 'required');
heightRequirementText.innerHTML = '<strong style="color: #c62828;">OBLIGATORIO</strong> - Instalación en el tope o cerca del tope';
} else if (towerTopValue === 'no') {
// Si no está en el tope, son opcionales
towerHeightRequired.style.display = 'none';
tallestPointRequired.style.display = 'none';
towerHeightInput.removeAttribute('required');
tallestPointInput.removeAttribute('required');
heightRequirementText.innerHTML = '<strong style="color: #1565c0;">OPCIONAL</strong> - Instalación debajo de 10\' del tope';
} else {
// No se ha seleccionado nada
heightRequirementText.textContent = 'Seleccione "Tower Top Installation" para ver requisitos';
}
}

// Navigation functions
function nextStep() {
if (validateCurrentStep()) {
saveCurrentStep();
if (currentStep < 5) {
currentStep++;
showStep(currentStep);
}
}
}

function previousStep() {
if (currentStep > 1) {
currentStep--;
showStep(currentStep);
}
}

function showStep(step) {
document.querySelectorAll('.form-section').forEach(section => {
section.classList.remove('active');
});

document.getElementById('section' + step).classList.add('active');

document.querySelectorAll('.step').forEach((stepEl, index) => {
stepEl.classList.remove('active', 'completed');
if (index + 1 < step) {
stepEl.classList.add('completed');
} else if (index + 1 === step) {
stepEl.classList.add('active');
}
});

if (step === 4) {
updateReview();
}

window.scrollTo(0, 0);
}

// Validation functions - ACTUALIZADO PARA GPS Y MEDICIONES OBLIGATORIAS
function validateCurrentStep() {
switch(currentStep) {
case 1:
const requiredFields = ['siteId', 'siteName', 'customerSiteId', 'customerSiteName',
'radiosInstalled', 'antennasInstalled', 'teamLeader', 'towerTop',
'completionDate', 'tpTenant'];
for (let field of requiredFields) {
if (!document.getElementById(field).value) {
showNotification('Por favor complete todos los campos requeridos', 'error');
document.getElementById(field).focus();
return false;
}
}

// GPS ES OBLIGATORIO - NO SE PUEDE CONTINUAR SIN GPS
if (!reportData.gps.latitude || !reportData.gps.longitude) {
showNotification('⚠️ DEBE capturar o ingresar las coordenadas GPS para continuar', 'error');
// Mostrar opción manual si aún no está visible
const statusDiv = document.getElementById('gpsStatus');
if (!statusDiv.querySelector('#manualLat')) {
showManualGPS();
}
// Scroll hasta la sección de GPS
document.getElementById('gpsStatus').scrollIntoView({ behavior: 'smooth', block: 'center' });
return false;
}

// VALIDAR TAPE DROP DE SECTORES (SIEMPRE OBLIGATORIO)
const sectorFields = ['sector1TapeDrop', 'sector2TapeDrop', 'sector3TapeDrop'];
for (let field of sectorFields) {
if (!document.getElementById(field).value) {
showNotification('⚠️ Las mediciones Tape Drop de TODOS los sectores son OBLIGATORIAS', 'error');
document.getElementById(field).focus();
document.getElementById(field).scrollIntoView({ behavior: 'smooth', block: 'center' });
return false;
}
}

// VALIDAR TOWER HEIGHT Y TALLEST POINT SI ESTÁ EN EL TOPE O CERCA
const towerTopValue = document.getElementById('towerTop').value;
if (towerTopValue === 'yes' || towerTopValue === 'near-top') {
if (!document.getElementById('towerHeight').value) {
showNotification('⚠️ Tower Height es OBLIGATORIO para instalaciones en el tope o cerca del tope', 'error');
document.getElementById('towerHeight').focus();
document.getElementById('towerHeight').scrollIntoView({ behavior: 'smooth', block: 'center' });
return false;
}
if (!document.getElementById('tallestPoint').value) {
showNotification('⚠️ Tallest Point es OBLIGATORIO para instalaciones en el tope o cerca del tope', 'error');
document.getElementById('tallestPoint').focus();
document.getElementById('tallestPoint').scrollIntoView({ behavior: 'smooth', block: 'center' });
return false;
}
}

return true;

case 2:
if (reportData.appurtenances.length === 0) {
showNotification('Por favor agregue al menos un equipo', 'error');
return false;
}
return true;

case 3:
let totalPhotos = 0;
Object.values(reportData.photos).forEach(photoArray => {
if (Array.isArray(photoArray)) {
totalPhotos += photoArray.length;
}
});

if (totalPhotos < 5) {
showNotification('Por favor tome al menos 5 fotos para continuar', 'error');
return false;
}
return true;

default:
return true;
}
}

function saveCurrentStep() {
try {
switch(currentStep) {
case 1:
const timestamp = Date.now();
const randomNum = Math.floor(Math.random() * 1000);
const autoSiteId = document.getElementById('siteId').value || `AUTO-${timestamp}-${randomNum}`;

reportData.basic = {
siteId: autoSiteId,
siteName: document.getElementById('siteName').value,
customerSiteId: document.getElementById('customerSiteId').value,
customerSiteName: document.getElementById('customerSiteName').value,
radiosInstalled: document.getElementById('radiosInstalled').value,
antennasInstalled: document.getElementById('antennasInstalled').value,
teamLeader: document.getElementById('teamLeader').value,
towerTop: document.getElementById('towerTop').value,
completionDate: document.getElementById('completionDate').value,
tpTenant: document.getElementById('tpTenant').value,
submittedBy: reportData.metadata.submittedBy || 'Unknown User',
submittedByEmail: reportData.metadata.submittedByEmail || 'unknown@email.com',
submissionTimestamp: new Date().toISOString(),
uniqueReportId: `RPT-${timestamp}-${randomNum}`
};

// Guardar mediciones (ahora algunas son obligatorias)
reportData.measurements = {
towerHeight: document.getElementById('towerHeight').value || '',
sector1TapeDrop: document.getElementById('sector1TapeDrop').value || '',
sector2TapeDrop: document.getElementById('sector2TapeDrop').value || '',
sector3TapeDrop: document.getElementById('sector3TapeDrop').value || '',
tallestPoint: document.getElementById('tallestPoint').value || ''
};
break;
}

try {
localStorage.setItem('towerReport', JSON.stringify(reportData));
} catch (e) {
if (e.name === 'QuotaExceededError') {
clearOldReports();
try {
localStorage.setItem('towerReport', JSON.stringify(reportData));
} catch (e2) {
showNotification('Almacenamiento lleno. Algunas fotos no se guardaron.', 'error');
const minimalData = {
basic: reportData.basic,
gps: reportData.gps,
appurtenances: reportData.appurtenances,
photos: {}
};
localStorage.setItem('towerReport', JSON.stringify(minimalData));
}
}
}
} catch (error) {
console.error('Error saving data:', error);
showNotification('Error al guardar. Continuando sin guardar.', 'error');
}
}

function loadSavedData() {
const saved = localStorage.getItem('towerReport');
if (saved) {
reportData = JSON.parse(saved);
if (reportData.basic) {
Object.keys(reportData.basic).forEach(key => {
const element = document.getElementById(key);
if (element && key !== 'submittedBy' && key !== 'submittedByEmail') {
element.value = reportData.basic[key];
}
});
// Actualizar requisitos de medición si hay un valor de towerTop guardado
if (reportData.basic.towerTop) {
updateMeasurementRequirements();
}
}
if (reportData.measurements) {
Object.keys(reportData.measurements).forEach(key => {
const element = document.getElementById(key);
if (element) {
element.value = reportData.measurements[key];
}
});
}
if (reportData.gps.latitude) {
showGPSStatus(true);
}
updateAppurtenanceList();
updatePhotoCounts();
}
}

// Storage management functions
function checkStorageSpace() {
try {
let totalSize = 0;
for (let key in localStorage) {
if (localStorage.hasOwnProperty(key)) {
totalSize += localStorage[key].length;
}
}
return (totalSize / 1024 / 1024).toFixed(2);
} catch (e) {
return 'Unknown';
}
}

function updateStorageIndicator() {
const indicator = document.getElementById('storageIndicator');
if (indicator) {
const usedMB = checkStorageSpace();
const usedNum = parseFloat(usedMB);

indicator.textContent = `${usedMB} MB`;

if (usedNum > 4.5) {
indicator.style.color = 'red';
indicator.textContent += ' (CRÍTICO)';
} else if (usedNum > 3) {
indicator.style.color = 'orange';
indicator.textContent += ' (alto)';
} else {
indicator.style.color = 'green';
}
}
}

function optimizeStorage() {
const currentSize = parseFloat(checkStorageSpace());

if (currentSize > 4) {
showNotification('Optimizando almacenamiento...', 'info');
clearOldReports();

if (parseFloat(checkStorageSpace()) > 3) {
Object.keys(reportData.photos).forEach(photoType => {
const photos = reportData.photos[photoType];
if (photos && photos.length > 2) {
reportData.photos[photoType] = photos.slice(-2);
}
});
updatePhotoCounts();
}

updateStorageIndicator();
showNotification('Almacenamiento optimizado', 'success');
}
}

function clearOldReports() {
const keysToRemove = [];
for (let i = 0; i < localStorage.length; i++) {
const key = localStorage.key(i);
if (key && key.startsWith('RPT-') && key !== 'towerReportSession') {
keysToRemove.push(key);
}
}
keysToRemove.forEach(key => localStorage.removeItem(key));
}

function clearAllData() {
if (confirm('¿Eliminar todos los datos guardados? Esto borrará reportes anteriores pero mantendrá su sesión activa.')) {
const keysToRemove = [];
for (let i = 0; i < localStorage.length; i++) {
const key = localStorage.key(i);
if (key && key !== 'towerReportSession') {
keysToRemove.push(key);
}
}
keysToRemove.forEach(key => localStorage.removeItem(key));

reportData = {
basic: {},
gps: {},
appurtenances: [],
photos: {},
metadata: {
submittedBy: reportData.metadata.submittedBy,
submittedByEmail: reportData.metadata.submittedByEmail
}
};
showNotification('Datos eliminados correctamente', 'success');
updateStorageIndicator();
location.reload();
}
}

// Generate Google Maps URLs
function generateGoogleMapsUrl(lat, lng) {
// URL para ver en Google Maps
const viewUrl = `https://www.google.com/maps?q=${lat},${lng}&z=18&t=k`;

// URL para Google Static Maps API (requiere API key)
// const staticUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=18&size=600x400&maptype=satellite&markers=color:red%7C${lat},${lng}&key=YOUR_API_KEY`;

return {
view: viewUrl,
// static: staticUrl // Descomentar cuando tengas API key
};
}

// GPS Functions - ACTUALIZADO PARA SER OBLIGATORIO
function getGPSLocation() {
const statusDiv = document.getElementById('gpsStatus');
statusDiv.innerHTML = '<div class="spinner"></div><p>Obteniendo ubicación GPS...</p>';

if (!navigator.geolocation) {
showGPSStatus(false, 'Geolocalización no soportada. Use la opción manual.');
showManualGPS();
return;
}

const options = {
enableHighAccuracy: true, // Cambiado a true para mayor precisión
timeout: 15000, // Aumentado a 15 segundos
maximumAge: 0 // Sin caché para obtener ubicación actual
};

navigator.geolocation.getCurrentPosition(
(position) => {
reportData.gps = {
latitude: position.coords.latitude,
longitude: position.coords.longitude,
altitude: position.coords.altitude || 0,
accuracy: position.coords.accuracy
};
showGPSStatus(true);
saveCurrentStep();
showNotification('✓ GPS capturado exitosamente', 'success');
},
(error) => {
console.error('GPS Error:', error);
let errorMessage = 'Error desconocido';

switch(error.code) {
case 1:
errorMessage = 'Permisos de ubicación denegados. Active la ubicación en su dispositivo o use la opción manual.';
break;
case 2:
errorMessage = 'Ubicación no disponible. Intente en un área con mejor señal o use la opción manual.';
break;
case 3:
errorMessage = 'Tiempo agotado obteniendo ubicación. Use la opción manual para continuar.';
break;
default:
errorMessage = `Error de ubicación: ${error.message || 'Desconocido'}. Use la opción manual.`;
}

showGPSStatus(false, errorMessage);
// Mostrar automáticamente la opción manual cuando falla
showManualGPS();
},
options
);
}

function showManualGPS() {
const statusDiv = document.getElementById('gpsStatus');
statusDiv.innerHTML = `
<div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 10px;">
<h4 style="color: #856404;">📍 Ingreso Manual de Coordenadas (OBLIGATORIO)</h4>
<p style="font-size: 12px; color: #666; margin-bottom: 10px;">
Ingrese las coordenadas del sitio. Puede obtenerlas de Google Maps manteniendo presionado un punto en el mapa.
</p>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
<div>
<label style="font-size: 12px; color: #856404;">Latitud <span class="required">*</span></label>
<input type="number" id="manualLat" placeholder="ej: 18.4671" step="any" style="padding: 8px; width: 100%;" required>
</div>
<div>
<label style="font-size: 12px; color: #856404;">Longitud <span class="required">*</span></label>
<input type="number" id="manualLng" placeholder="ej: -66.1185" step="any" style="padding: 8px; width: 100%;" required>
</div>
</div>
<div style="display: flex; gap: 10px;">
<button class="btn btn-success" onclick="saveManualGPS()" style="font-size: 14px;">
✓ Guardar Coordenadas
</button>
<button class="btn btn-primary" onclick="getGPSLocation()" style="font-size: 14px;">
📍 Reintentar GPS Auto
</button>
</div>
<div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px;">
<p style="font-size: 11px; color: #1565c0; margin: 0;">
<strong>Consejo:</strong> En Google Maps (móvil), mantenga presionado el sitio de la torre,
luego toque las coordenadas que aparecen arriba para copiarlas.
</p>
</div>
</div>
`;

// Focus en el primer campo
setTimeout(() => {
const latInput = document.getElementById('manualLat');
if (latInput) latInput.focus();
}, 100);
}

function saveManualGPS() {
const lat = document.getElementById('manualLat').value;
const lng = document.getElementById('manualLng').value;

if (!lat || !lng) {
showNotification('⚠️ Debe ingresar tanto latitud como longitud', 'error');
return;
}

const latNum = parseFloat(lat);
const lngNum = parseFloat(lng);

// Validación de rangos
if (Math.abs(latNum) > 90) {
showNotification('Latitud inválida. Debe estar entre -90 y 90', 'error');
document.getElementById('manualLat').focus();
return;
}

if (Math.abs(lngNum) > 180) {
showNotification('Longitud inválida. Debe estar entre -180 y 180', 'error');
document.getElementById('manualLng').focus();
return;
}

// Validación específica para Puerto Rico (aproximada)
if (latNum < 17.5 || latNum > 19 || lngNum < -68 || lngNum > -65) {
const confirmOutside = confirm('Las coordenadas parecen estar fuera de Puerto Rico. ¿Desea continuar?');
if (!confirmOutside) {
return;
}
}

reportData.gps = {
latitude: latNum,
longitude: lngNum,
altitude: 0,
accuracy: 0,
manual: true,
mapUrl: generateGoogleMapsUrl(latNum, lngNum)
};

showGPSStatus(true);
saveCurrentStep();
showNotification('✓ Coordenadas GPS guardadas correctamente', 'success');
}

function showGPSStatus(success, message = '') {
const statusDiv = document.getElementById('gpsStatus');
if (success) {
const isManual = reportData.gps.manual ? ' (Manual)' : '';
statusDiv.innerHTML = `
<div class="gps-status success">
✓ GPS Capturado${isManual}: ${reportData.gps.latitude.toFixed(7)}, ${reportData.gps.longitude.toFixed(7)}
${!reportData.gps.manual ? `<br>Precisión: ±${reportData.gps.accuracy.toFixed(1)}m` : ''}
<br>
<button class="btn btn-secondary" onclick="showManualGPS()" style="margin-top: 10px; font-size: 12px;">
✏️ Editar Coordenadas
</button>
</div>
`;
} else {
statusDiv.innerHTML = `
<div class="gps-status error">
✗ ${message}
</div>
`;
}
}

// Appurtenance Functions
function showAppurtenanceForm() {
document.getElementById('appurtenanceForm').style.display = 'block';
}

function cancelAppurtenance() {
document.getElementById('appurtenanceForm').style.display = 'none';
['appType', 'appRadCenter', 'appManufacturer', 'appModel', 'appQuantity', 'appCoaxSize'].forEach(id => {
document.getElementById(id).value = id === 'appQuantity' ? '1' : '';
});
}

function addAppurtenance() {
const appurtenance = {
type: document.getElementById('appType').value,
radCenter: document.getElementById('appRadCenter').value,
manufacturer: document.getElementById('appManufacturer').value,
model: document.getElementById('appModel').value,
quantity: document.getElementById('appQuantity').value,
coaxSize: document.getElementById('appCoaxSize').value
};

reportData.appurtenances.push(appurtenance);
updateAppurtenanceList();
cancelAppurtenance();
saveCurrentStep();
}

function updateAppurtenanceList() {
const listDiv = document.getElementById('appurtenanceList');
listDiv.innerHTML = '';

reportData.appurtenances.forEach((app, index) => {
const item = document.createElement('div');
item.className = 'appurtenance-item';
item.innerHTML = `
<div class="appurtenance-info">
<h4>${app.type} - ${app.manufacturer}</h4>
<p>Model: ${app.model} | Qty: ${app.quantity} | Rad: ${app.radCenter}</p>
</div>
<button class="btn btn-danger" onclick="removeAppurtenance(${index})">×</button>
`;
listDiv.appendChild(item);
});
}

function removeAppurtenance(index) {
reportData.appurtenances.splice(index, 1);
updateAppurtenanceList();
saveCurrentStep();
}

// Photo Functions
function generatePhotoGrid() {
const grid = document.getElementById('photoGrid');
grid.innerHTML = '';

photoTypes.forEach(type => {
const photoItem = document.createElement('div');
photoItem.className = 'photo-item';
photoItem.innerHTML = `
<h4>${type.name}</h4>
<div class="photo-capture">
<input type="file"
accept="image/*"
capture="environment"
multiple
class="camera-input"
id="photo_${type.id}"
onchange="handlePhotoCapture('${type.id}', this)">
<label for="photo_${type.id}" class="camera-btn">
📷 Tomar Foto (${type.required} requeridas)
</label>
</div>
<div id="preview_${type.id}"></div>
<div class="photo-count">
<span id="count_${type.id}">0</span> de ${type.required} fotos
</div>
<div class="photo-status ${(reportData.photos[type.id] || []).length >= type.required ? 'complete' : 'pending'}"
id="status_${type.id}">
${(reportData.photos[type.id] || []).length >= type.required ? '✓ Completo' : '⏱ Pendiente'}
</div>
`;
grid.appendChild(photoItem);
});

updatePhotoCounts();
}

function handlePhotoCapture(typeId, input) {
const files = Array.from(input.files);
if (!reportData.photos[typeId]) {
reportData.photos[typeId] = [];
}

files.forEach(file => {
const currentSize = checkStorageSpace();
if (parseFloat(currentSize) > 4.5) {
showNotification('Almacenamiento casi lleno. Limpiando fotos antiguas...', 'info');
clearOldReports();
}

compressImage(file, 400, 0.5, (compressedDataUrl) => {
try {
reportData.photos[typeId].push({
data: compressedDataUrl,
timestamp: new Date().toISOString(),
name: file.name
});
updatePhotoPreview(typeId);
updatePhotoCounts();
saveCurrentStep();
} catch (error) {
if (error.name === 'QuotaExceededError') {
showNotification('Almacenamiento lleno. Use "Limpiar datos" primero.', 'error');
}
}
});
});
}

function compressImage(file, maxWidth, quality, callback) {
const reader = new FileReader();
reader.onload = function(e) {
const img = new Image();
img.onload = function() {
const canvas = document.createElement('canvas');
let width = img.width;
let height = img.height;

const maxSize = 400;
if (width > height) {
if (width > maxSize) {
height = (maxSize / width) * height;
width = maxSize;
}
} else {
if (height > maxSize) {
width = (maxSize / height) * width;
height = maxSize;
}
}

canvas.width = width;
canvas.height = height;

const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0, width, height);

const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5);
callback(compressedDataUrl);
};
img.src = e.target.result;
};
reader.readAsDataURL(file);
}

function updatePhotoPreview(typeId) {
const previewDiv = document.getElementById(`preview_${typeId}`);
const photos = reportData.photos[typeId] || [];

previewDiv.innerHTML = photos.map((photo, index) => `
<img src="${photo.data}" class="photo-preview" alt="Photo ${index + 1}" style="width: 100px; height: 100px; object-fit: cover; margin: 5px;">
`).join('');
}

function updatePhotoCounts() {
photoTypes.forEach(type => {
const photos = reportData.photos[type.id] || [];
const countSpan = document.getElementById(`count_${type.id}`);
const statusDiv = document.getElementById(`status_${type.id}`);

if (countSpan) {
countSpan.textContent = photos.length;
}

if (statusDiv) {
if (photos.length >= type.required) {
statusDiv.className = 'photo-status complete';
statusDiv.textContent = '✓ Completo';
} else {
statusDiv.className = 'photo-status pending';
statusDiv.textContent = '⏱ Pendiente';
}
}
});
}

function skipPhotoValidation() {
photoTypes.forEach(type => {
if (!reportData.photos[type.id]) {
reportData.photos[type.id] = [];
}
reportData.photos[type.id].push({
data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
timestamp: new Date().toISOString(),
name: 'demo_photo.png'
});
});

updatePhotoCounts();
saveCurrentStep();
showNotification('Fotos de demostración agregadas. Ahora puede continuar.', 'success');
}

// Review Functions
function updateReview() {
const siteReview = document.getElementById('siteReview');
siteReview.innerHTML = `
<div class="review-item">
<span class="review-label">Site ID:</span>
<span class="review-value">${reportData.basic.siteId || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">Site Name:</span>
<span class="review-value">${reportData.basic.siteName || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">Team Leader:</span>
<span class="review-value">${reportData.basic.teamLeader || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">Tower Top Installation:</span>
<span class="review-value">${reportData.basic.towerTop === 'yes' ? 'Yes - At Tower Top' : 
reportData.basic.towerTop === 'near-top' ? 'Near Top (Within 10\' of top)' : 
'No - Below 10\' from top'}</span>
</div>
<div class="review-item">
<span class="review-label">Submitted By:</span>
<span class="review-value">${reportData.basic.submittedBy || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">GPS Location:</span>
<span class="review-value">${reportData.gps.latitude ? `${reportData.gps.latitude.toFixed(6)}, ${reportData.gps.longitude.toFixed(6)}` : 'N/A'}</span>
</div>
`;

const equipmentReview = document.getElementById('equipmentReview');
equipmentReview.innerHTML = `
<div class="review-item">
<span class="review-label">Radios:</span>
<span class="review-value">${reportData.basic.radiosInstalled || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">Antennas:</span>
<span class="review-value">${reportData.basic.antennasInstalled || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">Equipment Items:</span>
<span class="review-value">${reportData.appurtenances.length} tipos</span>
</div>
<div class="review-item">
<span class="review-label">Tape Drop Measurements:</span>
<span class="review-value">S1: ${reportData.measurements.sector1TapeDrop || 'N/A'}, S2: ${reportData.measurements.sector2TapeDrop || 'N/A'}, S3: ${reportData.measurements.sector3TapeDrop || 'N/A'}</span>
</div>
${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? `
<div class="review-item">
<span class="review-label">Tower Height:</span>
<span class="review-value">${reportData.measurements.towerHeight || 'N/A'}</span>
</div>
<div class="review-item">
<span class="review-label">Tallest Point:</span>
<span class="review-value">${reportData.measurements.tallestPoint || 'N/A'}</span>
</div>
` : ''}
`;

const photoReview = document.getElementById('photoReview');
let totalPhotos = 0;
let completedTypes = 0;

photoTypes.forEach(type => {
const photos = reportData.photos[type.id] || [];
totalPhotos += photos.length;
if (photos.length >= type.required) {
completedTypes++;
}
});

photoReview.innerHTML = `
<div class="review-item">
<span class="review-label">Total de fotos:</span>
<span class="review-value">${totalPhotos}</span>
</div>
<div class="review-item">
<span class="review-label">Categorías completas:</span>
<span class="review-value">${completedTypes} de ${photoTypes.length}</span>
</div>
`;
}

// Submit and SharePoint Functions
async function sendToSharePoint(reportData) {
const POWER_AUTOMATE_URL = 'https://prod-19.westus.logic.azure.com:443/workflows/1170c524ac7e4e9c98e817550c91f1d0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JdS7ZO75Zm5eCaImMEoyGfDp3qzLUlNYLlo1J_dHGjE';

const timestamp = Date.now();
const randomNum = Math.floor(Math.random() * 100000);
const uniqueReportID = `RPT-${timestamp}-${randomNum}`;

const appurtenanceDataJSON = {
appurtenances: reportData.appurtenances || [],
measurements: reportData.measurements || {},
gpsDetails: {
latitude: reportData.gps.latitude || 0,
longitude: reportData.gps.longitude || 0,
altitude: reportData.gps.altitude || 0,
accuracy: reportData.gps.accuracy || 0,
method: reportData.gps.manual ? 'manual' : 'auto',
mapUrl: reportData.gps.mapUrl || null
},
metadata: reportData.metadata || {}
};

const photoLinksJSON = {
totalPhotos: 0,
categories: {},
photoMetadata: {}
};

Object.keys(reportData.photos).forEach(category => {
const photos = reportData.photos[category] || [];
photoLinksJSON.totalPhotos += photos.length;
photoLinksJSON.categories[category] = photos.length;

photos.forEach((photo, index) => {
const photoKey = `${category}_${index + 1}`;
photoLinksJSON.photoMetadata[photoKey] = {
timestamp: photo.timestamp,
name: photo.name || photoKey,
category: photoTypes.find(t => t.id === category)?.name || category
};
});
});

// Interpretar el valor de towerTop para SharePoint
let towerTopBoolean = false;
if (reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') {
towerTopBoolean = true;
}

const dataToSend = {
Title: reportData.basic.teamLeader || 'Field Technician',
SubmittedBy: reportData.basic.submittedBy || 'Field Technician',
SubmittedByEmail: reportData.basic.submittedByEmail || 'unknown@email.com',
SubmissionTimestamp: new Date().toISOString(),
ReportID: uniqueReportID,
TowerProviderSiteID: reportData.basic.siteId || '',
TowerProviderSiteName: reportData.basic.siteName || '',
CustomerSiteID: reportData.basic.customerSiteId || '',
CustomerSiteName: reportData.basic.customerSiteName || '',
RadiosInstalled: parseInt(reportData.basic.radiosInstalled) || 0,
AntennasInstalled: parseInt(reportData.basic.antennasInstalled) || 0,
TeamLeader: reportData.basic.teamLeader || '',
TowerTopInstallation: towerTopBoolean,
TowerTopInstallationDetails: reportData.basic.towerTop || 'no',
CompletionDate: reportData.basic.completionDate || new Date().toISOString().split('T')[0],
TPTenant: reportData.basic.tpTenant || '',
Latitude: reportData.gps.latitude || 0,
Longitude: reportData.gps.longitude || 0,
AppurtenanceData: JSON.stringify(appurtenanceDataJSON),
PhotoLinks: JSON.stringify(photoLinksJSON),
ReportStatus: 'DraftSubmittedPDF'
};

try {
const response = await fetch(POWER_AUTOMATE_URL, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Accept': 'application/json'
},
body: JSON.stringify(dataToSend)
});

if (response.ok) {
return true;
} else {
console.error('Error response:', response.status, response.statusText);
return false;
}
} catch (error) {
console.error('Network/Connection error:', error);
return false;
}
}

async function submitReport() {
const submitBtn = event.target;
const statusDiv = document.getElementById('submitStatus');

// Update submittedBy with current authenticated user
reportData.basic.submittedBy = reportData.metadata.submittedBy || 'Unknown User';
reportData.basic.submittedByEmail = reportData.metadata.submittedByEmail || 'unknown@email.com';

submitBtn.disabled = true;
statusDiv.innerHTML = '<div class="spinner"></div><p>Enviando reporte a SharePoint...</p>';

try {
const reportId = `RPT-${Date.now()}-${Math.floor(Math.random() * 100000)}`;
localStorage.setItem(reportId, JSON.stringify(reportData));

const sentToSharePoint = await sendToSharePoint(reportData);

if (sentToSharePoint) {
statusDiv.innerHTML = `
<div style="background: #e8f5e9; padding: 20px; border-radius: 6px; text-align: left;">
<h3 style="color: #2e7d32;">✓ Reporte Enviado a SharePoint</h3>
<p>ID: ${reportId}</p>
<p>Enviado por: <strong>${reportData.basic.submittedBy}</strong></p>
<p style="margin-top: 15px;">
<strong>✓ Guardado localmente</strong><br>
<strong>✓ Enviado a SharePoint</strong>
</p>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
➕ Crear Nuevo Reporte
</button>
<button class="btn btn-primary" onclick="sendDetailedEmail('${reportId}')" style="flex: 1;">
📧 Enviar Email Detallado
</button>
</div>
</div>
`;
} else {
statusDiv.innerHTML = `
<div style="background: #fff3cd; padding: 20px; border-radius: 6px; text-align: left;">
<h3 style="color: #856404;">⚠️ Guardado Solo Localmente</h3>
<p>ID: ${reportId}</p>
<p style="margin-top: 15px;">
El reporte se guardó en el dispositivo pero no se pudo enviar a SharePoint.
</p>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn btn-primary" onclick="retrySharePoint('${reportId}')" style="flex: 1;">
🔄 Reintentar Envío
</button>
<button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
➕ Nuevo Reporte
</button>
</div>
</div>
`;
}

submitBtn.disabled = false;

} catch (error) {
statusDiv.innerHTML = `
<div style="background: #ffebee; padding: 20px; border-radius: 6px;">
<h3 style="color: #c62828;">Error al guardar</h3>
<p>${error.message}</p>
<button class="btn btn-primary" onclick="location.reload()">
Recargar Página
</button>
</div>
`;
submitBtn.disabled = false;
}
}

async function retrySharePoint(reportId) {
const savedData = localStorage.getItem(reportId);
if (savedData) {
const data = JSON.parse(savedData);
const statusDiv = document.getElementById('submitStatus');

statusDiv.innerHTML = '<div class="spinner"></div><p>Reintentando envío...</p>';

const sent = await sendToSharePoint(data);

if (sent) {
statusDiv.innerHTML = `
<div style="background: #e8f5e9; padding: 20px; border-radius: 6px;">
<h3 style="color: #2e7d32;">✓ Enviado Exitosamente</h3>
<p>El reporte se envió a SharePoint.</p>
<div style="display: flex; gap: 10px; margin-top: 15px;">
<button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
➕ Crear Nuevo Reporte
</button>
<button class="btn btn-primary" onclick="location.href='mailto:accounting@newcomm2000.com?subject=Tower Report ${reportId}'" style="flex: 1;">
📧 Enviar por Email
</button>
</div>
</div>
`;
} else {
statusDiv.innerHTML = `
<div style="background: #ffebee; padding: 20px; border-radius: 6px;">
<h3 style="color: #c62828;">Error al enviar</h3>
<p>No se pudo conectar con SharePoint. Verifique su conexión.</p>
<div style="display: flex; gap: 10px; margin-top: 15px;">
<button class="btn btn-primary" onclick="retrySharePoint('${reportId}')" style="flex: 1;">
🔄 Reintentar
</button>
<button class="btn btn-success" onclick="startNewReport()" style="flex: 1;">
➕ Nuevo Reporte
</button>
</div>
</div>
`;
}
}
}

function startNewReport() {
// Mantener la información del usuario
const userInfo = {
submittedBy: reportData.metadata.submittedBy,
submittedByEmail: reportData.metadata.submittedByEmail
};

reportData = {
basic: {},
gps: {},
appurtenances: [],
photos: {},
metadata: {
...userInfo,
appVersion: '6.0',
deviceInfo: navigator.userAgent,
createdAt: new Date().toISOString()
}
};

document.querySelectorAll('input, select, textarea').forEach(field => {
if (field.type === 'date') {
field.value = new Date().toISOString().split('T')[0];
} else if (field.id === 'appQuantity') {
field.value = '1';
} else {
field.value = '';
}
});

currentStep = 1;
showStep(1);

document.getElementById('gpsStatus').innerHTML = '';
document.getElementById('appurtenanceList').innerHTML = '';

generatePhotoGrid();
updateMeasurementRequirements();

showNotification('Nuevo reporte iniciado', 'success');
}

function showReportSummary() {
let totalPhotos = 0;
Object.values(reportData.photos).forEach(photoArray => {
if (Array.isArray(photoArray)) {
totalPhotos += photoArray.length;
}
});

const summaryHTML = `
<div style="background: #f5f5f5; padding: 20px; border-radius: 6px; margin: 20px 0;">
<h3 style="color: #0066cc; margin-bottom: 15px;">Resumen del Reporte</h3>

<div style="margin-bottom: 15px;">
<h4 style="color: #333;">Información del Sitio</h4>
<p><strong>Site ID:</strong> ${reportData.basic.siteId || 'N/A'}</p>
<p><strong>Site Name:</strong> ${reportData.basic.siteName || 'N/A'}</p>
<p><strong>Team Leader:</strong> ${reportData.basic.teamLeader || 'N/A'}</p>
<p><strong>Enviado por:</strong> ${reportData.metadata.submittedBy || 'N/A'}</p>
<p><strong>Fecha:</strong> ${reportData.basic.completionDate || 'N/A'}</p>
<p><strong>Tower Top Installation:</strong> ${reportData.basic.towerTop === 'yes' ? 'Yes - At Tower Top' : 
reportData.basic.towerTop === 'near-top' ? 'Near Top (Within 10\' of top)' : 
'No - Below 10\' from top'}</p>
</div>

<div style="margin-bottom: 15px;">
<h4 style="color: #333;">Equipos Instalados</h4>
<p><strong>Radios:</strong> ${reportData.basic.radiosInstalled || 0}</p>
<p><strong>Antenas:</strong> ${reportData.basic.antennasInstalled || 0}</p>
<p><strong>Equipos registrados:</strong> ${reportData.appurtenances.length}</p>
</div>

<div style="margin-bottom: 15px;">
<h4 style="color: #333;">Mediciones (OBLIGATORIAS)</h4>
<p><strong>Sector 1 Tape Drop:</strong> ${reportData.measurements.sector1TapeDrop || 'N/A'}</p>
<p><strong>Sector 2 Tape Drop:</strong> ${reportData.measurements.sector2TapeDrop || 'N/A'}</p>
<p><strong>Sector 3 Tape Drop:</strong> ${reportData.measurements.sector3TapeDrop || 'N/A'}</p>
${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? `
<p><strong>Tower Height:</strong> ${reportData.measurements.towerHeight || 'N/A'} (OBLIGATORIO)</p>
<p><strong>Tallest Point:</strong> ${reportData.measurements.tallestPoint || 'N/A'} (OBLIGATORIO)</p>
` : `
<p><strong>Tower Height:</strong> ${reportData.measurements.towerHeight || 'No aplicable'}</p>
<p><strong>Tallest Point:</strong> ${reportData.measurements.tallestPoint || 'No aplicable'}</p>
`}
</div>

<div style="margin-bottom: 15px;">
<h4 style="color: #333;">Ubicación GPS</h4>
<p><strong>Latitud:</strong> ${reportData.gps.latitude ? reportData.gps.latitude.toFixed(7) : 'N/A'}</p>
<p><strong>Longitud:</strong> ${reportData.gps.longitude ? reportData.gps.longitude.toFixed(7) : 'N/A'}</p>
<p><strong>Método:</strong> ${reportData.gps.manual ? 'Manual' : 'Automático'}</p>
${!reportData.gps.manual && reportData.gps.accuracy ? `<p><strong>Precisión:</strong> ±${reportData.gps.accuracy.toFixed(1)}m</p>` : ''}
</div>

<div>
<h4 style="color: #333;">Documentación</h4>
<p><strong>Total de fotos:</strong> ${totalPhotos}</p>
<p><strong>Versión del reporte:</strong> 6.0</p>
</div>

<button class="btn btn-secondary" onclick="closeReportSummary()" style="margin-top: 15px;">
Cerrar Resumen
</button>
</div>
`;

const statusDiv = document.getElementById('submitStatus');
statusDiv.innerHTML = summaryHTML;
showNotification('Resumen del reporte mostrado', 'info');
}

function closeReportSummary() {
document.getElementById('submitStatus').innerHTML = '';
}

function sendDetailedEmail(reportId) {
const emailSubject = `Tower Provider Report - ${reportData.basic.siteName || reportId}`;

const emailBody = `
TOWER PROVIDER REPORT v6.0
==========================

SITE INFORMATION:
- Site ID: ${reportData.basic.siteId || 'N/A'}
- Site Name: ${reportData.basic.siteName || 'N/A'}
- Customer Site ID: ${reportData.basic.customerSiteId || 'N/A'}
- Customer Site Name: ${reportData.basic.customerSiteName || 'N/A'}

INSTALLATION DETAILS:
- Radios Installed: ${reportData.basic.radiosInstalled || '0'}
- Antennas Installed: ${reportData.basic.antennasInstalled || '0'}
- Team Leader: ${reportData.basic.teamLeader || 'N/A'}
- Tower Top Installation: ${reportData.basic.towerTop === 'yes' ? 'Yes - At Tower Top' : 
reportData.basic.towerTop === 'near-top' ? 'Near Top (Within 10\' of top)' : 
'No - Below 10\' from top'}
- Completion Date: ${reportData.basic.completionDate || 'N/A'}
- TP Tenant: ${reportData.basic.tpTenant || 'N/A'}

GPS LOCATION (REQUIRED):
- Latitude: ${reportData.gps.latitude || 'N/A'}
- Longitude: ${reportData.gps.longitude || 'N/A'}
- Method: ${reportData.gps.manual ? 'Manual Entry' : 'Automatic GPS'}
- Accuracy: ${reportData.gps.accuracy ? `±${reportData.gps.accuracy.toFixed(1)}m` : 'N/A'}

MEASUREMENTS (REQUIRED):
- Sector 1 Tape Drop: ${reportData.measurements.sector1TapeDrop || 'N/A'} (REQUIRED)
- Sector 2 Tape Drop: ${reportData.measurements.sector2TapeDrop || 'N/A'} (REQUIRED)
- Sector 3 Tape Drop: ${reportData.measurements.sector3TapeDrop || 'N/A'} (REQUIRED)
- Tower Height: ${reportData.measurements.towerHeight || 'N/A'} ${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? '(REQUIRED)' : '(Optional)'}
- Tallest Point: ${reportData.measurements.tallestPoint || 'N/A'} ${(reportData.basic.towerTop === 'yes' || reportData.basic.towerTop === 'near-top') ? '(REQUIRED)' : '(Optional)'}

EQUIPMENT INSTALLED (${reportData.appurtenances.length} items):
${reportData.appurtenances.map((app, i) =>
`${i + 1}. ${app.type} - ${app.manufacturer} ${app.model} (Qty: ${app.quantity})`
).join('\n')}

PHOTO DOCUMENTATION:
- Total Photos: ${Object.values(reportData.photos).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0)}
${Object.entries(reportData.photos).map(([category, photos]) => {
const catName = photoTypes.find(t => t.id === category)?.name || category;
return `- ${catName}: ${photos ? photos.length : 0} photos`;
}).join('\n')}

REPORT DETAILS:
- Report ID: ${reportId}
- Submitted by: ${reportData.basic.submittedBy || 'Field Technician'}
- Email: ${reportData.basic.submittedByEmail || 'N/A'}
- Submission Time: ${new Date().toLocaleString()}
- Report Version: 6.0

---
This report has been submitted to SharePoint.
GPS coordinates were ${reportData.gps.manual ? 'manually entered' : 'automatically captured'}.
All required measurements have been completed.

Newcomm Management Services Corp.
PO Box 4116, Vega Baja PR 00694
Phone: 787-718-2600
`.trim();

const encodedBody = encodeURIComponent(emailBody);

const mailtoLink = `mailto:accounting@newcomm2000.com?subject=${encodeURIComponent(emailSubject)}&body=${encodedBody}`;

if (mailtoLink.length > 2000) {
const shortBody = `
Tower Provider Report v6.0 - ${reportData.basic.siteName || 'N/A'}
Site ID: ${reportData.basic.siteId || 'N/A'}
Report ID: ${reportId}
GPS: ${reportData.gps.latitude || 'N/A'}, ${reportData.gps.longitude || 'N/A'}
Tower Top: ${reportData.basic.towerTop === 'yes' ? 'Yes' : reportData.basic.towerTop === 'near-top' ? 'Near Top' : 'No'}
Submitted by: ${reportData.basic.submittedBy || 'Field Technician'}

Please check SharePoint for the complete report with all details and photos.

Date: ${new Date().toLocaleString()}
`.trim();

window.location.href = `mailto:accounting@newcomm2000.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(shortBody)}`;
showNotification('Email abierto con resumen corto (límite de caracteres)', 'info');
} else {
window.location.href = mailtoLink;
showNotification('Email abierto con todos los detalles', 'success');
}
}

// Notification function
function showNotification(message, type = 'info') {
const existing = document.querySelector('.notification');
if (existing) {
existing.remove();
}

const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;
document.body.appendChild(notification);

setTimeout(() => {
notification.remove();
}, 3000);
}

// Initialize on page load - Mejorado para móviles
window.addEventListener('load', async () => {
console.log('Page loaded, initializing MSAL...');

// Verificar si ya estábamos en la app principal
const appState = sessionStorage.getItem('appState');
if (appState === 'mainApp') {
// Intentar restaurar la sesión
const savedAccount = localStorage.getItem('userAccount');
if (savedAccount) {
try {
currentAccount = JSON.parse(savedAccount);
await getUserDetails();
showMainApp();
return;
} catch (e) {
console.error('Error restoring session:', e);
}
}
}

await initializeMsal();
});

// Manejar eventos de visibilidad de página (importante para móviles)
document.addEventListener('visibilitychange', async () => {
if (!document.hidden && currentAccount) {
// La página volvió a ser visible, verificar token
try {
await msalInstance.acquireTokenSilent({
...loginRequest,
account: currentAccount
});
} catch (error) {
console.log('Token refresh needed');
}
}
});

// Prevenir que la app se cierre accidentalmente
window.addEventListener('beforeunload', (e) => {
if (currentStep > 1 && Object.keys(reportData.basic).length > 0) {
e.preventDefault();
e.returnValue = '¿Estás seguro de que quieres salir? Los datos no guardados se perderán.';
}
});
</script>
</body>
</html>
