<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫squeda de Reportes - Tower Report System</title>
    
    <!-- MSAL.js desde CDN -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #0066cc;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background 0.2s;
        }
        
        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn-back:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-primary {
            background-color: #0066cc;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0052a3;
        }
        
        .container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        .search-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        .btn-search {
            background: #0066cc;
            color: white;
            padding: 12px 24px;
        }
        
        .btn-search:hover {
            background: #0052a3;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background: #dee2e6;
        }
        
        .filter-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        
        .results-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .report-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .report-card.sharepoint {
            border-left: 4px solid #0066cc;
        }
        
        .report-card.sharepoint::before {
            content: 'üåê';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            opacity: 0.5;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .report-id {
            font-size: 18px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .report-status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-complete {
            background: #d4edda;
            color: #155724;
        }
        
        .status-incomplete {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-pending {
            background: #cce5ff;
            color: #004085;
        }
        
        .report-details {
            margin-bottom: 15px;
        }
        
        .report-details p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .report-details strong {
            color: #333;
        }
        
        .report-stats {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stat-item {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-action {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            text-align: center;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .btn-action:hover {
            background: #f8f9fa;
        }
        
        .btn-edit {
            color: #0066cc;
            border-color: #0066cc;
        }
        
        .btn-edit:hover {
            background: #e6f2ff;
        }
        
        .btn-duplicate {
            color: #28a745;
            border-color: #28a745;
        }
        
        .btn-duplicate:hover {
            background: #e6f4ea;
        }
        
        .btn-delete {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn-delete:hover {
            background: #f8d7da;
        }
        
        .btn-view {
            color: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-view:hover {
            background: #e9ecef;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-results h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .report-actions {
                flex-wrap: wrap;
            }
            
            .btn-action {
                min-width: calc(50% - 5px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>B√∫squeda de Reportes</h1>
            <a href="index.html" class="btn btn-back">‚Üê Volver al Men√∫</a>
        </div>
    </div>
    
    <div class="container">
        <div class="search-section">
            <div class="search-header">
                <h2>B√∫squeda de Reportes</h2>
                <button id="searchModeBtn" class="btn btn-primary" onclick="toggleSearchMode()" title="Cambiar origen de b√∫squeda">
                    üíæ Local
                </button>
            </div>
            
            <div class="search-input-group">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="Buscar por Site ID, Site Name, Customer Site, Team Leader o Report ID...">
                <button class="btn btn-search" onclick="searchReports()">üîç Buscar</button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setFilter('all')" data-filter="all">
                    Todos
                </button>
                <button class="filter-btn" onclick="setFilter('complete')" data-filter="complete">
                    Completos
                </button>
                <button class="filter-btn" onclick="setFilter('incomplete')" data-filter="incomplete">
                    Incompletos
                </button>
                <button class="filter-btn" onclick="setFilter('pending')" data-filter="pending">
                    Pendientes SharePoint
                </button>
                <button class="filter-btn" onclick="setFilter('today')" data-filter="today">
                    Hoy
                </button>
                <button class="filter-btn" onclick="setFilter('week')" data-filter="week">
                    Esta Semana
                </button>
            </div>
        </div>
        
        <div class="results-info" id="resultsInfo">
            <span>Mostrando <strong id="resultCount">0</strong> reportes</span>
            <button class="btn btn-search" onclick="exportReports()">üì• Exportar</button>
        </div>
        
        <div id="reportsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando reportes...</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para vista previa -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Vista Previa del Reporte</h2>
                <button class="btn-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="previewContent"></div>
        </div>
    </div>
    
    <script>
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: '928a4b98-5894-4a97-b8b1-d8c489c22216',
                authority: 'https://login.microsoftonline.com/93a307af-2b18-419b-82a4-da0d26ae31d0',
                redirectUri: window.location.origin + window.location.pathname,
                navigateToLoginRequestUrl: false
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: true
            },
            system: {
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) return;
                        console.log(message);
                    },
                    logLevel: msal.LogLevel.Warning
                }
            }
        };

        // Create MSAL instance
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Login request configuration
        const loginRequest = {
            scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All']
        };

        // Global variables
        let currentAccount = null;
        let allReports = [];
        let currentFilter = 'all';
        let searchTerm = '';
        let sharePointReports = [];
        let searchMode = 'local'; // 'local' o 'sharepoint'

        // SharePoint configuration
        const SHAREPOINT_CONFIG = {
            siteUrl: 'nc2k.sharepoint.com',
            listName: 'TowerProviderReports'
        };

        // Initialize MSAL
        async function initializeMsal() {
            try {
                await msalInstance.initialize();
                
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    msalInstance.setActiveAccount(currentAccount);
                    
                    try {
                        await msalInstance.acquireTokenSilent({
                            ...loginRequest,
                            account: currentAccount
                        });
                        console.log('Usuario autenticado:', currentAccount.name);
                        
                        // Verificar si hay un filtro en la URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const filter = urlParams.get('filter');
                        if (filter) {
                            setFilter(filter);
                        } else {
                            loadReports();
                        }
                    } catch (error) {
                        console.log('Token expirado, necesita re-autenticaci√≥n');
                        window.location.href = 'index.html';
                    }
                } else {
                    console.log('No hay usuario autenticado');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error durante inicializaci√≥n MSAL:', error);
            }
        }

        // Toggle search mode
        function toggleSearchMode() {
            searchMode = searchMode === 'local' ? 'sharepoint' : 'local';
            
            const modeButton = document.getElementById('searchModeBtn');
            if (modeButton) {
                modeButton.textContent = searchMode === 'sharepoint' ? 'üåê SharePoint' : 'üíæ Local';
                modeButton.title = searchMode === 'sharepoint' ? 'Buscando en SharePoint' : 'Buscando localmente';
            }
            
            loadReports();
        }

        // Get SharePoint site ID
        async function getSharePointSiteId() {
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ['Sites.Read.All'],
                    account: currentAccount
                });

                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${SHAREPOINT_CONFIG.siteUrl}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${tokenResponse.accessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`Error getting site: ${response.status}`);
                }

                const site = await response.json();
                return site.id;
            } catch (error) {
                console.error('Error getting SharePoint site ID:', error);
                throw error;
            }
        }

        // Search SharePoint reports
        async function searchSharePointReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Buscando en SharePoint...</p></div>';
            
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ['Sites.Read.All', 'Sites.ReadWrite.All'],
                    account: currentAccount
                });

                const siteId = await getSharePointSiteId();

                const listsResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$filter=displayName eq '${SHAREPOINT_CONFIG.listName}'`,
                    {
                        headers: {
                            'Authorization': `Bearer ${tokenResponse.accessToken}`
                        }
                    }
                );

                if (!listsResponse.ok) {
                    throw new Error(`Error getting lists: ${listsResponse.status}`);
                }

                const lists = await listsResponse.json();
                
                if (!lists.value || lists.value.length === 0) {
                    throw new Error('Lista TowerProviderReports no encontrada');
                }

                const listId = lists.value[0].id;

                const itemsResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=999`,
                    {
                        headers: {
                            'Authorization': `Bearer ${tokenResponse.accessToken}`
                        }
                    }
                );

                if (!itemsResponse.ok) {
                    throw new Error(`Error getting items: ${itemsResponse.status}`);
                }

                const items = await itemsResponse.json();

                sharePointReports = items.value.map(item => ({
                     console.log('=== ITEM CRUDO DE SHAREPOINT ===');
    console.log('ID:', item.id);
    console.log('Fields completos:', item.fields);
    console.log('SectorsCount:', item.fields.SectorsCount);
    console.log('CablesInstalled:', item.fields.CablesInstalled);
    console.log('AppurtenanceData:', item.fields.AppurtenanceData);
    
    // Si AppurtenanceData es string, intentar parsearlo
    if (item.fields.AppurtenanceData) {
        try {
            const appData = JSON.parse(item.fields.AppurtenanceData);
            console.log('AppurtenanceData parseado:', appData);
        } catch (e) {
            console.log('Error parseando AppurtenanceData');
        }
    }
    console.log('=== FIN ITEM ===');
    
    // El resto del c√≥digo de mapeo contin√∫a aqu√≠...
    return {
        key: item.fields.ReportID || `SP-${item.id}`,
        // etc...
    };
});
                    key: item.fields.ReportID || `SP-${item.id}`,
                    sharePointId: item.id,
                    sharePointETag: item.eTag,
                    data: {
                        basic: {
                            siteId: item.fields.TowerProviderSiteID || '',
                            siteName: item.fields.TowerProviderSiteName || '',
                            customerSiteId: item.fields.CustomerSiteID || '',
                            customerSiteName: item.fields.CustomerSiteName || '',
                            teamLeader: item.fields.TeamLeader || '',
                            completionDate: item.fields.CompletionDate || '',
                            radiosInstalled: item.fields.RadiosInstalled || 0,
                            antennasInstalled: item.fields.AntennasInstalled || 0,
                            cablesInstalled: item.fields.CablesInstalled || 0,
                            sectorsCount: item.fields.SectorsCount || 0,
                            towerTop: item.fields.TowerTopInstallation ? 'yes' : 'no',
                            submittedBy: item.fields.SubmittedBy || '',
                            submittedByEmail: item.fields.SubmittedByEmail || '',
                            uniqueReportId: item.fields.ReportID || ''
                        },
                        metadata: {
                            createdAt: item.fields.SubmissionTimestamp || item.createdDateTime,
                            submittedBy: item.fields.SubmittedBy || '',
                            submittedByEmail: item.fields.SubmittedByEmail || ''
                        },
                        gps: {
                            latitude: parseFloat(item.fields.Latitude) || 0,
                            longitude: parseFloat(item.fields.Longitude) || 0
                        },
                        appurtenances: tryParseJSON(item.fields.AppurtenanceData)?.appurtenances || [],
                        photos: tryParseJSON(item.fields.PhotoLinks) || {},
                        measurements: tryParseJSON(item.fields.AppurtenanceData)?.measurements || {},
                        sharePointData: {
                            reportStatus: item.fields.ReportStatus || '',
                            tenant: item.fields.TPTenant || ''
                        }
                    }
                }));

                console.log(`Encontrados ${sharePointReports.length} reportes en SharePoint`);
                showNotification(`${sharePointReports.length} reportes encontrados en SharePoint`, 'success');
                
                return sharePointReports;

            } catch (error) {
                console.error('Error searching SharePoint:', error);
                showNotification('Error al buscar en SharePoint: ' + error.message, 'error');
                return [];
            }
        }

        // Parse JSON safely
        function tryParseJSON(jsonString) {
            try {
                return jsonString ? JSON.parse(jsonString) : null;
            } catch (e) {
                console.error('Error parsing JSON:', e);
                return null;
            }
        }

        // Load reports
        async function loadReports() {
            if (searchMode === 'sharepoint') {
                allReports = await searchSharePointReports();
            } else {
                allReports = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('RPT-')) {
                        try {
                            const reportData = JSON.parse(localStorage.getItem(key));
                            allReports.push({
                                key: key,
                                data: reportData
                            });
                        } catch (e) {
                            console.error('Error loading report:', key, e);
                        }
                    }
                }
            }
            
            allReports.sort((a, b) => {
                const dateA = new Date(a.data.metadata?.createdAt || a.data.basic?.submissionTimestamp || 0);
                const dateB = new Date(b.data.metadata?.createdAt || b.data.basic?.submissionTimestamp || 0);
                return dateB - dateA;
            });
            
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            let filteredReports = [...allReports];
            
            if (currentFilter !== 'all') {
                filteredReports = filteredReports.filter(report => {
                    const data = report.data;
                    const hasPhotos = data.photos && Object.keys(data.photos).length > 0;
                    const hasGPS = data.gps && data.gps.latitude;
                    const hasEquipment = data.appurtenances && data.appurtenances.length > 0;
                    const isComplete = hasPhotos && hasGPS && hasEquipment;
                    
                    switch (currentFilter) {
                        case 'complete':
                            return isComplete;
                        case 'incomplete':
                            return !isComplete;
                        case 'pending':
                            return !data.sentToSharePoint;
                        case 'today':
                            const today = new Date().toDateString();
                            const reportDate = new Date(data.metadata?.createdAt || data.basic?.submissionTimestamp).toDateString();
                            return today === reportDate;
                        case 'week':
                            const weekAgo = new Date();
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            const reportDateWeek = new Date(data.metadata?.createdAt || data.basic?.submissionTimestamp);
                            return reportDateWeek > weekAgo;
                        default:
                            return true;
                    }
                });
            }
            
            if (searchTerm) {
                filteredReports = filteredReports.filter(report => {
                    const data = report.data;
                    const searchableText = `
                        ${report.key}
                        ${data.basic?.siteId || ''}
                        ${data.basic?.siteName || ''}
                        ${data.basic?.customerSiteName || ''}
                        ${data.basic?.teamLeader || ''}
                    `.toLowerCase();
                    
                    return searchableText.includes(searchTerm.toLowerCase());
                });
            }
            
            displayReports(filteredReports);
        }

        // Display reports
        function displayReports(reports) {
            const container = document.getElementById('reportsContainer');
            document.getElementById('resultCount').textContent = reports.length;
            
            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No se encontraron reportes</h3>
                        <p>Intenta con otros criterios de b√∫squeda o filtros</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="reports-grid">';
            
            reports.forEach(report => {
                const data = report.data;
                const basic = data.basic || {};
                const metadata = data.metadata || {};
                const createdDate = new Date(metadata.createdAt || basic.submissionTimestamp || 0);
                const completionDate = basic.completionDate || 'N/A';
                
                const hasPhotos = data.photos && Object.keys(data.photos).length > 0;
                const hasGPS = data.gps && data.gps.latitude;
                const hasEquipment = data.appurtenances && data.appurtenances.length > 0;
                const isComplete = hasPhotos && hasGPS && hasEquipment;
                
                let statusClass = 'status-incomplete';
                let statusText = 'Incompleto';
                
                if (isComplete) {
                    statusClass = 'status-complete';
                    statusText = 'Completo';
                } else if (!data.sentToSharePoint) {
                    statusClass = 'status-pending';
                    statusText = 'Pendiente';
                }
                
                let photoCount = 0;
                if (data.photos) {
                    Object.values(data.photos).forEach(photoArray => {
                        if (Array.isArray(photoArray)) {
                            photoCount += photoArray.length;
                        }
                    });
                }
                
                const cardClass = report.sharePointId ? 'report-card sharepoint' : 'report-card';
                
                html += `
                    <div class="${cardClass}">
                        <div class="report-header">
                            <div class="report-id">${basic.siteId || 'Sin ID'}</div>
                            <span class="report-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="report-details">
                            <p><strong>Site Name:</strong> ${basic.siteName || 'N/A'}</p>
                            <p><strong>Customer Site:</strong> ${basic.customerSiteName || 'N/A'}</p>
                            <p><strong>Team Leader:</strong> ${basic.teamLeader || 'N/A'}</p>
                            <p><strong>Completion Date:</strong> ${completionDate}</p>
                            <p><strong>Created:</strong> ${createdDate.toLocaleString()}</p>
                            <p><strong>Report ID:</strong> ${report.key}</p>
                        </div>
                        
                        <div class="report-stats">
                            <span class="stat-item">${data.appurtenances?.length || 0} equipos</span>
                            <span class="stat-item">${photoCount} fotos</span>
                            <span class="stat-item">${hasGPS ? '‚úì GPS' : '‚úó GPS'}</span>
                            <span class="stat-item">${basic.sectorsCount || 0} sectores</span>
                        </div>
                        
                        <div class="report-actions">
                            <button class="btn-action btn-view" onclick="viewReport('${report.key}')">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="btn-action btn-edit" onclick="editReport('${report.key}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn-action btn-duplicate" onclick="duplicateReport('${report.key}')">
                                üìã Duplicar
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteReport('${report.key}')">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Search reports
        function searchReports() {
            searchTerm = document.getElementById('searchInput').value;
            applyFilters();
        }

        // Event listener for search input
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchReports();
            }
        });

        // Set filter
        function setFilter(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            
            loadReports();
        }

        // View report
        function viewReport(reportKey) {
            const report = allReports.find(r => r.key === reportKey);
            if (!report) return;
            
            const data = report.data;
            const basic = data.basic || {};
            const metadata = data.metadata || {};
            
            let html = `
                <h3>Informaci√≥n del Sitio</h3>
                <p><strong>Site ID:</strong> ${basic.siteId || 'N/A'}</p>
                <p><strong>Site Name:</strong> ${basic.siteName || 'N/A'}</p>
                <p><strong>Customer Site ID:</strong> ${basic.customerSiteId || 'N/A'}</p>
                <p><strong>Customer Site Name:</strong> ${basic.customerSiteName || 'N/A'}</p>
                <p><strong>Team Leader:</strong> ${basic.teamLeader || 'N/A'}</p>
                <p><strong>Completion Date:</strong> ${basic.completionDate || 'N/A'}</p>
                <p><strong>Submitted By:</strong> ${metadata.submittedBy || 'N/A'}</p>
                
                <h3 style="margin-top: 20px;">GPS Location</h3>
                ${data.gps && data.gps.latitude ? 
                    `<p>Latitude: ${data.gps.latitude.toFixed(7)}, Longitude: ${data.gps.longitude.toFixed(7)}</p>
                     <p><a href="https://www.google.com/maps?q=${data.gps.latitude},${data.gps.longitude}" target="_blank">Ver en Google Maps</a></p>` : 
                    '<p>No GPS data available</p>'
                }
                
                <h3 style="margin-top: 20px;">Equipos Instalados (${data.appurtenances?.length || 0})</h3>
            `;
            
            if (data.appurtenances && data.appurtenances.length > 0) {
                html += '<ul>';
                data.appurtenances.forEach(app => {
                    html += `<li>${app.type} - ${app.manufacturer} ${app.model} (Qty: ${app.quantity})</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p>No equipment recorded</p>';
            }
            
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('previewModal').style.display = 'flex';
        }

        // Edit report
        function editReport(reportKey) {
            const report = allReports.find(r => r.key === reportKey);
            if (!report) return;
            
            if (confirm('¬øDesea editar este reporte? Ser√° redirigido a la aplicaci√≥n de reportes.')) {
                if (report.sharePointId) {
                    sessionStorage.setItem('editReportSource', 'sharepoint');
                    sessionStorage.setItem('sharePointReportId', report.sharePointId);
                }
                
                sessionStorage.setItem('editReportData', JSON.stringify(report.data));
                sessionStorage.setItem('editReportKey', reportKey);
                
                window.location.href = 'tower-report-app.html?edit=' + reportKey;
            }
        }

        // Duplicate report
        function duplicateReport(reportKey) {
            if (!confirm('¬øDesea crear una copia de este reporte?')) {
                return;
            }
            
            try {
                const report = allReports.find(r => r.key === reportKey);
                if (!report) return;
                
                const originalData = report.data;
                
                const timestamp = Date.now();
                const randomNum = Math.floor(Math.random() * 100000);
                const newReportId = `RPT-${timestamp}-${randomNum}`;
                
                originalData.metadata = {
                    ...originalData.metadata,
                    createdAt: new Date().toISOString(),
                    duplicatedFrom: reportKey
                };
                
                if (originalData.basic) {
                    originalData.basic.uniqueReportId = newReportId;
                    originalData.basic.submissionTimestamp = new Date().toISOString();
                }
                
                localStorage.setItem(newReportId, JSON.stringify(originalData));
                
                alert(`Reporte duplicado exitosamente con ID: ${newReportId}`);
                loadReports();
            } catch (error) {
                console.error('Error duplicating report:', error);
                alert('Error al duplicar el reporte');
            }
        }

        // Delete report
        function deleteReport(reportKey) {
            if (!confirm(`¬øEst√° seguro de eliminar el reporte ${reportKey}?`)) {
                return;
            }
            
            if (confirm('Esta acci√≥n no se puede deshacer. ¬øConfirmar eliminaci√≥n?')) {
                try {
                    localStorage.removeItem(reportKey);
                    alert('Reporte eliminado exitosamente');
                    loadReports();
                } catch (error) {
                    console.error('Error deleting report:', error);
                    alert('Error al eliminar el reporte');
                }
            }
        }

        // Export reports
        function exportReports() {
            const dataStr = JSON.stringify(allReports, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tower-reports-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Close modal
        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#4caf50';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#f44336';
            } else {
                notification.style.backgroundColor = '#2196f3';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            await initializeMsal();
        });
    </script>
</body>
</html>
