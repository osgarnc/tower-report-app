<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0066cc">
<meta name="author" content="Newcomm Management Services Corp.">
<meta name="copyright" content="Â© 2025 Newcomm Management Services Corp.">
<meta name="description" content="Tower Provider Report - Professional Mobile Application">
<title>Tower Report Mobile v9.31 - SharePoint Auth</title>

<!-- MSAL.js desde CDN -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background-color: #f5f5f5;
    color: #333;
    overflow-x: hidden;
}

.app-container {
    max-width: 600px;
    margin: 0 auto;
    background-color: white;
    min-height: 100vh;
    position: relative;
}

/* Login Screen */
.login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
    color: white;
}

.login-container {
    background: white;
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    max-width: 400px;
    width: 100%;
    text-align: center;
}

.login-logo {
    width: 150px;
    margin-bottom: 30px;
}

.login-title {
    color: #333;
    font-size: 24px;
    margin-bottom: 10px;
}

.login-subtitle {
    color: #666;
    font-size: 14px;
    margin-bottom: 30px;
}

.login-btn {
    background-color: #0066cc;
    color: white;
    padding: 15px 30px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
}

.login-btn:hover {
    background-color: #0052a3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,102,204,0.3);
}

.login-error {
    background-color: #ffebee;
    color: #c62828;
    padding: 10px;
    border-radius: 6px;
    margin-top: 20px;
    font-size: 14px;
}

.login-info {
    background-color: #e3f2fd;
    color: #1565c0;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 14px;
    text-align: left;
}

.user-info {
    background-color: #e3f2fd;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

.user-info strong {
    color: #1565c0;
}

.logout-btn {
    background-color: #f44336;
    color: white;
    padding: 5px 15px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
}

/* Header */
.header {
    background-color: #0066cc;
    color: white;
    padding: 15px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 20px;
    font-weight: 500;
}

.step-indicator {
    display: flex;
    justify-content: center;
    padding: 20px;
    gap: 10px;
}

.step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s;
}

.step.active {
    background-color: #0066cc;
    color: white;
}

.step.completed {
    background-color: #4caf50;
    color: white;
}

/* Form Sections */
.form-section {
    display: none;
    padding: 20px;
    animation: slideIn 0.3s ease-out;
}

.form-section.active {
    display: block;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
}

input[type="text"],
input[type="number"],
input[type="date"],
select,
textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: #0066cc;
}

.required {
    color: #f44336;
}

/* Equipment Requirements Notice */
.equipment-requirements {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 14px;
}

.equipment-requirements h4 {
    margin-bottom: 10px;
    color: #856404;
}

.equipment-requirements ul {
    margin-left: 20px;
    margin-bottom: 0;
}

.equipment-requirements li {
    margin-bottom: 5px;
}

/* Buttons */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    display: inline-block;
}

.btn-primary {
    background-color: #0066cc;
    color: white;
}

.btn-primary:hover {
    background-color: #0052a3;
}

.btn-success {
    background-color: #4caf50;
    color: white;
}

.btn-secondary {
    background-color: #757575;
    color: white;
}

.btn-danger {
    background-color: #f44336;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-block {
    width: 100%;
    display: block;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

/* GPS Status */
.gps-status {
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 14px;
}

.gps-status.success {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.gps-status.error {
    background-color: #ffebee;
    color: #c62828;
}

.gps-status.warning {
    background-color: #fff3cd;
    color: #856404;
}

/* Appurtenance List */
.appurtenance-list {
    margin-top: 20px;
}

.appurtenance-item {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.appurtenance-info h4 {
    margin: 0 0 5px 0;
    color: #0066cc;
}

.appurtenance-info p {
    margin: 0;
    font-size: 14px;
    color: #666;
}

.equipment-counter {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.equipment-counter h4 {
    color: #1565c0;
    margin-bottom: 10px;
}

.counter-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
}

.counter-item.complete {
    color: #2e7d32;
}

.counter-item.incomplete {
    color: #f44336;
}

/* Photo Section */
.photo-requirements {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.photo-requirements h3 {
    margin-bottom: 10px;
    color: #1565c0;
}

.photo-requirements ul {
    margin-left: 20px;
}

.photo-grid {
    display: grid;
    gap: 15px;
}

.photo-item {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
}

.photo-item h4 {
    margin-bottom: 10px;
    color: #333;
    font-size: 16px;
}

.photo-capture {
    position: relative;
    margin-bottom: 10px;
}

.camera-input {
    display: none;
}

.camera-btn {
    background-color: #0066cc;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 10px;
    margin-bottom: 10px;
}

.camera-btn:hover {
    background-color: #0052a3;
}

.gallery-btn {
    background-color: #4caf50;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.gallery-btn:hover {
    background-color: #388e3c;
}

.photo-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
}

.photo-preview-item {
    position: relative;
    display: inline-block;
}

.photo-preview {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.photo-delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.photo-delete-btn:hover {
    background-color: #d32f2f;
}

.photo-count {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.photo-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 5px;
}

.photo-status.complete {
    background-color: #4caf50;
    color: white;
}

.photo-status.pending {
    background-color: #ff9800;
    color: white;
}

/* Estilos para las secciones de sectores */
.sector-photo-section {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #0066cc;
}

.sector-photo-section h4 {
    color: #0066cc;
    margin-bottom: 15px;
    font-size: 18px;
}

/* Review Section */
.review-section {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.review-section h3 {
    margin-bottom: 10px;
    color: #0066cc;
}

.review-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #e0e0e0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-label {
    font-weight: 500;
    color: #666;
}

.review-value {
    color: #333;
}

/* Loading Spinner */
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #0066cc;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Notifications */
.notification {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translate(-50%, -20px);
    }
    to {
        opacity: 1;
        transform: translate(-50%, 0);
    }
}

.notification.success {
    background-color: #4caf50;
}

.notification.error {
    background-color: #f44336;
}

.notification.info {
    background-color: #2196f3;
}

/* Copyright Footer */
.copyright-footer {
    text-align: center;
    padding: 20px;
    font-size: 12px;
    color: #999;
    border-top: 1px solid #eee;
    margin-top: 40px;
}

/* Dynamic Sectors Styles */
.sectors-info {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.sectors-info h4 {
    color: #1565c0;
    margin-bottom: 10px;
}

.sector-tape-inputs {
    display: grid;
    gap: 10px;
    margin-top: 10px;
}

/* Responsive */
@media (max-width: 480px) {
    .header h1 {
        font-size: 18px;
    }
    
    .btn {
        font-size: 14px;
        padding: 10px 20px;
    }
    
    .photo-preview {
        width: 60px;
        height: 60px;
    }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-container">
        <h2 class="login-title">Tower Provider Report</h2>
        <p class="login-subtitle">Inicie sesiÃ³n con su cuenta de Microsoft 365</p>
        
        <button class="login-btn" onclick="signIn()">
            <svg width="20" height="20" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
                <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
                <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
            </svg>
            Iniciar sesiÃ³n con Microsoft
        </button>
        
        <div id="loginError" style="display: none;" class="login-error"></div>
        
        <div style="margin-top: 20px; font-size: 12px; color: #666;">
            <p>VersiÃ³n 9.31 - Submit Fixed</p>
        </div>
    </div>
</div>

<!-- Main App (Hidden until authenticated) -->
<div id="mainApp" class="app-container" style="display: none;">
    <div class="user-info">
        <span>Usuario: <strong id="userDisplayName">-</strong></span>
        <button class="logout-btn" onclick="signOut()">Cerrar SesiÃ³n</button>
    </div>
    
    <header class="header">
        <h1>Tower Provider Report</h1>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">VersiÃ³n 9.31 - Submit Fixed</div>
    </header>
    
    <div class="step-indicator">
        <div class="step active" id="step1">1</div>
        <div class="step" id="step2">2</div>
        <div class="step" id="step3">3</div>
        <div class="step" id="step4">4</div>
        <div class="step" id="step5">5</div>
    </div>
    
    <!-- Step 1: Basic Information -->
    <div class="form-section active" id="section1">
        <h2>InformaciÃ³n BÃ¡sica</h2>
        
        <!-- Storage management -->
        <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Espacio usado: <span id="storageIndicator">calculando...</span></span>
                <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 5px 10px;">
                    Limpiar datos
                </button>
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">App v9.31 - Submit Fixed</div>
        </div>
        
        <div class="form-group">
            <label>Tower Provider Site ID <span class="required">*</span></label>
            <input type="text" id="siteId" placeholder="ej: 10028307" required>
        </div>
        
        <div class="form-group">
            <label>Tower Provider Site Name <span class="required">*</span></label>
            <input type="text" id="siteName" placeholder="ej: Vega Baja DT" required>
        </div>
        
        <div class="form-group">
            <label>Customer Site ID <span class="required">*</span></label>
            <input type="text" id="customerSiteId" placeholder="ej: 10028307" required>
        </div>
        
        <div class="form-group">
            <label>Customer Site Name <span class="required">*</span></label>
            <input type="text" id="customerSiteName" placeholder="ej: Vega Baja DT" required>
        </div>
        
        <!-- Nueva secciÃ³n para cantidad de sectores -->
        <div class="form-group" style="background: #e3f2fd; padding: 15px; border-radius: 6px;">
            <label>Number of Sectors <span class="required">*</span></label>
            <select id="sectorsCount" required onchange="updateSectorRequirements()">
                <option value="">Seleccione cantidad de sectores</option>
                <option value="1">1 Sector</option>
                <option value="2">2 Sectores</option>
                <option value="3">3 Sectores</option>
                <option value="4">4 Sectores</option>
                <option value="5">5 Sectores</option>
                <option value="6">6 Sectores</option>
            </select>
            <p style="font-size: 12px; color: #1565c0; margin-top: 10px;">
                La cantidad de sectores determinarÃ¡ las mediciones de tape drop y fotos requeridas
            </p>
        </div>
        
        <div class="form-group">
            <label>Radios Installed <span class="required">*</span></label>
            <input type="number" id="radiosInstalled" min="0" placeholder="3" required onchange="updateEquipmentRequirements()">
        </div>
        
        <div class="form-group">
            <label>Antennas Installed <span class="required">*</span></label>
            <input type="number" id="antennasInstalled" min="0" placeholder="6" required onchange="updateEquipmentRequirements()">
        </div>
        
        <div class="form-group">
            <label>Cables Installed <span class="required">*</span></label>
            <input type="number" id="cablesInstalled" min="0" placeholder="12" required onchange="updateEquipmentRequirements()">
        </div>
        
        <div class="form-group">
            <label>Team Leader <span class="required">*</span></label>
            <input type="text" id="teamLeader" placeholder="ej: Christopher Rodriguez" required>
        </div>
        
        <div class="form-group">
            <label>Tower Top Installation <span class="required">*</span></label>
            <select id="towerTop" required onchange="updateMeasurementRequirements()">
                <option value="">Seleccione una opciÃ³n</option>
                <option value="yes">Yes - At Tower Top</option>
                <option value="near-top">Near Top (Within 10' of top)</option>
                <option value="no">No - Below 10' from top</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Completion Date <span class="required">*</span></label>
            <input type="date" id="completionDate" required>
        </div>
        
        <!-- GPS Section - Now Required -->
        <div style="background: #ffebee; padding: 15px; border-radius: 6px; margin-top: 20px; margin-bottom: 20px;">
            <h3 style="color: #c62828; margin-bottom: 10px;">ð UbicaciÃ³n GPS (OBLIGATORIO)</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                La ubicaciÃ³n GPS es <strong>obligatoria</strong> para continuar. Si el GPS automÃ¡tico falla, debe ingresar las coordenadas manualmente.
            </p>
            <button class="btn btn-success btn-block" onclick="getGPSLocation()">
                ð Obtener UbicaciÃ³n GPS
            </button>
            <div id="gpsStatus"></div>
        </div>
        
        <!-- SecciÃ³n de mediciones actualizada - AHORA OBLIGATORIA y DINÃMICA -->
        <div style="background: #ffebee; padding: 15px; border-radius: 6px; margin-top: 20px;">
            <h3 style="color: #c62828; margin-bottom: 15px;">ð Mediciones de Torre (OBLIGATORIO)</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                <strong>Tape Drop de Sectores:</strong> Siempre obligatorio para todos los sectores.<br>
                <strong>Tower Height y Tallest Point:</strong> <span id="heightRequirementText">Seleccione "Tower Top Installation" para ver requisitos</span>
            </p>
            
            <div class="form-group">
                <label>Tower Height (ft) <span id="towerHeightRequired" style="display: none;" class="required">*</span></label>
                <input type="text" id="towerHeight" placeholder="ej: 38.220">
            </div>
            
            <!-- Tape drop dinÃ¡mico segÃºn cantidad de sectores -->
            <div id="sectorTapeDrops" class="sector-tape-inputs">
                <p style="text-align: center; color: #666;">Seleccione la cantidad de sectores para ver los campos de tape drop</p>
            </div>
            
            <div class="form-group">
                <label>Tallest Point Measurement (ft) <span id="tallestPointRequired" style="display: none;" class="required">*</span></label>
                <input type="text" id="tallestPoint" placeholder="ej: 15.570">
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="nextStep()" style="margin-left: auto;">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 2: Appurtenance Information -->
    <div class="form-section" id="section2">
        <h2>InformaciÃ³n de Equipos</h2>
        
        <!-- Equipment Requirements Alert -->
        <div class="equipment-requirements" id="equipmentRequirements" style="display: none;">
            <h4>â ï¸ Requisitos de Equipos</h4>
            <ul id="requirementsList"></ul>
        </div>
        
        <!-- Equipment Counter -->
        <div class="equipment-counter">
            <h4>Contador de Equipos</h4>
            <div id="equipmentCounter"></div>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="showAppurtenanceForm()">
            + Agregar Equipo
        </button>
        
        <div id="appurtenanceForm" style="display: none; margin-top: 20px;">
            <div class="form-group">
                <label>Type</label>
                <select id="appType">
                    <option value="Antenna">Antenna</option>
                    <option value="Radio">Radio</option>
                    <option value="Cable">Cable</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Rad Center</label>
                <input type="text" id="appRadCenter" placeholder="50">
            </div>
            
            <div class="form-group">
                <label>Manufacturer</label>
                <input type="text" id="appManufacturer" placeholder="ej: Ericsson">
            </div>
            
            <div class="form-group">
                <label>Model</label>
                <input type="text" id="appModel" placeholder="ej: 840590003">
            </div>
            
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="appQuantity" min="1" value="1">
            </div>
            
            <div class="form-group">
                <label>Coax Size</label>
                <select id="appCoaxSize">
                    <option value="N/A">N/A</option>
                    <option value="7/8">7/8</option>
                    <option value="1 5/8">1 5/8</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="addAppurtenance()">Guardar</button>
            <button class="btn btn-secondary" onclick="cancelAppurtenance()">Cancelar</button>
        </div>
        
        <div class="appurtenance-list" id="appurtenanceList"></div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
            <button class="btn btn-primary" onclick="nextStep()">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 3: Photo Documentation -->
    <div class="form-section" id="section3">
        <h2>DocumentaciÃ³n FotogrÃ¡fica</h2>
        
        <div class="photo-requirements">
            <h3>ð· Fotos Requeridas</h3>
            <ul>
                <li>Las fotos se organizan por categorÃ­as y sectores</li>
                <li>Cada sector tiene su propia secciÃ³n de fotos</li>
                <li>Puede tomar fotos con la cÃ¡mara o seleccionar desde la galerÃ­a</li>
                <li>Puede eliminar fotos individuales si se equivoca</li>
                <li>Las fotos se guardan automÃ¡ticamente</li>
            </ul>
        </div>
        
        <div class="photo-grid" id="photoGrid">
            <!-- Photo items will be generated by JavaScript dynamically -->
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
            <button class="btn btn-primary" onclick="nextStep()">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 4: Review -->
    <div class="form-section" id="section4">
        <h2>Revisar InformaciÃ³n</h2>
        
        <div class="review-section">
            <h3>InformaciÃ³n del Sitio</h3>
            <div id="siteReview"></div>
        </div>
        
        <div class="review-section">
            <h3>Equipos Instalados</h3>
            <div id="equipmentReview"></div>
        </div>
        
        <div class="review-section">
            <h3>Mediciones Obligatorias</h3>
            <div id="measurementsReview"></div>
        </div>
        
        <div class="review-section">
            <h3>DocumentaciÃ³n FotogrÃ¡fica</h3>
            <div id="photoReview"></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
            <button class="btn btn-primary" onclick="nextStep()">
                Siguiente â
            </button>
        </div>
    </div>
    
    <!-- Step 5: Submit -->
    <div class="form-section" id="section5">
        <h2>Enviar Reporte</h2>
        
        <div style="text-align: center; padding: 40px 20px;">
            <h3>Â¿EstÃ¡ listo para enviar el reporte?</h3>
            <p style="margin: 20px 0; color: #666;">
                Al enviar, se generarÃ¡ un reporte y se enviarÃ¡ automÃ¡ticamente a accounting@newcomm2000.com
            </p>
            
            <button class="btn btn-primary btn-block" onclick="showReportSummary()" style="margin-bottom: 10px; font-size: 16px;">
                ð Ver Resumen del Reporte
            </button>
            
            <button class="btn btn-success btn-block" onclick="submitReport()" style="font-size: 18px; padding: 15px;">
                â Enviar Reporte
            </button>
            
            <div id="submitStatus" style="margin-top: 20px;"></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="previousStep()">
                â Anterior
            </button>
        </div>
    </div>
    
    <!-- Copyright Footer -->
    <div class="copyright-footer">
        Â© 2025 Newcomm Management Services Corp. â¢ All rights reserved â¢ v9.31
    </div>
</div>

<script>
// MSAL Configuration - Optimizado para mÃ³viles
const msalConfig = {
    auth: {
        clientId: '928a4b98-5894-4a97-b8b1-d8c489c22216',
        authority: 'https://login.microsoftonline.com/93a307af-2b18-419b-82a4-da0d26ae31d0',
        redirectUri: window.location.origin + window.location.pathname,
        navigateToLoginRequestUrl: false // Importante para mÃ³viles
    },
    cache: {
        cacheLocation: 'localStorage', // Cambiado a localStorage para persistencia
        storeAuthStateInCookie: true // Habilitado para mejor compatibilidad mÃ³vil
    },
    system: {
        loggerOptions: {
            loggerCallback: (level, message, containsPii) => {
                if (containsPii) return;
                console.log(message);
            },
            logLevel: msal.LogLevel.Warning
        }
    }
};

// Create MSAL instance
const msalInstance = new msal.PublicClientApplication(msalConfig);

// Login request configuration
const loginRequest = {
    scopes: ['User.Read'],
    prompt: 'select_account' // Fuerza selecciÃ³n de cuenta en mÃ³viles
};

// Global variables
let currentAccount = null;
let currentStep = 1;
let reportData = {
    basic: {},
    gps: {},
    appurtenances: [],
    photos: {},
    measurements: {},
    metadata: {
        appVersion: '9.31',
        deviceInfo: navigator.userAgent,
        createdAt: new Date().toISOString()
    }
};

// Base photo types configuration (serÃ¡ modificado dinÃ¡micamente)
let photoTypes = [];

// Function to update photo types based on sectors, antennas, and radios
function updatePhotoTypes() {
    const sectorsCount = parseInt(document.getElementById('sectorsCount').value) || 0;
    const antennasCount = parseInt(document.getElementById('antennasInstalled').value) || 0;
    const radiosCount = parseInt(document.getElementById('radiosInstalled').value) || 0;
    
    // Reset photo types
    photoTypes = [
        {
            id: 'equipment_room',
            name: 'Post Equipment Room or Pad',
            required: 4, // Siempre 4 fotos como solicitaste
            description: 'Equipment room/pad photos (4 photos required)'
        },
        {
            id: 'cabinet_doors',
            name: 'Cabinet or Shelter Doors',
            required: 2,
            description: 'Open and closed door photos'
        },
        {
            id: 'safety_lines',
            name: 'Safety Lines',
            required: 4,
            description: 'All safety line assemblies'
        }
    ];
    
    // Antenna labels based on antenna count
    if (antennasCount > 0) {
        photoTypes.push({
            id: 'antenna_labels',
            name: 'Antenna Labels',
            required: antennasCount, // DinÃ¡mico segÃºn cantidad de antenas
            description: `Labels for all ${antennasCount} antennas`
        });
    }
    
    // Radio labels based on radio count
    if (radiosCount > 0) {
        photoTypes.push({
            id: 'radio_labels',
            name: 'Radio Labels',
            required: radiosCount, // DinÃ¡mico segÃºn cantidad de radios
            description: `Labels for all ${radiosCount} radios`
        });
    }
    
    // Compound post pictures - 1 per sector from ground
    if (sectorsCount > 0) {
        photoTypes.push({
            id: 'compound_post',
            name: 'Compound Post Pictures',
            required: 4, // siempre 4 fotos
            description: `4 compound post photos (always required)`
        });
    }
    
    // Sectors from ground
    if (sectorsCount > 0) {
        photoTypes.push({
            id: 'sectors_ground',
            name: 'Sectors from Ground',
            required: sectorsCount, // DinÃ¡mico segÃºn cantidad de sectores
            description: `All ${sectorsCount} sectors`
        });
    }
    
    // Crear categorÃ­as individuales para cada sector - Post Pictures
    for (let i = 1; i <= sectorsCount; i++) {
        photoTypes.push({
            id: `sector_${i}_general_view`,
            name: `Sector ${i} - General View from Behind`,
            required: 1,
            description: `General view from behind of Sector ${i}`,
            sectorGroup: true,
            sectorNumber: i,
            photoType: 'general_view'
        });
        photoTypes.push({
            id: `sector_${i}_cables_back`,
            name: `Sector ${i} - Cables Going Back`,
            required: 1,
            description: `Cables going back for Sector ${i}`,
            sectorGroup: true,
            sectorNumber: i,
            photoType: 'cables_back'
        });
        photoTypes.push({
            id: `sector_${i}_sector_view`,
            name: `Sector ${i} - Sector View`,
            required: 1,
            description: `Sector view for Sector ${i}`,
            sectorGroup: true,
            sectorNumber: i,
            photoType: 'sector_view'
        });
    }
    
    // Crear categorÃ­as individuales para tape drop por sector
    for (let i = 1; i <= sectorsCount; i++) {
        photoTypes.push({
            id: `sector_${i}_tapedrop`,
            name: `Sector ${i} - Tape Drop Measurements`,
            required: 2,
            description: `Tape drop measurement photos for Sector ${i} (2 photos required)`,
            tapeDropGroup: true,
            sectorNumber: i
        });
    }
    
    // Tower measurements
    photoTypes.push({
        id: 'tower_measurements',
        name: 'Tower Height Measurements',
        required: 2,
        description: 'Tower and tallest point'
    });
    
    // Beacon photos
    photoTypes.push({
        id: 'beacon',
        name: 'Beacon Photos',
        required: 2,
        description: 'Beacon and label'
    });
    
    // Regenerate photo grid if we're on step 3
    if (currentStep === 3) {
        generatePhotoGrid();
    }
}

// FunciÃ³n para mapear fotos dinÃ¡micamente segÃºn sectores - NUEVA FUNCIONALIDAD v8.0
function mapPhotosForSharePoint(reportData) {
    const sectorsCount = parseInt(reportData.basic.sectorsCount) || 0;
    
    // Helper function para obtener foto por Ã­ndice
    function getPhotoByIndex(category, index) {
        const photos = reportData.photos[category] || [];
        return photos[index] ? photos[index].data : 'N/A';
    }
    
    function getPhotoTimestamp(category, index) {
        const photos = reportData.photos[category] || [];
        return photos[index] ? photos[index].timestamp : '';
    }
    
    // Mapeo base de fotos (no dependen de sectores)
    const photoMapping = {
        // Antenna photos - dinÃ¡mico segÃºn cantidad instalada
        antenna1Photo: getPhotoByIndex('antenna_labels', 0),
        antenna2Photo: getPhotoByIndex('antenna_labels', 1),
        antenna3Photo: getPhotoByIndex('antenna_labels', 2),
        antenna4Photo: getPhotoByIndex('antenna_labels', 3),
        antenna5Photo: getPhotoByIndex('antenna_labels', 4),
        antenna6Photo: getPhotoByIndex('antenna_labels', 5),
        
        // Radio photos - dinÃ¡mico segÃºn cantidad instalada
        radio1Photo: getPhotoByIndex('radio_labels', 0),
        radio2Photo: getPhotoByIndex('radio_labels', 1),
        radio3Photo: getPhotoByIndex('radio_labels', 2),
        
        // Post equipment room photos (siempre 4 requeridas)
        postPhoto1: getPhotoByIndex('equipment_room', 0),
        postPhoto2: getPhotoByIndex('equipment_room', 1),
        postPhoto3: getPhotoByIndex('equipment_room', 2),
        postPhoto4: getPhotoByIndex('equipment_room', 3),
        
        // Timestamps para post photos
        postPhoto1Timestamp: getPhotoTimestamp('equipment_room', 0),
        postPhoto2Timestamp: getPhotoTimestamp('equipment_room', 1),
        postPhoto3Timestamp: getPhotoTimestamp('equipment_room', 2),
        postPhoto4Timestamp: getPhotoTimestamp('equipment_room', 3),
        
        // Cabinet photos (siempre 2)
        cabinetOpenPhoto: getPhotoByIndex('cabinet_doors', 0),
        cabinetClosePhoto: getPhotoByIndex('cabinet_doors', 1),
        cabinetOpenTimestamp: getPhotoTimestamp('cabinet_doors', 0),
        cabinetCloseTimestamp: getPhotoTimestamp('cabinet_doors', 1),
        
        // Safety line photos (siempre 4)
        safetyTopPhoto: getPhotoByIndex('safety_lines', 0),
        safetySectorPhoto: getPhotoByIndex('safety_lines', 1),
        safetyUpPhoto: getPhotoByIndex('safety_lines', 2),
        safetyBottomPhoto: getPhotoByIndex('safety_lines', 3),
        safetyTopTimestamp: getPhotoTimestamp('safety_lines', 0),
        safetySectorTimestamp: getPhotoTimestamp('safety_lines', 1),
        safetyUpTimestamp: getPhotoTimestamp('safety_lines', 2),
        safetyBottomTimestamp: getPhotoTimestamp('safety_lines', 3),
        
        // Compound post pictures (dinÃ¡mico segÃºn sectores)
        compoundPhoto1: getPhotoByIndex('compound_post', 0),
        compoundPhoto2: getPhotoByIndex('compound_post', 1),
        compoundPhoto1Timestamp: getPhotoTimestamp('compound_post', 0),
        compoundPhoto2Timestamp: getPhotoTimestamp('compound_post', 1),
        
        // Tower measurements (siempre 2)
        towerTapeDropPhoto: getPhotoByIndex('tower_measurements', 0),
        tallestPointPhoto: getPhotoByIndex('tower_measurements', 1),
        
        // Beacon photos (siempre 2)
        beaconPhoto: getPhotoByIndex('beacon', 0),
        beaconLabelPhoto: getPhotoByIndex('beacon', 1)
    };
    
    // Agregar fotos de sectores desde el suelo (dinÃ¡mico)
    for (let i = 1; i <= Math.max(sectorsCount, 6); i++) {
        photoMapping[`sector${i}GroundPhoto`] = getPhotoByIndex('sectors_ground', i - 1);
    }
    
    // Agregar fotos especÃ­ficas por sector (dinÃ¡mico)
    for (let i = 1; i <= sectorsCount; i++) {
        // General view from behind
        photoMapping[`sector${i}GeneralViewPhoto`] = getPhotoByIndex(`sector_${i}_general_view`, 0);
        
        // Cables going back
        photoMapping[`sector${i}CablesBackPhoto`] = getPhotoByIndex(`sector_${i}_cables_back`, 0);
        
        // Sector view
        photoMapping[`sector${i}SectorViewPhoto`] = getPhotoByIndex(`sector_${i}_sector_view`, 0);
        
        // Tape drop photos (2 por sector)
        photoMapping[`sector${i}TapeDropPhoto1`] = getPhotoByIndex(`sector_${i}_tapedrop`, 0);
        photoMapping[`sector${i}TapeDropPhoto2`] = getPhotoByIndex(`sector_${i}_tapedrop`, 1);
        
        // Timestamps para tape drop
        photoMapping[`sector${i}TapeDropPhoto1Timestamp`] = getPhotoTimestamp(`sector_${i}_tapedrop`, 0);
        photoMapping[`sector${i}TapeDropPhoto2Timestamp`] = getPhotoTimestamp(`sector_${i}_tapedrop`, 1);
    }
    
    return photoMapping;
}

// Update sector requirements when sector count changes
function updateSectorRequirements() {
    const sectorsCount = parseInt(document.getElementById('sectorsCount').value) || 0;
    const sectorTapeDropsDiv = document.getElementById('sectorTapeDrops');
    
    
    // Clear existing inputs
    sectorTapeDropsDiv.innerHTML = '';
    
    
    if (sectorsCount > 0) {
        const gridStyle = sectorsCount <= 3 ? `grid-template-columns: repeat(${sectorsCount}, 1fr)` : 'grid-template-columns: repeat(3, 1fr)';
        sectorTapeDropsDiv.style.display = 'grid';
        sectorTapeDropsDiv.style.gridTemplateColumns = sectorsCount <= 3 ? `repeat(${sectorsCount}, 1fr)` : 'repeat(3, 1fr)';
        sectorTapeDropsDiv.style.gap = '10px';
        
        for (let i = 1; i <= sectorsCount; i++) {
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>Sector ${i} Tape Drop <span class="required">*</span></label>
                <input type="text" id="sector${i}TapeDrop" placeholder="ej: ${15 + Math.random() * 2}0 ft" required>
            `;
            sectorTapeDropsDiv.appendChild(div);
        }
    } else {
        sectorTapeDropsDiv.innerHTML = '<p style="text-align: center; color: #666;">Seleccione la cantidad de sectores para ver los campos de tape drop</p>';
    }
    
    // Update photo types when sector count changes
    updatePhotoTypes();
}

// Initialize MSAL - Mejorado para mÃ³viles
async function initializeMsal() {
    try {
        // Esperar a que MSAL estÃ© completamente inicializado
        await msalInstance.initialize();
        
        // Reemplazar la funciÃ³n loadReportForEdit en tower-report-app.html con esta versiÃ³n actualizada
        
        // Reemplazar la funciÃ³n loadReportForEdit con esta versiÃ³n mejorada
        
        function loadReportForEdit(reportKey) {
            try {
                console.log('Loading report for edit:', reportKey);
                let reportToLoad = null;
                
                // Primero intentar cargar desde sessionStorage (SharePoint)
                const editReportData = sessionStorage.getItem('editReportData');
                if (editReportData) {
                    console.log('Loading from sessionStorage (SharePoint)');
                    reportToLoad = JSON.parse(editReportData);
                } else {
                    // Si no estÃ¡ en sessionStorage, buscar en localStorage
                    console.log('Loading from localStorage');
                    const savedReport = localStorage.getItem(reportKey);
                    if (savedReport) {
                        reportToLoad = JSON.parse(savedReport);
                    }
                }
                
                if (!reportToLoad) {
                    showNotification('No se encontrÃ³ el reporte para editar', 'error');
                    console.error('Report not found:', reportKey);
                    return;
                }
                
                console.log('Raw report data:', reportToLoad);
                
                // Normalizar la estructura de datos para manejar tanto formato local como SharePoint
                reportData = {
                    basic: {},
                    gps: {},
                    appurtenances: [],
                    photos: {},
                    measurements: {},
                    metadata: {
                        appVersion: '9.31',
                        deviceInfo: navigator.userAgent,
                        createdAt: new Date().toISOString()
                    }
                };
                
                // Mapear datos bÃ¡sicos - manejar ambos formatos
                if (reportToLoad.basic) {
                    // Formato local
                    reportData.basic = reportToLoad.basic;
                } else {
                    // Formato SharePoint - mapear campos individuales
                    reportData.basic = {
                        siteId: reportToLoad.TowerProviderSiteID || reportToLoad.siteId || '',
                        siteName: reportToLoad.TowerProviderSiteName || reportToLoad.siteName || '',
                        customerSiteId: reportToLoad.CustomerSiteID || reportToLoad.customerSiteId || '',
                        customerSiteName: reportToLoad.CustomerSiteName || reportToLoad.customerSiteName || '',
                        sectorsCount: reportToLoad.SectorsCount || reportToLoad.sectorsCount || '',
                        radiosInstalled: reportToLoad.RadiosInstalled || reportToLoad.radiosInstalled || '',
                        antennasInstalled: reportToLoad.AntennasInstalled || reportToLoad.antennasInstalled || '',
                        cablesInstalled: reportToLoad.CablesInstalled || reportToLoad.cablesInstalled || '',
                        teamLeader: reportToLoad.TeamLeader || reportToLoad.teamLeader || '',
                        towerTop: reportToLoad.towerTop || (reportToLoad.TowerTopInstallation ? 'yes' : 'no') || 'no',
                        completionDate: reportToLoad.CompletionDate || reportToLoad.completionDate || '',
                        submittedBy: reportToLoad.SubmittedBy || reportToLoad.submittedBy || currentAccount?.name || '',
                        submittedByEmail: reportToLoad.SubmittedByEmail || reportToLoad.submittedByEmail || currentAccount?.username || ''
                    };
                }
                
                // Mapear GPS
                if (reportToLoad.gps) {
                    reportData.gps = reportToLoad.gps;
                } else {
                    reportData.gps = {
                        latitude: parseFloat(reportToLoad.Latitude || reportToLoad.latitude) || 0,
                        longitude: parseFloat(reportToLoad.Longitude || reportToLoad.longitude) || 0,
                        altitude: 0,
                        accuracy: 0,
                        manual: false
                    };
                }
                
                // Mapear appurtenances
                if (reportToLoad.appurtenances) {
                    reportData.appurtenances = reportToLoad.appurtenances;
                } else if (reportToLoad.AppurtenanceData) {
                    // Si viene de SharePoint, puede estar en formato JSON string
                    try {
                        const appData = typeof reportToLoad.AppurtenanceData === 'string'
                            ? JSON.parse(reportToLoad.AppurtenanceData)
                            : reportToLoad.AppurtenanceData;
                        reportData.appurtenances = appData.appurtenances || [];
                        reportData.measurements = appData.measurements || {};
                    } catch (e) {
                        console.error('Error parsing AppurtenanceData:', e);
                    }
                }
                
                // Mapear measurements
                if (reportToLoad.measurements) {
                    reportData.measurements = reportToLoad.measurements;
                }
                
                // Mapear photos
                if (reportToLoad.photos) {
                    reportData.photos = reportToLoad.photos;
                } else if (reportToLoad.PhotoLinks) {
                    try {
                        reportData.photos = typeof reportToLoad.PhotoLinks === 'string'
                            ? JSON.parse(reportToLoad.PhotoLinks)
                            : reportToLoad.PhotoLinks;
                    } catch (e) {
                        console.error('Error parsing PhotoLinks:', e);
                    }
                }
                
                // Mapear metadata
                if (reportToLoad.metadata) {
                    reportData.metadata = { ...reportData.metadata, ...reportToLoad.metadata };
                }
                
                console.log('Normalized report data:', reportData);
                
                // Ahora rellenar los campos del formulario
                if (reportData.basic) {
                    // Lista de campos y sus IDs
                    const fieldMappings = [
                        { id: 'siteId', value: reportData.basic.siteId },
                        { id: 'siteName', value: reportData.basic.siteName },
                        { id: 'customerSiteId', value: reportData.basic.customerSiteId },
                        { id: 'customerSiteName', value: reportData.basic.customerSiteName },
                        { id: 'sectorsCount', value: reportData.basic.sectorsCount },
                        { id: 'radiosInstalled', value: reportData.basic.radiosInstalled },
                        { id: 'antennasInstalled', value: reportData.basic.antennasInstalled },
                        { id: 'cablesInstalled', value: reportData.basic.cablesInstalled },
                        { id: 'teamLeader', value: reportData.basic.teamLeader },
                        { id: 'towerTop', value: reportData.basic.towerTop },
                        { id: 'completionDate', value: reportData.basic.completionDate }
                    ];
                    
                    // Asignar valores a cada campo
                    fieldMappings.forEach(({ id, value }) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value || '';
                            console.log(`Set ${id} to:`, value);
                        } else {
                            console.warn(`Element not found: ${id}`);
                        }
                    });
                    
                    // Esperar un momento y luego actualizar los elementos dinÃ¡micos
                    setTimeout(() => {
                        // Actualizar requisitos basados en los valores cargados
                        if (reportData.basic.sectorsCount) {
                            updateSectorRequirements();
                            
                            // DespuÃ©s de crear los campos dinÃ¡micos, cargar los tape drops
                            setTimeout(() => {
                                const sectorsCount = parseInt(reportData.basic.sectorsCount) || 0;
                                for (let i = 1; i <= sectorsCount; i++) {
                                    const tapeDrop = document.getElementById(`sector${i}TapeDrop`);
                                    if (tapeDrop && reportData.measurements[`sector${i}TapeDrop`]) {
                                        tapeDrop.value = reportData.measurements[`sector${i}TapeDrop`];
                                        console.log(`Set sector${i}TapeDrop to:`, reportData.measurements[`sector${i}TapeDrop`]);
                                    }
                                }
                            }, 300);
                        }
                        
                        if (reportData.basic.towerTop) {
                            updateMeasurementRequirements();
                            
                            // Cargar mediciones de torre
                            setTimeout(() => {
                                if (reportData.measurements.towerHeight) {
                                    const towerHeight = document.getElementById('towerHeight');
                                    if (towerHeight) {
                                        towerHeight.value = reportData.measurements.towerHeight;
                                        console.log('Set towerHeight to:', reportData.measurements.towerHeight);
                                    }
                                }
                                
                                if (reportData.measurements.tallestPoint) {
                                    const tallestPoint = document.getElementById('tallestPoint');
                                    if (tallestPoint) {
                                        tallestPoint.value = reportData.measurements.tallestPoint;
                                        console.log('Set tallestPoint to:', reportData.measurements.tallestPoint);
                                    }
                                }
                            }, 300);
                        }
                        
                        updateEquipmentRequirements();
                        updateEquipmentCounter();
                    }, 200);
                }
                
                // Cargar GPS
                if (reportData.gps && reportData.gps.latitude) {
                    showGPSStatus(true);
                }
                
                // Actualizar lista de equipos
                if (reportData.appurtenances && reportData.appurtenances.length > 0) {
                    updateAppurtenanceList();
                }
                
                // Cargar fotos si existen
                if (reportData.photos && Object.keys(reportData.photos).length > 0) {
                    console.log('Loading photos:', Object.keys(reportData.photos));
                    updatePhotoTypes();
                    updatePhotoCounts();
                    
                    // Si estamos en el paso 3, regenerar la grilla
                    if (currentStep === 3) {
                        generatePhotoGrid();
                        setTimeout(() => {
                            Object.keys(reportData.photos).forEach(typeId => {
                                if (reportData.photos[typeId] && reportData.photos[typeId].length > 0) {
                                    updatePhotoPreview(typeId);
                                }
                            });
                        }, 500);
                    }
                }
                
                // Marcar si es un reporte de SharePoint
                const editSource = sessionStorage.getItem('editReportSource');
                if (editSource === 'sharepoint') {
                    reportData.isSharePointReport = true;
                    reportData.sharePointId = sessionStorage.getItem('sharePointReportId');
                    console.log('SharePoint report marked for update');
                }
                
                // Actualizar el tÃ­tulo
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) {
                    headerTitle.textContent = 'Tower Provider Report - EDITANDO';
                }
                
                showNotification(`Reporte ${reportKey} cargado para ediciÃ³n`, 'success');
                
                // Limpiar sessionStorage despuÃ©s de usar
                sessionStorage.removeItem('editReportData');
                
                // Guardar datos actualizados
                saveCurrentStep();
                
            } catch (error) {
                console.error('Error loading report for edit:', error);
                showNotification('Error al cargar el reporte: ' + error.message, 'error');
            }
        }
        
        // TambiÃ©n agregar esta funciÃ³n para debug
        function debugReportData() {
            console.log('Current reportData:', reportData);
            console.log('Basic:', reportData.basic);
            console.log('Measurements:', reportData.measurements);
            console.log('GPS:', reportData.gps);
            console.log('Photos:', reportData.photos);
            console.log('Appurtenances:', reportData.appurtenances);
        }
        // Modificar la funciÃ³n showMainApp para detectar modo ediciÃ³n
        function showMainApp() {
            console.log('Showing main app for user:', currentAccount?.name);
            
            if (!currentAccount) {
                console.error('No current account found');
                location.reload();
                return;
            }
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            if (window.history && window.history.pushState) {
                window.history.pushState(null, null, window.location.href);
                window.onpopstate = function () {
                    window.history.pushState(null, null, window.location.href);
                };
            }
            
            // Initialize app
            document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
            
            // Verificar si venimos del modo ediciÃ³n
            const urlParams = new URLSearchParams(window.location.search);
            const editReportKey = urlParams.get('edit');
            const sessionEditKey = sessionStorage.getItem('editReportKey');
            
            if (editReportKey || sessionEditKey) {
                // Modo ediciÃ³n
                const reportKeyToEdit = editReportKey || sessionEditKey;
                
                // Cargar el reporte para ediciÃ³n despuÃ©s de un pequeÃ±o delay
                setTimeout(() => {
                    loadReportForEdit(reportKeyToEdit);
                }, 500);
            } else {
                // Modo nuevo reporte - cargar datos guardados si existen
                loadSavedData();
            }
            
            updateStorageIndicator();
            optimizeStorage();
            
            sessionStorage.setItem('appState', 'mainApp');
        }
        // FunciÃ³n adicional para regenerar la vista de fotos cuando se navega al paso 3
        const originalShowStep = showStep;
        showStep = function(step) {
            //
